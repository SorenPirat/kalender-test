<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Min profil â€“ NKL</title>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="calendar.css" />
</head>

<body>
  <div class="container">
    <h1>ğŸ‘¤<span id="bruger-navn">â€“</span></h1>

    <div id="mine-trÃ¥de" class="tool-card">
<h2>ğŸ“¬ Dine beskedtrÃ¥de</h2>

<div id="trÃ¥d-tabs" style="margin-bottom: 1rem;">
  <button onclick="skiftVisning('aktive')" id="faneknap-aktive" class="aktiv-fane">ğŸ“‚ Aktive</button>
  <button onclick="skiftVisning('lukkede')" id="faneknap-lukkede">ğŸ“ Arkiverede</button>
</div>

<div id="trÃ¥de-liste"></div>

  </div>



<script type="module">
  import { adgangskontrol, indsÃ¦tMenu, client } from './auth.js';

  const BASE_URL = "https://nglevagter-test.onrender.com";
  let brugerId = null;
  let visning = "aktive";  // aktuel visning: 'aktive' eller 'lukkede'
  let alleTrÃ¥de = [];      // gem alle trÃ¥de til fane-skift
  
  adgangskontrol({
    tilladteRoller: [],
    redirectVedFejl: "protected.html",
    efterLogin: async (bruger) => {
	brugerId = bruger.id;
	document.getElementById("bruger-navn").textContent = bruger?.navn || "Ukendt";
  
	indsÃ¦tMenu(bruger);

	// Vent lidt, sÃ¥ menuen og badge er sat ind i DOM
	setTimeout(() => {
		lytTilNotifikationer(bruger.id);
		opdaterNotifikationsBadge(); 
	}, 200);

	hentMineTrÃ¥de(bruger.id);
	}
	});


async function hentMineTrÃ¥de(id) {
  try {  
    const res = await fetch(`${BASE_URL}/threads?brugerId=${id}`);
    const trÃ¥de = await res.json();
    alleTrÃ¥de = trÃ¥de;

    // Hent notifikationer
    const { data: notifData, error: notifError } = await client
      .from("kontakt_notifications")
      .select("thread_id")
      .eq("bruger_id", id);
    if (notifError) throw notifError;

    const notifikationsTrÃ¥de = new Set(notifData.map(n => n.thread_id));

    // Hent brugernavne
    const { data: brugere, error } = await client.from("users").select("id, navn");
    if (error) throw error;

    const navnOpslag = {};
    for (const b of brugere) navnOpslag[b.id] = b.navn;

    for (const trÃ¥d of alleTrÃ¥de) {
      if (trÃ¥d.lukket_af) {
        trÃ¥d.lukket_af_navn = navnOpslag[trÃ¥d.lukket_af] || trÃ¥d.lukket_af;
      }
	  
	  if (trÃ¥d.genÃ¥bnet_af) {
  trÃ¥d.genÃ¥bnet_af_navn = navnOpslag[trÃ¥d.genÃ¥bnet_af] || trÃ¥d.genÃ¥bnet_af;
}

      trÃ¥d.oprettet_af_navn = navnOpslag[trÃ¥d.oprettet_af] || trÃ¥d.oprettet_af;

      // MarkÃ©r om der er notifikation
      trÃ¥d.har_notifikation = notifikationsTrÃ¥de.has(trÃ¥d.id);
    }

    visTrÃ¥de(); // vis fane
  } catch (err) {
    console.error("âŒ Fejl:", err);
  }
}


function visTrÃ¥de() {
  const container = document.getElementById("trÃ¥de-liste");
  container.innerHTML = "";

  const filtrerede = alleTrÃ¥de.filter(trÃ¥d =>
    visning === "aktive" ? !trÃ¥d.er_lukket : trÃ¥d.er_lukket
  );

  for (const trÃ¥d of filtrerede) {
    const erAfsender = trÃ¥d.oprettet_af === brugerId;
	const sidsteSet = erAfsender ? trÃ¥d.sidst_set_af_afsender : trÃ¥d.sidst_set_af_modtager;

	const nyeBeskeder = trÃ¥d.opdateret &&
		(!sidsteSet || new Date(trÃ¥d.opdateret) > new Date(sidsteSet));

	const ikon = trÃ¥d.har_notifikation || nyeBeskeder ? "ğŸ”” " : "";

    const div = document.createElement("div");
    div.className = "trÃ¥d-preview";
div.innerHTML = `
  <p><strong>${ikon}${trÃ¥d.titel}</strong></p>
  <small>Fra: ${trÃ¥d.oprettet_af_navn} Â· ${new Date(trÃ¥d.created_at).toLocaleDateString()}</small>
  <button onclick="toggleTrÃ¥dVisning('${trÃ¥d.id}')">ğŸ“‚ Vis trÃ¥d</button>
  <div id="beskeder-${trÃ¥d.id}" class="besked-visning skjult"></div>` +
  (trÃ¥d.er_lukket && trÃ¥d.oprettet_af === brugerId
    ? `<button onclick="sletTrÃ¥d('${trÃ¥d.id}')" style="margin-top:0.4rem; background:red; color:white;">ğŸ—‘ï¸ Slet trÃ¥d</button>`
    : "") +
`  `;
    container.appendChild(div);
  }
}

function skiftVisning(ny) {
  visning = ny;
  document.getElementById("faneknap-aktive").classList.toggle("aktiv-fane", ny === "aktive");
  document.getElementById("faneknap-lukkede").classList.toggle("aktiv-fane", ny === "lukkede");
  visTrÃ¥de();
}


function toggleTrÃ¥dVisning(trÃ¥dId) {
  const container = document.getElementById(`beskeder-${trÃ¥dId}`);
  const alleredeÃ…ben = !container.classList.contains("skjult");

  if (alleredeÃ…ben) {
    container.classList.add("skjult");
    container.innerHTML = "";
    return;
  }

  container.classList.remove("skjult");
  hentOgVisBeskeder(trÃ¥dId);

  // ğŸ”” MarkÃ©r som lÃ¦st uden at kÃ¸re visTrÃ¥de()
  fetch(`${BASE_URL}/mark-thread-read`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ thread_id: trÃ¥dId, bruger_id: brugerId })
  }).then(() => {
    const trÃ¥d = alleTrÃ¥de.find(t => t.id === trÃ¥dId);
    if (trÃ¥d) {
      const nu = new Date().toISOString();
      if (trÃ¥d.oprettet_af === brugerId) {
        trÃ¥d.sidst_set_af_afsender = nu;
      } else {
        trÃ¥d.sidst_set_af_modtager = nu;
      }
	
	trÃ¥d.har_notifikation = false;
	
      // Find og opdatÃ©r overskriften med ğŸ””
      const preview = container.closest(".trÃ¥d-preview");
      if (preview) {
        const overskrift = preview.querySelector("p strong");
        if (overskrift) {
          overskrift.textContent = trÃ¥d.titel;
        }
      }
    }
	
	// ğŸ” Opdater badge (nyt)
opdaterNotifikationsBadge();
	
  });
}


 async function hentOgVisBeskeder(trÃ¥dId) {
  const container = document.getElementById(`beskeder-${trÃ¥dId}`);
  
  const { data: beskeder, error } = await client
    .from("messages")
    .select("*")
    .eq("thread_id", trÃ¥dId)
    .order("tidspunkt", { ascending: true });

  if (error) {
    container.innerHTML = "<p>âŒ Kunne ikke hente beskeder</p>";
    return;
  }

  const { data: brugere } = await client.from("users").select("id, navn");
  const navnOpslag = {}; brugere.forEach(b => navnOpslag[b.id] = b.navn);

const beskedHTML = beskeder.map(b => {
  const navn = navnOpslag[b.afsender] || b.afsender;
  const tekst = b.tekst || "";
  const lyd = b.lyd_url ? `<audio controls src="${b.lyd_url}"></audio>` : "";
  const billede = b.billede_url
    ? `<img src="${b.billede_url}" onclick="Ã¥bnFullscreen(this.src)" />`
    : "";
  return `<div class="besked">
    <strong>${navn}</strong>
    ${tekst}
    ${lyd}
    ${billede}
  </div>`;
}).join("");


  // ğŸ‘‡ Her skal trÃ¥den defineres igen
  const trÃ¥d = alleTrÃ¥de.find(t => t.id === trÃ¥dId);

  let ekstraHTML = "";
  if (trÃ¥d) {
  if (trÃ¥d.er_lukket && trÃ¥d.lukket_af_navn) {
    ekstraHTML += `<p style="margin-top:1rem; color:#999;">ğŸ”’ TrÃ¥den blev lukket af <strong>${trÃ¥d.lukket_af_navn}</strong></p>`;
  }
  if (!trÃ¥d.er_lukket && trÃ¥d.genÃ¥bnet_af_navn) {
    ekstraHTML += `<p style="margin-top:1rem; color:#999;">ğŸ“‚ TrÃ¥den blev genÃ¥bnet af <strong>${trÃ¥d.genÃ¥bnet_af_navn}</strong></p>`;
  }
}
  const svarFelt = trÃ¥d.er_lukket ? "" : `
    <textarea id="svar-${trÃ¥dId}" rows="2" style="width:100%; margin-top:0.5rem;" placeholder="Skriv et svar..."></textarea>
    <button onclick="sendSvar('${trÃ¥dId}')">ğŸ“¤ Send svar</button>
  `;

let lukKnap = "";
if (!trÃ¥d.er_lukket) {
  lukKnap = `<button onclick="lukTrÃ¥d('${trÃ¥dId}')" style="margin-top:0.5rem;">ğŸ—ƒï¸ Luk trÃ¥d</button>`;
} else {
  lukKnap = `<button onclick="genÃ¥bnTrÃ¥d('${trÃ¥dId}')" style="margin-top:0.5rem;">ğŸ“‚ GenÃ¥bn trÃ¥d</button>`;
}

  container.innerHTML = beskedHTML + ekstraHTML + svarFelt + lukKnap;
  
  // Scroll container til bund â€“ nyeste besked
setTimeout(() => {
  container.scrollTop = container.scrollHeight;

  // Scroll ogsÃ¥ hele siden ned til trÃ¥den
  container.scrollIntoView({ behavior: "smooth", block: "end" });
}, 0);

}

async function sendSvar(threadId) {
  const bruger = JSON.parse(localStorage.getItem("bruger"));
  const felt = document.getElementById(`svar-${threadId}`);
  if (!felt) return alert("âŒ Tekstfelt ikke fundet");

  const tekst = felt.value.trim();
  if (!tekst) return alert("â— Du skal skrive noget for at sende");

  const body = {
    thread_id: threadId,
    afsender: bruger.id,
    tekst
  };

  try {
    const res = await fetch(`${BASE_URL}/reply`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (res.ok) {
      felt.value = "";

      const trÃ¥d = alleTrÃ¥de.find(t => t.id === threadId);
      if (trÃ¥d) {
        trÃ¥d.opdateret = new Date().toISOString();

        if (bruger.id === trÃ¥d.oprettet_af) {
          trÃ¥d.sidst_set_af_modtager = null;
          trÃ¥d.sidst_set_af_afsender = new Date().toISOString();
        } else {
          trÃ¥d.sidst_set_af_afsender = null;
          trÃ¥d.sidst_set_af_modtager = new Date().toISOString();
        }

        trÃ¥d.har_notifikation = false;
      }

      await hentOgVisBeskeder(threadId);

      // âœ… MarkÃ©r som lÃ¦st i databasen (sÃ¥ ğŸ”” ikke vises)
      await fetch(`${BASE_URL}/mark-thread-read`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          thread_id: threadId,
          bruger_id: bruger.id
        })
      });

    } else {
      alert("âŒ Kunne ikke sende svar");
      console.error(data.error);
    }
  } catch (err) {
    console.error("Fejl i sendSvar:", err);
    alert("âŒ Der opstod en fejl ved afsendelse");
  }
}

  async function lukTrÃ¥d(trÃ¥dId) {
  if (!confirm("Er du sikker pÃ¥, at du vil lukke denne trÃ¥d?")) return;

  const bruger = JSON.parse(localStorage.getItem("bruger"));

  const res = await fetch(`${BASE_URL}/archive-thread`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ thread_id: trÃ¥dId, lukket_af: bruger.id })
  });

  const data = await res.json();
  if (res.ok) {
    alert("âœ… TrÃ¥den er nu lukket og arkiveret");
    hentMineTrÃ¥de(bruger.id); // behold fane og reload
  } else {
    alert("âŒ Kunne ikke lukke trÃ¥d");
    console.error(data.error);
  }
}

async function opdaterNotifikationsBadge() {
  const bruger = JSON.parse(localStorage.getItem("bruger"));
  if (!bruger) return;

  const { count, error } = await client
    .from("kontakt_notifications")
    .select("*", { count: "exact", head: true })
    .eq("bruger_id", bruger.id);

  // Find badge eller prÃ¸v at oprette en ny
  let badgeEl = document.getElementById("notifikations-badge");

  // Hvis den ikke findes, prÃ¸v at finde hvor den burde indsÃ¦ttes
  if (!badgeEl) {
    const userNameEl = document.querySelector("#user-name");
    if (userNameEl) {
      badgeEl = document.createElement("span");
      badgeEl.id = "notifikations-badge";
      userNameEl.appendChild(badgeEl);
    } else {
      // Hvis slet ingen bruger-UI endnu â†’ prÃ¸v igen senere
      return setTimeout(opdaterNotifikationsBadge, 200);
    }
  }

  // Nu hvor badge findes, vis eller fjern det
  if (error || !count || count === 0) {
    badgeEl.remove();
  } else {
    badgeEl.textContent = count;
  }
}


function lytTilNotifikationer(brugerId) {
  client.channel('notifikations-lyt')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'kontakt_notifications' },
      payload => {
        const notifikation = payload.new || payload.old;
        if (notifikation?.bruger_id === brugerId) {
          opdaterNotifikationsBadge();
        }
      }
    )
    .subscribe();
}

async function sletTrÃ¥d(trÃ¥dId) {
  if (!confirm("Er du sikker pÃ¥, at du vil slette denne trÃ¥d permanent?")) return;

  try {
    const res = await fetch(`${BASE_URL}/delete-thread`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        thread_id: trÃ¥dId,
        bruger_id: brugerId
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert("âœ… TrÃ¥den er slettet");
      hentMineTrÃ¥de(brugerId); // genindlÃ¦s trÃ¥de
    } else {
      alert("âŒ Kunne ikke slette trÃ¥d: " + data.error);
    }
  } catch (err) {
    console.error("Fejl ved sletning:", err);
    alert("âŒ Der opstod en fejl");
  }
}

async function genÃ¥bnTrÃ¥d(trÃ¥dId) {
  if (!confirm("Vil du genÃ¥bne denne trÃ¥d?")) return;

  const bruger = JSON.parse(localStorage.getItem("bruger"));

  const res = await fetch(`${BASE_URL}/reopen-thread`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ thread_id: trÃ¥dId, bruger_id: bruger.id })
  });

  const data = await res.json();
  if (res.ok) {
    alert("âœ… TrÃ¥den er genÃ¥bnet");
    hentMineTrÃ¥de(bruger.id);
  } else {
    alert("âŒ Kunne ikke genÃ¥bne trÃ¥d");
    console.error(data.error);
  }
}


  window.toggleTrÃ¥dVisning = toggleTrÃ¥dVisning;
  window.sendSvar = sendSvar;
  window.lukTrÃ¥d = lukTrÃ¥d;
  window.skiftVisning = skiftVisning;
  window.client = client;
  window.sletTrÃ¥d = sletTrÃ¥d;
  window.genÃ¥bnTrÃ¥d = genÃ¥bnTrÃ¥d;


</script>

<script>
  function Ã¥bnFullscreen(src) {
    const overlay = document.createElement("div");
    overlay.className = "fullscreen-overlay";
    overlay.innerHTML = `<img src="${src}" alt="Fuld visning">`;

    overlay.onclick = () => overlay.remove();
    document.body.appendChild(overlay);
  }
  window.Ã¥bnFullscreen = Ã¥bnFullscreen;
</script>

</body>
</html>
