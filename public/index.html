<!DOCTYPE html>
<html lang="da">
<head>
  <link rel="manifest" href="/public/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NKL Login</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/base.css"/>
  <link rel="stylesheet" href="css/index.css"/>

</head>
<body>

  <div class="login-wrapper">
    <h2>Login</h2>

    <input type="email" id="email" placeholder="Din e-mail" autocomplete="username" />
    <input type="password" id="password" placeholder="Adgangskode" autocomplete="current-password" />
    <button id="login-knap">Log ind</button>

    <button id="opret-knap" type="button">Opret bruger</button>
    <div id="opret-info" class="info-text hidden"></div>

    <p id="status" role="status" aria-live="polite"></p>
  </div>

<!-- Android: kun en almindelig knap -->
<div id="androidInstall" class="hidden" style="max-width:420px;margin:1rem auto;">
  <button id="installBtn" class="install-btn">ðŸ“² TilfÃ¸j som app</button>
</div>


<!-- iOS-install bar -->
<div id="iosInstallBar" class="hidden ios-bar" role="region" aria-label="FÃ¸j til hjemmeskÃ¦rm vejledning">
  <div class="ios-bar-title">ðŸ“² TilfÃ¸j NKL som app</div>

  <div class="ios-steps">
    <span class="ios-instr">Ã…bn i <i>Safari</i>, tryk</span>
    <svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3v8"/><path d="M8.5 6.5L12 3l3.5 3.5"/><path d="M6 10v7a3 3 0 0 0 3 3h6a 3 3 0 0 0 3-3v-7"/>
      </g>
    </svg>
    <span class="ios-instr"><strong>FÃ¸j til hjemmeskÃ¦rm</strong></span>

  </div>
</div>


  <script>
    // ===== Supabase init =====
    const SUPABASE_URL = "https://cianxaxaphvrutmstydr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpYW54YXhhcGh2cnV0bXN0eWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MTk2NTAsImV4cCI6MjA2NTM5NTY1MH0.gdBTs6VoPx3BUAPW63o7kh3WbaCrjfe5YIRe3ubV_mQ";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $("#status");
    function setStatus(txt, isError=false) {
      statusEl.textContent = txt || "";
      statusEl.className = isError ? "error" : "";
    }
    function disableWhile(btns, on=true) {
      btns.forEach(b => b && (b.disabled = on));
    }

    async function checkSessionAndRedirect() {
      try {
        const { data: { session } } = await client.auth.getSession();
        if (!session?.access_token) return;

        const { data: { user }, error: userErr } = await client.auth.getUser();
        if (userErr || !user) return;

        const { data: profile, error: profileError } = await client
          .from("users").select("id, navn, rolle").eq("id", user.id).single();

        if (!profile || profileError) return;

        // OK â†’ gem lokalt og videre til protected
        localStorage.setItem("bruger", JSON.stringify({
          id: user.id, navn: profile.navn, rolle: profile.rolle
        }));
        window.location.href = "protected.html";
      } catch(e) {
        // ingen redirect pÃ¥ fejl â†’ loop-safe
        console.warn("Session check fejl:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", checkSessionAndRedirect);

    // ===== Login =====
    async function login() {
      const emailEl = $("#email");
      const passwordEl = $("#password");
      const loginBtn = $("#login-knap");

      // reset UI
      [emailEl, passwordEl].forEach(el => el.classList.remove("input-fejl"));
      setStatus("");

      const email = emailEl.value.trim();
      const password = passwordEl.value;

      if (!email || !password) {
        if (!email) emailEl.classList.add("input-fejl");
        if (!password) passwordEl.classList.add("input-fejl");
        setStatus("Udfyld e-mail og adgangskode.", true);
        return;
      }

      try {
        disableWhile([loginBtn], true);
        const { data, error } = await client.auth.signInWithPassword({ email, password });

        if (error) {
          setStatus("Login fejlede: " + error.message, true);
          return;
        }

        const userId = data.user.id;
        const { data: profile, error: profileError } = await client
          .from("users").select("navn, rolle").eq("id", userId).single();

        if (profileError || !profile) {
          setStatus("Login lykkedes, men kunne ikke hente profil.", true);
          return;
        }

        localStorage.setItem("bruger", JSON.stringify({
          id: userId, navn: profile.navn, rolle: profile.rolle
        }));

        setStatus("âœ… Login lykkedes â€“ viderestiller â€¦");
        window.location.href = "protected.html";
      } catch (err) {
        console.error(err);
        setStatus("Teknisk fejl under login.", true);
      } finally {
        disableWhile([loginBtn], false);
      }
    }

    // ===== Signup (opret bruger) =====
    function mountSignupUI() {
      const infoBox = $("#opret-info");
      infoBox.classList.remove("hidden");
      infoBox.innerHTML = `
        <ul style="list-style:none; padding-left:0;">
          <li id="check-navn">ðŸ§— Indtast dit navn</li>
          <li id="check-email">ðŸ§— Brug en gyldig e-mailadresse</li>
          <li id="check-kode">ðŸ§— Adgangskoden skal vÃ¦re mindst 6 tegn lang</li>
        </ul>
        <div class="samtykke-tekst">
          <label>
            <input type="checkbox" id="samtykke" />
            Jeg accepterer <a href="persondatapolitik.html" target="_blank" rel="noopener">persondatapolitikken</a>
          </label>
        </div>
        <button id="signup-knap" type="button">BekrÃ¦ft og opret</button>
      `;

      // IndsÃ¦t navn-feltet over e-mail hvis det mangler
      if (!$("#navn")) {
        const navnFelt = document.createElement("input");
        navnFelt.type = "text";
        navnFelt.id = "navn";
        navnFelt.placeholder = "Dit navn";
        navnFelt.className = "input-style";
        $("#email").parentNode.insertBefore(navnFelt, $("#email"));
      }

      // Live tjekliste
      const navnEl = $("#navn");
      const emailEl = $("#email");
      const kodeEl = $("#password");
      const checkNavn = $("#check-navn");
      const checkEmail = $("#check-email");
      const checkKode = $("#check-kode");

      function opdaterTjekliste() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        checkNavn.textContent = navnEl.value.trim() ? "âœ… Indtast dit navn" : "ðŸ§— Indtast dit navn";
        checkEmail.textContent = emailRegex.test(emailEl.value.trim()) ? "âœ… Brug en gyldig e-mailadresse" : "ðŸ§— Brug en gyldig e-mailadresse";
        checkKode.textContent = kodeEl.value.length >= 6 ? "âœ… Adgangskoden skal vÃ¦re mindst 6 tegn lang" : "ðŸ§— Adgangskoden skal vÃ¦re mindst 6 tegn lang";
      }
      [navnEl, emailEl, kodeEl].forEach(el => el.addEventListener("input", opdaterTjekliste));
      opdaterTjekliste();

      $("#signup-knap").addEventListener("click", signup, { once: true });
    }

    async function signup() {
      const emailEl = $("#email");
      const passwordEl = $("#password");
      const navnEl = $("#navn");
      const samtykkeEl = $("#samtykke");
      const signupBtn = $("#signup-knap");

      // reset UI
      [emailEl, passwordEl, navnEl].forEach(el => el && el.classList.remove("input-fejl"));
      setStatus("");

      const email = emailEl.value.trim();
      const password = passwordEl.value;
      const navn = (navnEl?.value || "").trim();

      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const fejlFelter = [];
      if (!navn) { navnEl.classList.add("input-fejl"); fejlFelter.push("navn"); }
      if (!emailPattern.test(email)) { emailEl.classList.add("input-fejl"); fejlFelter.push("eâ€‘mail"); }
      if (password.length < 6) { passwordEl.classList.add("input-fejl"); fejlFelter.push("adgangskode"); }

      if (!samtykkeEl?.checked) {
        setStatus("â— Du skal acceptere persondatapolitikken for at oprette dig.", true);
        return;
      }
      if (fejlFelter.length) {
        setStatus(`âŒ Mangler eller ugyldig: ${fejlFelter.join(", ")}`, true);
        return;
      }

      try {
        disableWhile([signupBtn], true);
        const { data, error } = await client.auth.signUp({ email, password });
        if (error) { setStatus("âŒ Fejl ved oprettelse: " + error.message, true); return; }

        const userId = data.user.id;
        const { error: insertError } = await client.from("users").insert({
		id: userId,
		navn: navn,
		rolle: ["klubmedlem"] // brug det samme feltnavn/struktur som din users-tabel
		});

        if (insertError) {
          setStatus("âš ï¸ Profil kunne ikke gemmes: " + insertError.message, true);
          return;
        }

        setStatus("âœ… Bruger oprettet â€“ viderestiller â€¦");
        // Efter signUp er brugeren normalt logget ind (afhÃ¦nger af projektets authâ€‘policy)
        // ForsÃ¸g at hente session og redirecte
        await checkSessionAndRedirect();
        // Hvis ingen session (fx krÃ¦ver emailâ€‘confirm), sÃ¥ informÃ©r:
        setTimeout(() => {
          setStatus("Tjek din mail for bekrÃ¦ftelse, hvis du ikke viderestilles automatisk.");
        }, 800);
      } catch (err) {
        console.error(err);
        setStatus("Teknisk fejl ved oprettelse.", true);
      } finally {
        disableWhile([signupBtn], false);
      }
    }

    // ===== Event wiring =====
    $("#login-knap").addEventListener("click", login);
    $("#password").addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    $("#opret-knap").addEventListener("click", (e) => {
      e.currentTarget.classList.add("hidden");
      mountSignupUI();
    });
  
  </script>

<script>
(function () {
  const androidWrap = document.getElementById('androidInstall');
  const installBtn  = document.getElementById('installBtn');
  const iosBar      = document.getElementById('iosInstallBar');
  const iosDismiss  = document.getElementById('iosDismiss');

  let deferredPrompt = null;

  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                    || window.navigator.standalone === true; 
  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isAndroid = /Android/i.test(ua);
  const iosDismissed = localStorage.getItem('ios_install_dismissed') === '1';

  function showIOSBar() {
    if (isStandalone || iosDismissed) return;
    iosBar.classList.remove('hidden');
    androidWrap.classList.add('hidden');
  }
  function showAndroidButton(active) {
    if (isStandalone) return;
    iosBar.classList.add('hidden');
    if (active) {
      installBtn.disabled = false;
      installBtn.textContent = 'ðŸ“² TilfÃ¸j som app';
      androidWrap.classList.remove('hidden');
    } else {
      androidWrap.classList.add('hidden');
    }
  }

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (isAndroid) showAndroidButton(true);
  });
  installBtn?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    installBtn.disabled = true;
    try {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
    } finally {
      deferredPrompt = null;
      androidWrap.classList.add('hidden');
      installBtn.disabled = false;
    }
  });
  window.addEventListener('appinstalled', () => {
    iosBar.classList.add('hidden');
    androidWrap.classList.add('hidden');
    deferredPrompt = null;
  });

  document.addEventListener('DOMContentLoaded', () => {
    if (isIOS) showIOSBar();
  });

  let lastScrollY = window.scrollY;
  const DELTA = 1; 

  window.addEventListener('scroll', () => {
    if (!isIOS || isStandalone || iosDismissed) return;

    const current = window.scrollY;
    const diff = current - lastScrollY;

    if (diff > DELTA) {
      if (!iosBar.classList.contains('hidden')) {
        iosBar.classList.add('hidden');


      }
    } else if (diff < -DELTA) {
        iosBar.classList.remove('hidden');
    }

    lastScrollY = current;
  }, { passive: true });
})();
</script>


</body>
</html>
