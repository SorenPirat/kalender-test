<!DOCTYPE html>
<html lang="da">
<head>
  <link rel="manifest" href="/public/manifest.webmanifest">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0ea5e9">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NKL Login</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/base.css"/>
  <link rel="stylesheet" href="css/index.css"/>

</head>
<body>

  <div class="login-wrapper">
    <h2>Login</h2>

    <input type="email" id="email" placeholder="Din e-mail" autocomplete="username" />
    <input type="password" id="password" placeholder="Adgangskode" autocomplete="current-password" />
    <button id="login-knap">Log ind</button>

    <button id="opret-knap" type="button">Opret bruger</button>
    <div id="opret-info" class="info-text hidden"></div>

    <p id="status" role="status" aria-live="polite"></p>
  </div>

<!-- Install-UI bundbar -->
<div id="install-bar" class="install-bar hidden">
  <button id="btn-install" class="install-btn">Tilf√∏j som app (Android)</button>

  <!-- iOS hint (vises kun p√• iPhone/iPad) -->
  <div id="ios-hint" class="ios-hint hidden">
    <strong>iPhone/iPad:</strong> √Öbn siden i <em>Safari</em>, tryk <span class="ios-share">Del</span>, v√¶lg <strong>F√∏j til hjemmesk√¶rm</strong>.
  </div>
</div>


  <script>
    // ===== Supabase init =====
    const SUPABASE_URL = "https://cianxaxaphvrutmstydr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpYW54YXhhcGh2cnV0bXN0eWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MTk2NTAsImV4cCI6MjA2NTM5NTY1MH0.gdBTs6VoPx3BUAPW63o7kh3WbaCrjfe5YIRe3ubV_mQ";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $("#status");
    function setStatus(txt, isError=false) {
      statusEl.textContent = txt || "";
      statusEl.className = isError ? "error" : "";
    }
    function disableWhile(btns, on=true) {
      btns.forEach(b => b && (b.disabled = on));
    }

    // ===== Loop-safe session check =====
    // Kun redirect til protected.html n√•r:
    // 1) der ER en gyldig session og
    // 2) profilen findes i "users".
    async function checkSessionAndRedirect() {
      try {
        const { data: { session } } = await client.auth.getSession();
        if (!session?.access_token) return;

        const { data: { user }, error: userErr } = await client.auth.getUser();
        if (userErr || !user) return;

        const { data: profile, error: profileError } = await client
          .from("users").select("id, navn, rolle").eq("id", user.id).single();

        if (!profile || profileError) return;

        // OK ‚Üí gem lokalt og videre til protected
        localStorage.setItem("bruger", JSON.stringify({
          id: user.id, navn: profile.navn, rolle: profile.rolle
        }));
        window.location.href = "protected.html";
      } catch(e) {
        // ingen redirect p√• fejl ‚Üí loop-safe
        console.warn("Session check fejl:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", checkSessionAndRedirect);

    // ===== Login =====
    async function login() {
      const emailEl = $("#email");
      const passwordEl = $("#password");
      const loginBtn = $("#login-knap");

      // reset UI
      [emailEl, passwordEl].forEach(el => el.classList.remove("input-fejl"));
      setStatus("");

      const email = emailEl.value.trim();
      const password = passwordEl.value;

      if (!email || !password) {
        if (!email) emailEl.classList.add("input-fejl");
        if (!password) passwordEl.classList.add("input-fejl");
        setStatus("Udfyld e-mail og adgangskode.", true);
        return;
      }

      try {
        disableWhile([loginBtn], true);
        const { data, error } = await client.auth.signInWithPassword({ email, password });

        if (error) {
          setStatus("Login fejlede: " + error.message, true);
          return;
        }

        const userId = data.user.id;
        const { data: profile, error: profileError } = await client
          .from("users").select("navn, rolle").eq("id", userId).single();

        if (profileError || !profile) {
          setStatus("Login lykkedes, men kunne ikke hente profil.", true);
          return;
        }

        localStorage.setItem("bruger", JSON.stringify({
          id: userId, navn: profile.navn, rolle: profile.rolle
        }));

        setStatus("‚úÖ Login lykkedes ‚Äì viderestiller ‚Ä¶");
        window.location.href = "protected.html";
      } catch (err) {
        console.error(err);
        setStatus("Teknisk fejl under login.", true);
      } finally {
        disableWhile([loginBtn], false);
      }
    }

    // ===== Signup (opret bruger) =====
    function mountSignupUI() {
      const infoBox = $("#opret-info");
      infoBox.classList.remove("hidden");
      infoBox.innerHTML = `
        <ul style="list-style:none; padding-left:0;">
          <li id="check-navn">üßó Indtast dit navn</li>
          <li id="check-email">üßó Brug en gyldig e-mailadresse</li>
          <li id="check-kode">üßó Adgangskoden skal v√¶re mindst 6 tegn lang</li>
        </ul>
        <div class="samtykke-tekst">
          <label>
            <input type="checkbox" id="samtykke" />
            Jeg accepterer <a href="persondatapolitik.html" target="_blank" rel="noopener">persondatapolitikken</a>
          </label>
        </div>
        <button id="signup-knap" type="button">Bekr√¶ft og opret</button>
      `;

      // Inds√¶t navn-feltet over e-mail hvis det mangler
      if (!$("#navn")) {
        const navnFelt = document.createElement("input");
        navnFelt.type = "text";
        navnFelt.id = "navn";
        navnFelt.placeholder = "Dit navn";
        navnFelt.className = "input-style";
        $("#email").parentNode.insertBefore(navnFelt, $("#email"));
      }

      // Live tjekliste
      const navnEl = $("#navn");
      const emailEl = $("#email");
      const kodeEl = $("#password");
      const checkNavn = $("#check-navn");
      const checkEmail = $("#check-email");
      const checkKode = $("#check-kode");

      function opdaterTjekliste() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        checkNavn.textContent = navnEl.value.trim() ? "‚úÖ Indtast dit navn" : "üßó Indtast dit navn";
        checkEmail.textContent = emailRegex.test(emailEl.value.trim()) ? "‚úÖ Brug en gyldig e-mailadresse" : "üßó Brug en gyldig e-mailadresse";
        checkKode.textContent = kodeEl.value.length >= 6 ? "‚úÖ Adgangskoden skal v√¶re mindst 6 tegn lang" : "üßó Adgangskoden skal v√¶re mindst 6 tegn lang";
      }
      [navnEl, emailEl, kodeEl].forEach(el => el.addEventListener("input", opdaterTjekliste));
      opdaterTjekliste();

      $("#signup-knap").addEventListener("click", signup, { once: true });
    }

    async function signup() {
      const emailEl = $("#email");
      const passwordEl = $("#password");
      const navnEl = $("#navn");
      const samtykkeEl = $("#samtykke");
      const signupBtn = $("#signup-knap");

      // reset UI
      [emailEl, passwordEl, navnEl].forEach(el => el && el.classList.remove("input-fejl"));
      setStatus("");

      const email = emailEl.value.trim();
      const password = passwordEl.value;
      const navn = (navnEl?.value || "").trim();

      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const fejlFelter = [];
      if (!navn) { navnEl.classList.add("input-fejl"); fejlFelter.push("navn"); }
      if (!emailPattern.test(email)) { emailEl.classList.add("input-fejl"); fejlFelter.push("e‚Äëmail"); }
      if (password.length < 6) { passwordEl.classList.add("input-fejl"); fejlFelter.push("adgangskode"); }

      if (!samtykkeEl?.checked) {
        setStatus("‚ùó Du skal acceptere persondatapolitikken for at oprette dig.", true);
        return;
      }
      if (fejlFelter.length) {
        setStatus(`‚ùå Mangler eller ugyldig: ${fejlFelter.join(", ")}`, true);
        return;
      }

      try {
        disableWhile([signupBtn], true);
        const { data, error } = await client.auth.signUp({ email, password });
        if (error) { setStatus("‚ùå Fejl ved oprettelse: " + error.message, true); return; }

        const userId = data.user.id;
        const { error: insertError } = await client.from("users").insert({
          id: userId,
          navn: navn,
          roller: Array.isArray(profile.rolle) ? profile.rolle : [profile.rolle || "klubmedlem"]
		});
        if (insertError) {
          setStatus("‚ö†Ô∏è Profil kunne ikke gemmes: " + insertError.message, true);
          return;
        }

        setStatus("‚úÖ Bruger oprettet ‚Äì viderestiller ‚Ä¶");
        // Efter signUp er brugeren normalt logget ind (afh√¶nger af projektets auth‚Äëpolicy)
        // Fors√∏g at hente session og redirecte
        await checkSessionAndRedirect();
        // Hvis ingen session (fx kr√¶ver email‚Äëconfirm), s√• inform√©r:
        setTimeout(() => {
          setStatus("Tjek din mail for bekr√¶ftelse, hvis du ikke viderestilles automatisk.");
        }, 800);
      } catch (err) {
        console.error(err);
        setStatus("Teknisk fejl ved oprettelse.", true);
      } finally {
        disableWhile([signupBtn], false);
      }
    }

    // ===== Event wiring =====
    $("#login-knap").addEventListener("click", login);
    $("#password").addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    $("#opret-knap").addEventListener("click", (e) => {
      e.currentTarget.classList.add("hidden");
      mountSignupUI();
    });
  
  </script>

<script>
(function() {
  const installBar   = document.getElementById('install-bar');
  const btnInstall   = document.getElementById('btn-install');
  const iosHint      = document.getElementById('ios-hint');
  let deferredPrompt = null;

  // Er vi allerede "installeret"/k√∏rer som PWA? -> Skjul alt
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                    || window.navigator.standalone === true; // iOS

  // Simpel UA-detektion til iOS (bruges kun til at vise guiden)
  const ua = window.navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  // Vises kun hvis: ikke standalone + enten Android med beforeinstallprompt eller iOS
  function maybeShowBar() {
    if (isStandalone) return;

    // Android: vis bar hvis vi har en deferredPrompt
    if (deferredPrompt) {
      installBar.classList.remove('hidden');
      btnInstall.classList.remove('hidden');
      iosHint.classList.add('hidden');
      return;
    }

    // iOS: vis guide (kun i Safari giver Add to Home Screen fuld PWA-oplevelse)
    if (isIOS) {
      installBar.classList.remove('hidden');
      btnInstall.classList.add('hidden');     // knap er kun til Android
      iosHint.classList.remove('hidden');
    }
  }

  // Fang Androids "f√∏r-installations" event og gem det til senere (vores knap)
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();          // vi styrer selv prompten
    deferredPrompt = e;
    maybeShowBar();
  });

  // Klik p√• Android-knappen -> vis prompt
  btnInstall?.addEventListener('click', async () => {
    try {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      // Uanset valg skjuler vi baren ‚Äì viser den igen senere, hvis browseren tillader
      installBar.classList.add('hidden');
      deferredPrompt = null;
      // (Valgfrit) Track choice.outcome === 'accepted' / 'dismissed'
    } catch (err) {
      console.error('Install prompt error:', err);
    }
  });

  // N√•r app‚Äôen er installeret -> skjul baren
  window.addEventListener('appinstalled', () => {
    installBar.classList.add('hidden');
    deferredPrompt = null;
  });

  // Hvis browseren ikke fyrer beforeinstallprompt (fx Chrome kan have ‚Äúinstall‚Äù-menu),
  // kan du stadig vise en diskret info ‚Äì vi viser kun iOS guide by default.
  document.addEventListener('DOMContentLoaded', maybeShowBar);
})();
</script>
</body>
</html>
