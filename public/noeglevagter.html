<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N√∏glevagter - NKL</title>
  <link rel="stylesheet" href="calendar.css" />
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="menu.css" />
</head>
<body>

<script type="module">
  import { adgangskontrol, inds√¶tMenu, client } from './auth.js';

  adgangskontrol({
    tilladteRoller: ["admin", "n√∏gleb√¶rer", "eventmaker"],
    redirectVedFejl: "index.html",
    efterLogin: async (bruger) => {
	  if (window.releaseAuthGate) window.releaseAuthGate();
      inds√¶tMenu(bruger);
	  const assignments = await hentN√∏glevagter();
	  const events = await hentEvents();
	  renderWeekOverview(assignments, events);
	  renderCalendar(assignments, events);
    }
  });

  const months = ['januar', 'februar', 'marts', 'april', 'maj', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'december'];
  const weekdays = ['s√∏n', 'man', 'tirs', 'ons', 'tors', 'fre', 'l√∏r'];
  const calendarContainer = document.getElementById('calendar');
  const calendarSpan = 12;

function gemAktivM√•nedOg√ÖrFraDato(dato) {
  const month = dato.getMonth();
  const year = dato.getFullYear();
  localStorage.setItem("aktivM√•ned", month);
  localStorage.setItem("aktiv√Ör", year);
}

async function hentN√∏glevagter() {
  const { data, error } = await client
    .from("assignments")
    .select('*')
    .order('dato', { ascending: true });

  return data;
}

async function hentEvents() {
  const { data, error } = await client
    .from("events")
    .select("*")
    .eq("offentlig", true);

  if (error) {
    console.error("‚ùå Fejl ved hentning af events:", error);
    return [];
  }

  return data;
}

function renderWeekOverview(assignments, events) {
  const weekContainer = document.getElementById("week-overview");
  if (!weekContainer) return;
  weekContainer.innerHTML = "";

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const weekDays = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    weekDays.push(date);
  }

  const wrapper = document.createElement("div");
  wrapper.className = "week-overview-wrapper";


  weekDays.forEach(dato => {
    const iso = dato.toLocaleDateString('sv-SE');
    const assignment = assignments.find(a => a.dato === iso);
    const dagsEvents = events.filter(ev => {
      const start = new Date(ev.start);
      const slut = ev.slut ? new Date(ev.slut) : start;
      start.setHours(0, 0, 0, 0);
      slut.setHours(0, 0, 0, 0);
      return dato >= start && dato <= slut;
    });

    const box = document.createElement("div");
    box.style.flex = "0 0 auto";
    box.style.minWidth = "110px";
    box.style.borderRadius = "8px";
    box.style.padding = "0.5rem";
    box.style.backgroundColor = "#ffffff";
    box.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";
    box.style.fontSize = "0.85rem";
    box.style.lineHeight = "1.3";

    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      box.style.backgroundColor = "#2c2c2c";
      box.style.color = "#e0e0e0";
    }

    const label = document.createElement("div");
    label.style.fontWeight = "bold";
    label.style.marginBottom = "0.25rem";
    label.textContent = `${weekdays[dato.getDay()]} d. ${dato.getDate()}`;
    box.appendChild(label);

    if (assignment?.status === "lukket") {
      const lukket = document.createElement("div");
      lukket.textContent = `üîí ${assignment?.lukkegrund || "Lukket"}`;
      box.appendChild(lukket);
    }

    dagsEvents.forEach(ev => {
      const evtEl = document.createElement("div");
      evtEl.textContent = `üìÖ ${ev.titel}`;
      box.appendChild(evtEl);
    });

    if (assignment?.navn) {
      const navnEl = document.createElement("div");
      navnEl.textContent = `üîë ${assignment.navn}`;
      box.appendChild(navnEl);
    }

    wrapper.appendChild(box);
  });

  weekContainer.appendChild(wrapper);
}

function tilLocalDateTimeInput(date) {
  const pad = (n) => n.toString().padStart(2, '0');
  const yyyy = date.getFullYear();
  const mm = pad(date.getMonth() + 1);
  const dd = pad(date.getDate());
  const hh = pad(date.getHours());
  const min = pad(date.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
}

function huskOgGenindl√¶s(m√•ned, √•r) {
  localStorage.setItem("aktivM√•ned", m√•ned);
  localStorage.setItem("aktiv√Ör", √•r);
  location.reload();
 }

function renderCalendar(assignments, events) {
  calendarContainer.innerHTML = "";

  let aktivM√•ned = parseInt(localStorage.getItem("aktivM√•ned"));
  let aktiv√Ör = parseInt(localStorage.getItem("aktiv√Ör"));

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  if (isNaN(aktivM√•ned) || isNaN(aktiv√Ör)) {
  aktivM√•ned = today.getMonth();
  aktiv√Ör = today.getFullYear();
  }

  localStorage.removeItem("aktivM√•ned");
  localStorage.removeItem("aktiv√Ör");

  for (let i = 0; i < calendarSpan; i++) {
    const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
    const isAktiv = (date.getMonth() === aktivM√•ned && date.getFullYear() === aktiv√Ör);
    renderMonth(date.getMonth(), date.getFullYear(), assignments, events, isAktiv);
  }
}

function ruterMobilVisning(content, daysInMonth, month, year, assignments, events) {
  const iG√•r = new Date();
  iG√•r.setDate(iG√•r.getDate() - 1);
  iG√•r.setHours(0, 0, 0, 0);

  const bruger = JSON.parse(localStorage.getItem("bruger"));

  for (let day = 1; day <= daysInMonth; day++) {
    const dato = new Date(year, month, day);
    dato.setHours(0, 0, 0, 0);
    if (dato < iG√•r) continue;

    const iso = dato.toLocaleDateString('sv-SE');
    const assignment = assignments.find(a => a.dato === iso);
    const dagsEvents = events.filter(ev => {
      const evStart = new Date(ev.start);
      const evSlut = ev.slut ? new Date(ev.slut) : evStart;
      evStart.setHours(0, 0, 0, 0);
      evSlut.setHours(0, 0, 0, 0);
      return dato >= evStart && dato <= evSlut;
    });

    const kort = document.createElement("div");
    kort.className = "mobil-dag-kort";

    // ‚ûï Visning af felter
    const felter = [
      { label: "Dato", v√¶rdi: `${weekdays[dato.getDay()]} d. ${day}. ${months[month]}` },
      { label: "N√∏gleb√¶rer", v√¶rdi: assignment?.status === "lukket" ? "‚Äì" : (assignment?.navn || "Ingen n√∏glevagt") },
      { label: "Status", v√¶rdi: assignment?.status === "lukket" ? "üîí Lukket" : (assignment?.status === "tildelt" ? "üîë Tildelt" : "Ingen n√∏glevagt") },
      {
        label: "Begivenheder",
        v√¶rdi: dagsEvents.length > 0
          ? dagsEvents.map(e => `üìÖ ${e.titel}`).join(", ")
          : "Ingen begivenheder"
      }
    ];

    felter.forEach(f => {
      const linje = document.createElement("div");
      linje.className = "mobil-linje";
      linje.innerHTML = `<strong>${f.label}:</strong> ${f.v√¶rdi}`;
      kort.appendChild(linje);
    });

    // üîò Handling-knapper
    const tdHandling = document.createElement("div");
    tdHandling.className = "mobil-handlinger";

    // === TILF√òJ-KNAP ===
    if (
      assignment?.status !== "lukket" &&
      (!assignment || !assignment.navn) &&
      (bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
    ) {
      const btn = document.createElement("button");
      btn.textContent = "üîë";
      btn.title = "Tilf√∏j n√∏glevagt";
      btn.onclick = async () => {
        let navn = bruger.navn;
        if (bruger.roller.includes("admin")) {
          const input = prompt("Indtast navn p√• n√∏glevagt:", navn);
          if (!input) return;
          navn = input.trim();
        }

        const { error } = await client.from("assignments").upsert({
          dato: iso,
          status: "tildelt",
          navn: navn,
          oprettet_af: bruger.id,
          oprettet_tid: new Date().toISOString()
        }, { onConflict: "dato" });

        if (error) {
          alert("‚ùå Kunne ikke tilf√∏je n√∏glevagt.");
        } else {
          alert("‚úÖ N√∏glevagt tilf√∏jet!");
          gemAktivM√•nedOg√ÖrFraDato(dato);
          huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
        }
      };
      tdHandling.appendChild(btn);
    }

    // === SLET-KNAP ===
    if (assignment?.status === "tildelt") {
      const slet = document.createElement("button");
      slet.textContent = "üóëÔ∏è";
      slet.title = "Fjern n√∏glevagt";
      slet.onclick = async () => {
        if (!confirm("Vil du fjerne denne n√∏glevagt?")) return;
        const { error } = await client.from("assignments").upsert({
          dato: iso,
          status: "Ingen n√∏glevagt",
          navn: null,
          oprettet_af: bruger.id,
          oprettet_tid: new Date().toISOString()
        }, { onConflict: "dato" });
        if (error) {
          alert("‚ùå Kunne ikke fjerne n√∏glevagt.");
        } else {
          alert("üóëÔ∏è N√∏glevagt fjernet!");
          gemAktivM√•nedOg√ÖrFraDato(dato);
          huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
        }
      };
      tdHandling.appendChild(slet);
    }

    // === LUK-KNAP ===
    if (assignment?.status !== "lukket") {
      const luk = document.createElement("button");
      luk.textContent = "üîí";
      luk.title = "Luk dag(e)";
      luk.onclick = async () => {
        const √•rsag = prompt("Hvorfor skal dagene lukkes? (valgfrit)");
        if (√•rsag === null) return;

        const slutdato = prompt("Sidste dato for lukning? (YYYY-MM-DD)", iso);
        if (!slutdato) return;

        const startDate = new Date(iso);
        const endDate = new Date(slutdato);
        if (isNaN(endDate)) return alert("Ugyldig dato");

        const datoer = [];
        const cursor = new Date(startDate);
        while (cursor <= endDate) {
          datoer.push(cursor.toISOString().split("T")[0]);
          cursor.setDate(cursor.getDate() + 1);
        }

        const r√¶kker = datoer.map(d => ({
          dato: d,
          status: "lukket",
          navn: null,
          lukkegrund: √•rsag,
          oprettet_af: bruger.id,
          oprettet_tid: new Date().toISOString()
        }));

        const { error } = await client.from("assignments").upsert(r√¶kker, { onConflict: "dato" });

        if (error) return alert("‚ùå Kunne ikke lukke dagene.");

        const eventId = crypto.randomUUID();
        const { error: eventError } = await client.from("events").insert({
          id: eventId,
          titel: `Lukket ‚Äì ${√•rsag || "uden √•rsag"}`,
          start: startDate.toISOString(),
          slut: endDate.toISOString(),
          offentlig: true,
          oprettet_af: bruger.id,
        });

        if (eventError) alert("‚ö†Ô∏è Begivenheden blev ikke oprettet i events-tabellen.");

        alert("‚úÖ Dag(e) lukket!");
        gemAktivM√•nedOg√ÖrFraDato(dato);
        huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
      };
      tdHandling.appendChild(luk);
    }

    // === GEN√ÖBN ===
if (
  assignment?.status === "lukket" &&
  (bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
) {
  const openBtn = document.createElement("button");
  openBtn.textContent = "üîì";
  openBtn.title = "Gen√•bn dag";

  openBtn.onclick = async () => {
    if (!confirm("Vil du gen√•bne denne dag og fjerne lukkedagen?")) return;

    // Opdater assignments
    const { error } = await client.from("assignments").upsert({
      dato: iso,
      status: "Ingen n√∏glevagt",
      navn: null,
      lukkegrund: null,
      oprettet_af: bruger.id,
      oprettet_tid: new Date().toISOString()
    }, {
      onConflict: "dato"
    });

    if (error) {
      console.error("‚ùå Supabase-fejl (√•bn dag):", error);
      alert("‚ùå Kunne ikke gen√•bne dagen.");
      return;
    }

    // Slet lukkede events der overlapper pr√¶cis denne dato
    const { data: alleEvents, error: fetchError } = await client
      .from("events")
      .select("id, titel, start, slut");

    if (fetchError) {
      console.warn("‚ö†Ô∏è Kunne ikke hente events:", fetchError);
    } else {
      const dagStart = new Date(`${iso}T00:00:00`);
      const dagSlut = new Date(`${iso}T23:59:59`);

      const overlappendeLukkede = alleEvents.filter(ev => {
        const start = new Date(ev.start);
        const slut = ev.slut ? new Date(ev.slut) : start;

        const overlapper = slut >= dagStart && start <= dagSlut;
        return overlapper && ev.titel?.toLowerCase().startsWith("lukket");
      });

      for (const ev of overlappendeLukkede) {
        const { error: deleteError } = await client
          .from("events")
          .delete()
          .eq("id", ev.id);

        if (deleteError) {
          console.warn("‚ö†Ô∏è Kunne ikke slette lukket-event:", deleteError);
        }
      }
    }

    alert("‚úÖ Dagen er gen√•bnet og event fjernet!");
    gemAktivM√•nedOg√ÖrFraDato(dato);
    huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
  };

  tdHandling.appendChild(openBtn);
}

    // === OPRET BEGIVENHED ===
    if (bruger.roller.includes("admin") || bruger.roller.includes("eventmaker")) {
      const plus = document.createElement("button");
      plus.textContent = "‚ûï";
      plus.title = "Opret begivenhed";
      plus.onclick = () => {
        √•bnEventModal(dato);
      };
      tdHandling.appendChild(plus);
    }

    kort.appendChild(tdHandling);
    content.appendChild(kort);
  }
}


function renderMonth(month, year, assignments, events, isAktiv = false) {
  const block = document.createElement('div');
  block.className = 'month-block';

  const content = document.createElement('div');
  content.className = 'month-content';

  if (isAktiv) {
    content.classList.add("active");
  }

    const stickyHeader = document.createElement('div');
    stickyHeader.className = 'month-sticky-header';
    stickyHeader.textContent = months[month].charAt(0).toUpperCase() + months[month].slice(1);

    stickyHeader.addEventListener('click', () => {
      const wasActive = content.classList.contains('active');
      document.querySelectorAll('.month-content').forEach(mc => mc.classList.remove('active'));
      if (!wasActive) content.classList.add('active');
    });

    block.appendChild(stickyHeader);
    block.appendChild(content);
    calendarContainer.appendChild(block);
	
	const erMobil = window.innerWidth < 600;
	const daysInMonth = new Date(year, month + 1, 0).getDate();

	if (erMobil) {
	ruterMobilVisning(content, daysInMonth, month, year, assignments, events);
	return;
	}

	const table = document.createElement('table');
	table.innerHTML = `
	<thead>
	<tr>
      <th>Dato</th>
      <th>N√∏glevagt</th>
      <th>Status</th>
      <th>Begivenheder</th>
      <th>Handling</th>
    </tr>
	</thead>
	<tbody></tbody>
	`;

	const tbody = table.querySelector("tbody");

	const iG√•r = new Date();
	iG√•r.setDate(iG√•r.getDate() - 1);
	iG√•r.setHours(0, 0, 0, 0);

	for (let day = 1; day <= daysInMonth; day++) {
    const dato = new Date(year, month, day);
    dato.setHours(0, 0, 0, 0);

    if (dato < iG√•r) continue;
	  
      const iso = dato.toLocaleDateString('sv-SE');
      const assignment = assignments.find(a => a.dato === iso);
      const tr = document.createElement('tr');
      const tdDato = document.createElement('td');
      const tdNavn = document.createElement('td');
      const tdStatus = document.createElement('td');
	  const tdHandling = document.createElement("td");
	  const tdEvents = document.createElement('td');
	  const bruger = JSON.parse(localStorage.getItem("bruger"));
	  

// === TILF√òJ-KNAP ===
if (
  assignment?.status !== "lukket" &&
  (!assignment || !assignment.navn) &&
  (bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
) {
  const btn = document.createElement("button");
  btn.textContent = "üîë";
  btn.title = "Tilf√∏j n√∏glevagt";

btn.onclick = async () => {
  let navn = bruger.navn;

  if (bruger.roller.includes("admin")) {
    const input = prompt("Indtast navn p√• n√∏glevagt:", navn);
    if (!input) return;
    navn = input.trim();
  }

const { error } = await client
  .from("assignments")
  .upsert({
    dato: iso,
    status: "tildelt",
    navn: navn,
    oprettet_af: bruger.id,
    oprettet_tid: new Date().toISOString()
  }, {
    onConflict: "dato"
  });


  if (error) {
    console.error("‚ùå Supabase-fejl:", error);
    alert("‚ùå Kunne ikke tilf√∏je n√∏glevagt.");
  } else {
    alert("‚úÖ N√∏glevagt tilf√∏jet!");
	gemAktivM√•nedOg√ÖrFraDato(dato);
	huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
  }
};

  tdHandling.appendChild(btn);
}

// === FJERN-KNAP ===
if (
  assignment?.status === "tildelt" &&
(bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
 ) {
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "üóëÔ∏è";
  deleteBtn.title = "Fjern n√∏glevagt";

  deleteBtn.onclick = async () => {
    if (!confirm("Vil du fjerne denne n√∏glevagt?")) return;

const { error } = await client
  .from("assignments")
  .upsert({
    dato: iso,
    status: "Ingen n√∏glevagt",
    navn: null,
    oprettet_af: bruger.id,
    oprettet_tid: new Date().toISOString()
  }, {
    onConflict: "dato"
  });


    if (error) {
      console.error("‚ùå Supabase-fejl:", error);
      alert("‚ùå Kunne ikke fjerne n√∏glevagt.");
    } else {
      alert("üóëÔ∏è N√∏glevagt fjernet!");
    gemAktivM√•nedOg√ÖrFraDato(dato);
	huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
    }
  };

  tdHandling.appendChild(deleteBtn);
}
	  // === LUK-DAG-KNAP ===
if (
  assignment?.status !== "lukket" &&
  (bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
) {
  const lukBtn = document.createElement("button");
  lukBtn.textContent = "üîí";
  lukBtn.title = "Luk dag(e)";

  lukBtn.onclick = async () => {
    const √•rsag = prompt("Hvorfor skal dagene lukkes? (valgfrit)");
    if (√•rsag === null) return;
		
    const slutdato = prompt("Sidste dato for lukning? (YYYY-MM-DD) ‚Äì tryk OK for kun √©n dag:", iso);
    if (!slutdato) return;

    const startDate = new Date(iso);
    const endDate = new Date(slutdato);
    if (isNaN(endDate)) return alert("Ugyldig slutdato");

    const datoer = [];
    const cursor = new Date(startDate);
    while (cursor <= endDate) {
      datoer.push(cursor.toISOString().split("T")[0]);
      cursor.setDate(cursor.getDate() + 1);
    }

    // ‚ûï Luk dage i assignments
    const r√¶kker = datoer.map(d => ({
      dato: d,
      status: "lukket",
	  navn: null,
      lukkegrund: √•rsag,
      oprettet_af: bruger.id,
      oprettet_tid: new Date().toISOString()
    }));

    const { error } = await client.from("assignments").upsert(r√¶kker, { onConflict: "dato" });
    if (error) {
      console.error("‚ùå Supabase-fejl (luk dag):", error);
      alert("‚ùå Kunne ikke lukke dagene.");
      return;
    }

    // ‚ûï Opret event i events-tabellen
const eventId = crypto.randomUUID();
const { error: eventError } = await client
  .from("events")
  .insert({
    id: eventId,
    titel: `Lukket ‚Äì ${√•rsag || "uden √•rsag"}`,
    start: startDate.toLocaleString('sv-SE', { timeZone: 'Europe/Copenhagen' }),
    slut: endDate.toLocaleString('sv-SE', { timeZone: 'Europe/Copenhagen' }),
    offentlig: true,
    oprettet_af: bruger.id,
  });


if (eventError) {
  console.error("‚ùå Fejl ved oprettelse af event:", eventError);
  alert("‚ö†Ô∏è Begivenheden blev ikke oprettet i events-tabellen.");
}


    alert("‚úÖ Dag(e) lukket og begivenhed oprettet!");
    gemAktivM√•nedOg√ÖrFraDato(dato);
	huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
  };

  tdHandling.appendChild(lukBtn);
}


// === GEN√ÖBN DAG ===
if (
  assignment?.status === "lukket" &&
  (bruger.roller.includes("admin") || bruger.roller.includes("n√∏gleb√¶rer") || bruger.roller.includes("eventmaker"))
) {
  const openBtn = document.createElement("button");
  openBtn.textContent = "üîì";
  openBtn.title = "Gen√•bn dag";

  openBtn.onclick = async () => {
    if (!confirm("Vil du gen√•bne denne dag og fjerne lukkedagen?")) return;

    // ‚è´ Opdater assignments-tabellen
    const { error } = await client.from("assignments").upsert({
      dato: iso,
      status: "Ingen n√∏glevagt",
      navn: null,
      lukkegrund: null,
      oprettet_af: bruger.id,
      oprettet_tid: new Date().toISOString()
    }, {
      onConflict: "dato"
    });

    if (error) {
      console.error("‚ùå Supabase-fejl (√•bn dag):", error);
      alert("‚ùå Kunne ikke gen√•bne dagen.");
      return;
    }

    // üßº Slet "lukket"-begivenheder der overlapper pr√¶cis denne dag
    const { data: alleEvents, error: fetchError } = await client
      .from("events")
      .select("id, titel, start, slut");

    if (fetchError) {
      console.warn("‚ö†Ô∏è Kunne ikke hente events:", fetchError);
    } else {
      const dagStart = new Date(`${iso}T00:00:00`);
      const dagSlut = new Date(`${iso}T23:59:59`);

      const overlappendeLukkede = alleEvents.filter(ev => {
        const start = new Date(ev.start);
        const slut = ev.slut ? new Date(ev.slut) : start;

        const overlapper =
          slut >= dagStart && start <= dagSlut;

        return overlapper && ev.titel?.toLowerCase().startsWith("lukket");
      });

      for (const ev of overlappendeLukkede) {
        const { error: deleteError } = await client
          .from("events")
          .delete()
          .eq("id", ev.id);

        if (deleteError) {
          console.warn("‚ö†Ô∏è Kunne ikke slette lukket-event:", deleteError);
        }
      }
    }

    alert("‚úÖ Dagen er gen√•bnet og event fjernet!");
    gemAktivM√•nedOg√ÖrFraDato(dato);
    huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
  };

  tdHandling.appendChild(openBtn);
}


// === + OPRET BEGIVENHEDER ===
if (bruger.roller.includes("admin") || bruger.roller.includes("eventmaker")) {
  const plusBtn = document.createElement("button");
  plusBtn.textContent = "‚ûï";
  plusBtn.title = "Opret begivenhed";

  plusBtn.onclick = () => {
    √•bnEventModal(dato); // 'dato' er allerede defineret i loopet
  };

  tdHandling.appendChild(plusBtn);
}
	  
      tdDato.textContent = `${weekdays[dato.getDay()]} d. ${day}. ${months[month]}`;
      tdNavn.textContent = assignment?.navn || "";
      tdStatus.textContent = assignment?.status || "Ingen n√∏glevagt";

      // Farver og statusvisning
      if (assignment?.status === "lukket") {
        tdStatus.textContent = "üîí Lukket";
        tdStatus.style.color = "gray";
      } else if (assignment?.status === "tildelt") {
        tdStatus.textContent = "üîë Tildelt";
      }

// === BEGIVENHEDER ===
const dagsEvents = events.filter(ev => {
  const evStart = new Date(ev.start);
  const evSlut = ev.slut ? new Date(ev.slut) : evStart;
  evStart.setHours(0, 0, 0, 0);
  evSlut.setHours(0, 0, 0, 0);
  return dato >= evStart && dato <= evSlut;
});

dagsEvents.forEach(ev => {
  const evtDiv = document.createElement("div");
  evtDiv.textContent = `üìÖ ${ev.titel}`;
  evtDiv.style.cursor = "pointer";
  evtDiv.style.textDecoration = "underline dotted";
  evtDiv.addEventListener("click", () => {
  √•bnEventModal(ev);
});

  evtDiv.style.fontSize = "0.85em";
  evtDiv.style.color = "#333";

  if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    evtDiv.style.color = "#ccc";
  }

 
  tdEvents.appendChild(evtDiv);
});


      tr.appendChild(tdDato);
      tr.appendChild(tdNavn);
      tr.appendChild(tdStatus);
	  tr.appendChild(tdEvents); 
	  tr.appendChild(tdHandling);
      tbody.appendChild(tr);
    }



    content.appendChild(table);
  }


window.aktivEventId = null; 

function √•bnEventModal(forDatoEllerEvent) {
  const modal = document.getElementById("event-modal");
  const form = document.getElementById("event-form");
  const submitBtn = form.querySelector("button[type='submit']");
  const sletContainer = document.getElementById("event-slet-container");
  const overskrift = document.getElementById("event-modal-overskrift");

  form.reset();
  modal.style.display = "flex";

  const bruger = JSON.parse(localStorage.getItem("bruger"));
  const rolleSelect = document.getElementById("rolle-valg");
  rolleSelect.innerHTML = "";

  // Tilf√∏j eget navn
  const navnOption = document.createElement("option");
  navnOption.value = bruger.navn;
  navnOption.textContent = `${bruger.navn} (navn)`;
  rolleSelect.appendChild(navnOption);

  // Tilf√∏j roller
  (bruger.roller || []).forEach(rolle => {
    const option = document.createElement("option");
    option.value = rolle;
    option.textContent = `${rolle.charAt(0).toUpperCase() + rolle.slice(1)} (rolle)`;
    rolleSelect.appendChild(option);
  });

  // REDIGER BEGIVENHED
  if (forDatoEllerEvent && typeof forDatoEllerEvent === "object" && "id" in forDatoEllerEvent) {
    const ev = forDatoEllerEvent;
    form.titel.value = ev.titel || "";
    form.underrubrik.value = ev.underrubrik || "";
    form.beskrivelse.value = ev.beskrivelse || "";
    form.start.value = tilLocalDateTimeInput(new Date(ev.start));
    form.slut.value = ev.slut ? tilLocalDateTimeInput(new Date(ev.slut)) : "";
    form.lokation.value = ev.lokation || "";
    form.billede_url.value = ev.billede_url || "";
    form.max_deltagere.value = ev.max_deltagere || "";

    // Gem eksisterende opretter midlertidigt
    window.gammelOprettetAf = ev.oprettet_af;
    window.gammelOprettetAfVisning = ev.oprettet_af_visning;

    // Skjul dropdown for redigering
    rolleSelect.disabled = true;
    if (window.gammelOprettetAfVisning) {
      const opretterValg = document.createElement("option");
      opretterValg.value = window.gammelOprettetAfVisning;
      opretterValg.textContent = `${window.gammelOprettetAfVisning} (tidligere)`;
      opretterValg.selected = true;
      rolleSelect.appendChild(opretterValg);
    }

    window.aktivEventId = ev.id;
    submitBtn.textContent = "üíæ Opdater";
    overskrift.textContent = "‚úèÔ∏è Rediger begivenhed";
    sletContainer.style.display = "block";

    const dato = new Date(ev.start);
    gemAktivM√•nedOg√ÖrFraDato(dato);

    document.getElementById("slet-event-knap").onclick = async () => {
      if (!confirm("Er du sikker p√•, at du vil slette denne begivenhed?")) return;
      const { error } = await client.from("events").delete().eq("id", ev.id);
      if (error) {
        console.error("‚ùå Supabase-fejl:", error);
        alert("‚ùå Kunne ikke slette begivenhed.");
      } else {
        alert("üóëÔ∏è Begivenhed slettet!");
        lukEventModal();
        huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
      }
    };
  }

  // OPRET NY BEGIVENHED
  else {
    const dato = new Date(forDatoEllerEvent);
    dato.setMinutes(0, 0, 0, 0);
    form.start.value = tilLocalDateTimeInput(dato);

    // Ryd gemte opretter-info
    window.gammelOprettetAf = null;
    window.gammelOprettetAfVisning = null;

    rolleSelect.disabled = false;

    window.aktivEventId = null;
    submitBtn.textContent = "‚úÖ Opret";
    overskrift.textContent = "‚ûï Opret begivenhed";
    sletContainer.style.display = "none";

    gemAktivM√•nedOg√ÖrFraDato(dato);
  }
}


window.lukEventModal = function () {
  const modal = document.getElementById("event-modal");
  modal.style.display = "none";
};


document.getElementById("event-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const bruger = JSON.parse(localStorage.getItem("bruger"));

const data = {
  titel: form.titel.value.trim(),
  underrubrik: form.underrubrik.value.trim(),
  beskrivelse: form.beskrivelse.value.trim(),
  start: form.start.value,
  slut: form.slut.value || null,
  lokation: form.lokation.value.trim() || null,
  billede_url: form.billede_url.value.trim() || null,
  max_deltagere: form.max_deltagere.value ? parseInt(form.max_deltagere.value) : null,
  oprettet_af: window.gammelOprettetAf ?? bruger.id,
  oprettet_af_visning: window.gammelOprettetAfVisning ?? form.oprettet_af.value
};


  const query = client.from("events");

  const { error } = window.aktivEventId
  ? await query.update(data).eq("id", window.aktivEventId)
  : await query.insert(data);


  if (error) {
    console.error("‚ùå Supabase-fejl:", error);
    alert("‚ùå Kunne ikke oprette begivenhed.");
  } else {
    alert(window.aktivEventId ? "‚úÖ Begivenhed opdateret!" : "‚úÖ Begivenhed oprettet!");
    lukEventModal();
	const dato = new Date(form.start.value);
	gemAktivM√•nedOg√ÖrFraDato(dato);
	huskOgGenindl√¶s(dato.getMonth(), dato.getFullYear());
  }
});




</script>


<h2><center>üîë N√∏glevagtkalender & begivenheder </center></h2>

<div id="week-overview" style="margin-bottom: 1rem;"></div>

<div id="calendar"></div>

<!-- Modal til oprettelse af event -->
<div id="event-modal" class="modal" style="display:none;">
  <div class="modal-wrapper">
    <div class="modal-content">
      <h2 id="event-modal-overskrift">‚ûï Opret begivenhed</h2>
      <form id="event-form">
        <label>Titel: <input name="titel" required></label><br>
        <label>Underrubrik: <input name="underrubrik"></label><br>
        <label>Beskrivelse:<br><textarea name="beskrivelse" rows="4"></textarea></label><br>
        <label>Startdato og tid: <input type="datetime-local" name="start" required></label><br>
        <label>(valgfrit)Slutdato og tid: <input type="datetime-local" name="slut"></label><br>
        <label>(valgfrit)Lokation: <input name="lokation"></label><br>
        <label>(valgfrit)Billede URL: <input type="url" name="billede_url"></label><br>
        <label>(valgfrit)Max deltagere: <input type="number" name="max_deltagere"></label><br>
		
		<label>Opret som:
		<select name="oprettet_af" id="rolle-valg"></select>
		</label><br>
	
		<div id="event-slet-container" style="display:none; margin-top:1rem;">
		<button type="button" id="slet-event-knap" style="background:red; color:white;">üóëÔ∏è Slet begivenhed</button>
		</div>
		
	

        <button type="submit">‚úÖ Opret</button>
        <button type="button" onclick="lukEventModal()">Annuller</button>	
      </form>
    </div>
  </div>
</div>



</body>
</html>
