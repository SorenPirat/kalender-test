<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalender – NKL</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
</head>
<body>
  <h1>🧗 Begivenheder</h1>
  
<div id="event-modal" class="modal skjult">
  <div class="modal-box" id="modal-body-wrapper">
    <span class="luk" id="modal-close" onclick="lukModal()">❌</span>
    <div id="modal-body"></div>
  </div>
</div>

<div class ="kort">
<div id="filter-tags">
  <button data-filter="rutebyg" class="filter-tag aktiv">🛠️ Rutebyg</button>
  <button data-filter="konkurrence" class="filter-tag aktiv">🏆 Konkurrence</button>
  <button data-filter="social" class="filter-tag aktiv">🎉 Social</button>
  <button data-filter="lukket" class="filter-tag aktiv">🚪 Lukkedage</button>
  <button data-filter="andet" class="filter-tag aktiv">❓ Andet</button>

</div>
</div>
  
  <div id="event-container">Henter begivenheder...</div>

  <script type="module">
    import { adgangskontrol, indsætMenu, client } from './auth.js';

    let bruger = null;

    adgangskontrol({
      tilladteRoller: [],
      redirectVedFejl: "protected.html",
      efterLogin: async (b) => {
        bruger = b;
        indsætMenu(b);
        hentOgVisEvents();
      }
    });


function categorizeEvent(ev) {
  const text = `${ev.summary} ${ev.description}`.toLowerCase();
  if (text.includes("rutebyg")) return "rutebyg";
  if (text.includes("konkurrence")) return "konkurrence";
  if (text.includes("social") || text.includes("arrangement") || text.includes("hygge") || text.includes("hyggelig") || text.includes("tur") || text.includes("fællestur") || text.includes("fest")) return "social";
  if (text.includes("lukket") || text.includes("ferie") || text.includes("eksamen")) return "lukket";
  return "andet";
}

function applyFilter() {
  const aktive = Array.from(document.querySelectorAll(".filter-tag.aktiv"))
    .map(btn => btn.dataset.filter);

  document.querySelectorAll("#event-container .kort, .event-box").forEach(el => {
    const kategori = el.dataset.kategori || "lukket";
    el.style.display = aktive.includes(kategori) ? "" : "none";
  });
}

function findEmoji(titel, beskrivelse = "") {
  const text = `${titel} ${beskrivelse}`.toLowerCase();

  if (text.includes("rutebyg")) return "🛠️";
  if (text.includes("konkurrence") || text.includes("mesterskab")) return "🏆";
  if (text.includes("social") || text.includes("arrangement") || text.includes("hygge") || text.includes("hyggelig") || text.includes("tur") || text.includes("fællestur") || text.includes("fest")) return "🎉";
  if (text.includes("lukket") || text.includes("ferie") || text.includes("eksamen")) return "🚪";

  return "📌";
}

async function hentOgVisEvents() {
  const container = document.getElementById("event-container");
  container.innerHTML = "";


  try {
    const [{ data: events, error: eventsError }, { data: lukDage, error: lukError }] = await Promise.all([
      client.from("events").select("*").eq("offentlig", true).order("start", { ascending: true }),
      client.from("luk_dage").select("*").order("dato", { ascending: true })
    ]);

    if (eventsError || lukError) throw eventsError || lukError;

    const kombineret = [
      ...events.map(e => ({ type: "event", ...e })),
      ...lukDage.map(l => ({ type: "lukket", ...l }))
    ];

    kombineret.sort((a, b) => {
      const da = new Date(a.start || a.dato);
      const db = new Date(b.start || b.dato);
      return da - db;
    });

for (const entry of kombineret) {
  const kategori = entry.type === "lukket"
    ? "lukket"
    : categorizeEvent({ summary: entry.titel, description: entry.beskrivelse || "" });
  entry._kategori = kategori;
}

for (const entry of kombineret) {
  if (entry.type === "lukket") {
    const div = document.createElement("div");
    div.className = "event-box";
	div.dataset.kategori = "lukket";

    const dato = new Date(entry.dato).toLocaleDateString("da-DK");
    const strong = document.createElement("strong");
    strong.textContent = `🔒 Lukket: ${dato} – ${entry.årsag || 'Ukendt årsag'}`;
    div.appendChild(strong);
    container.appendChild(div);
  } else {
    const { data: tilmeldinger } = await client
      .from("event_tilmeldinger")
      .select("navn, bruger_id")
      .eq("event_id", entry.id);

    const emoji = findEmoji(entry.titel, entry.beskrivelse || "");
    const kortDiv = document.createElement("div");
    kortDiv.classList.add("kort");
	kortDiv.dataset.kategori = entry._kategori;
    kortDiv.style.cursor = "pointer";
		
    kortDiv.addEventListener("click", () => {
      window.openModal(entry, tilmeldinger);
    });

	const opretterNavn = entry.oprettet_af_visning || "Ukendt";

    const title = document.createElement("h3");
    title.innerHTML = `${emoji} <span class="event-title">${entry.titel}</span>`;
    kortDiv.appendChild(title);
	
	if (entry.billede_url) {
    const img = document.createElement("img");
    img.src = entry.billede_url;
    img.alt = "Event billede";
    img.className = "kort-preview";
    kortDiv.appendChild(img);
    }

    const start = new Date(entry.start);
    const slut = entry.slut ? new Date(entry.slut) : null;
    const danskDato = (d) =>
      d.toLocaleDateString("da-DK", { day: "numeric", month: "long", year: "numeric" });
    const sammeDag = slut && start.toDateString() === slut.toDateString();
	const datoText = slut
	? sammeDag
		? `${danskDato(start)} ${start.toLocaleTimeString("da-DK", { hour: "2-digit", minute: "2-digit" })} - ${slut.toLocaleTimeString("da-DK", { hour: "2-digit", minute: "2-digit" })}`
		: `Fra ${danskDato(start)} til ${danskDato(slut)}`
	: `Den ${danskDato(start)}`;


    const dato = document.createElement("p");
    dato.textContent = datoText;
    dato.style.fontSize = "0.85rem";
    dato.style.color = "#444;";
    kortDiv.appendChild(dato);

    if (entry.underrubrik) {
      const intro = document.createElement("p");
      intro.textContent = entry.underrubrik;
      kortDiv.appendChild(intro);
    }

	const erLukket = entry.titel.toLowerCase().startsWith("lukket");

	if (!erLukket) {
	const opretter = document.createElement("p");
	opretter.className = "opretter";
	opretter.innerHTML = `<i>Oprettet af: ${opretterNavn}</i>`;
	kortDiv.appendChild(opretter);
	}

    container.appendChild(kortDiv);
  }
}

applyFilter();

}
 catch (err) {
    console.error("❌ Fejl under hentning:", err);
    container.innerHTML = "<p style='color:red;'>❌ Kunne ikke hente data.</p>";
  }
}


window.openModal = (entry, tilmeldinger) => {
  const modal = document.getElementById("event-modal");
  const modalBody = document.getElementById("modal-body");
  modalBody.innerHTML = "";

  // 🔹 Titel
  const titel = document.createElement("h2");
  titel.textContent = entry.titel;
  modalBody.appendChild(titel);

  // Kort beskrivelse (underrubrik)
if (entry.underrubrik) {
  const kort = document.createElement("p");
  kort.textContent = entry.underrubrik;
  kort.style.fontStyle = "italic";
  kort.style.marginBottom = "1rem";
  modalBody.appendChild(kort);
}

// Billede hvis det findes
if (entry.billede_url) {
  const img = document.createElement("img");
  img.src = entry.billede_url;
  img.alt = "Event billede";
  img.style.maxWidth = "100%";
  img.style.borderRadius = "8px";
  img.style.marginBottom = "1rem";
  modalBody.appendChild(img);
}

// Lang beskrivelse (beskrivelse)
if (entry.beskrivelse) {
  const lang = document.createElement("p");
  lang.textContent = entry.beskrivelse;
  lang.style.whiteSpace = "pre-line"; // Bevar linjeskift
  modalBody.appendChild(lang);
}
	
  
// 🔹 INFO: tid, sted, ledige pladser
const start = new Date(entry.start);
const slut = entry.slut ? new Date(entry.slut) : null;

const danskDato = (d) =>
  d.toLocaleDateString("da-DK", { day: "numeric", month: "long", year: "numeric" });
const danskTid = (d) =>
  d.toLocaleTimeString("da-DK", { hour: "2-digit", minute: "2-digit" });

const sammeDag = slut && start.toDateString() === slut.toDateString();
const datoTekst = slut
  ? sammeDag
    ? `${danskDato(start)} kl. ${danskTid(start)} - ${danskTid(slut)}`
    : `Fra ${danskDato(start)} kl. ${danskTid(start)}<br>til ${danskDato(slut)} kl. ${danskTid(slut)}`
  : `Den ${danskDato(start)} kl. ${danskTid(start)}`;



  const infoboks = document.createElement("div");
  infoboks.classList.add("info-text");

const infoLinjer = [
  { ikon: "⏰", tekst: datoTekst },
  entry.lokation && { ikon: "📍", tekst: entry.lokation }
].filter(Boolean);

for (const linje of infoLinjer) {
  const p = document.createElement("p");
  p.classList.add("ikon-linje");
  p.innerHTML = `<span>${linje.ikon}</span> <span>${linje.tekst}</span>`;
  infoboks.appendChild(p);
}

// 👥 Tilmeldings-linje med fold-ud
if (entry.max_deltagere || tilmeldinger.length > 0) {
  const details = document.createElement("details");
  details.classList.add("ikon-linje");

  const summary = document.createElement("summary");
  summary.innerHTML = `<span>👥</span> <span>${
    entry.max_deltagere
      ? `${tilmeldinger.length} / ${entry.max_deltagere} tilmeldt`
      : `${tilmeldinger.length} tilmeldte`
  }</span>`;
  details.appendChild(summary);

  const ul = document.createElement("ul");
  ul.style.marginTop = "0.5rem";
  ul.style.paddingLeft = "1.5rem";
  ul.style.fontSize = "0.9rem";

  tilmeldinger.forEach(t => {
    const li = document.createElement("li");
    li.textContent = t.navn;
    ul.appendChild(li);
  });

  details.appendChild(ul);
  infoboks.appendChild(details);
}

  modalBody.appendChild(infoboks);

  // 🔹 Lang beskrivelse
  if (entry.lang_beskrivelse) {
    const beskrivelse = document.createElement("p");
    beskrivelse.textContent = entry.lang_beskrivelse;
    modalBody.appendChild(beskrivelse);
  }

  // 🔹 Deltagerliste
  const alleredeTilmeldt = tilmeldinger.some(t => t.bruger_id === bruger.id);
  const deltagerOverskrift = document.createElement("p");

  // 🔹 Tilmeld / frameld knap
  const knap = document.createElement("button");
  knap.classList.add("primary");
  knap.disabled = entry.max_deltagere && tilmeldinger.length >= entry.max_deltagere && !alleredeTilmeldt;
  knap.textContent = alleredeTilmeldt
    ? "❌ Frameld mig"
    : (knap.disabled ? "🚫 Fuldt booket" : "✅ Tilmeld mig");

  knap.onclick = async () => {
    knap.disabled = true;
    await window.toggleTilmelding(entry.id, alleredeTilmeldt);
    const { data: nyeTilmeldinger } = await client
      .from("event_tilmeldinger")
      .select("navn, bruger_id")
      .eq("event_id", entry.id);
    window.openModal(entry, nyeTilmeldinger);
  };

  const erLukket = entry.titel.toLowerCase().startsWith("lukket");

if (!erLukket) {
  modalBody.appendChild(knap);
}

  modal.classList.remove("skjult");
};

window.toggleTilmelding = async (eventId, erTilmeldt) => {
  try {
    if (erTilmeldt) {
      await client
        .from("event_tilmeldinger")
        .delete()
        .eq("event_id", eventId)
        .eq("bruger_id", bruger.id);
    } else {
      await client
        .from("event_tilmeldinger")
        .insert({
          event_id: eventId,
          bruger_id: bruger.id,
          navn: bruger.navn,
          tilmeldt: new Date().toISOString()
        });
    }

    hentOgVisEvents();
  } catch (err) {
    console.error("❌ Fejl ved (fram)tilmelding:", err);
    alert("Der opstod en fejl ved tilmelding.");
  }
};

// Luk-modal knappen
window.lukModal = function () {
  document.getElementById("event-modal").classList.add("skjult");
};

// Filter knapper
document.querySelectorAll(".filter-tag").forEach(btn => {
  btn.addEventListener("click", () => {
    btn.classList.toggle("aktiv");
    applyFilter();
  });
});




  </script>
</body>
</html>
