<!DOCTYPE html>
<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üèÜ Leaderboard ‚Äì NKL</title>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="/css/animation.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h1>üèÜ Leaderboard</h1>

  <section class="kort" style="max-width:900px;">
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
      <label>
        <select id="periode">
          <option value="all">Alle</option>
          <option value="30">Sidste 30 dage</option>
          <option value="7">Sidste 7 dage</option>
        </select>
      </label>
    </div>

    <div id="status" style="margin-top:.75rem;"></div>

    <div style="overflow:auto; margin-top:1rem;">
      <table id="lb-tabel" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">#</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Navn</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Ruter/problemer</th>
          </tr>
        </thead>
        <tbody id="lb-body">
          <tr><td colspan="3" style="padding:.75rem;">Indl√¶ser‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<script type="module">
  import { client, adgangskontrol, inds√¶tMenu } from './auth.js';

  adgangskontrol({
    tilladteRoller: [],
    redirectVedFejl: "index.html",
    efterLogin: async (bruger) => {
      if (window.releaseAuthGate) window.releaseAuthGate();
      inds√¶tMenu(bruger);
      await visLeaderboard();
    }
  });

  const statusEl = document.getElementById('status');
  const tbody    = document.getElementById('lb-body');
  const periodeEl= document.getElementById('periode');
  
  periodeEl.addEventListener('change', () => {
  visLeaderboard();
});

  function afgr√¶nsDato(v) {
    if (v === 'all') return null;
    const d = new Date(); d.setDate(d.getDate() - parseInt(v,10)); return d;
  }

async function visLeaderboard() {

  statusEl.textContent = "‚è≥ Henter data...";
  tbody.innerHTML = `<tr><td colspan="3" style="padding:.75rem;">Indl√¶ser‚Ä¶</td></tr>`;

  // Periodefilter (server-side p√• logget_dato)
  const v = periodeEl.value; // "all" | "30" | "7"
  let q = client.from('rutelog').select('user_id, logget_dato');

  if (v !== 'all') {
    const dage = parseInt(v, 10);
    const d = new Date();
    d.setDate(d.getDate() - dage);
    // ISO uden ms
    const iso = d.toISOString().replace(/\.\d{3}Z$/, 'Z');
    q = q.gte('logget_dato', iso);
  }

  const { data: logs, error: logErr } = await q;
  if (logErr) {
    console.error(logErr);
    statusEl.textContent = "‚ùå Kunne ikke hente rutelog.";
    return;
  }

  // Opt√¶l pr. user_id
  const counts = new Map();
  for (const l of logs || []) {
    if (!l.user_id) continue;
    counts.set(l.user_id, (counts.get(l.user_id) || 0) + 1);
  }

  if (counts.size === 0) {
    statusEl.textContent = "";
    tbody.innerHTML = `<tr><td colspan="3" style="padding:.75rem;">Ingen logs i valgt periode.</td></tr>`;
    return;
  }

// Hent navne + deltagelsesflag
const ids = Array.from(counts.keys());
const { data: users, error: userErr } = await client
  .from('users')
  .select('id, navn, leaderboard_deltagelse') // <-- tilf√∏jet igen
  .in('id', ids);

if (userErr) {
  console.error(userErr);
  statusEl.textContent = "‚ùå Kunne ikke hente brugernavne.";
  return;
}

// Kun dem der deltager (leaderboard_deltagelse !== false)
const deltagere = (users || []).filter(u => u.leaderboard_deltagelse !== false);

// Map id -> navn
const navnMap = new Map(deltagere.map(u => [u.id, u.navn || `Medlem ${u.id}`]));

// Behold kun ids som b√•de har logs og deltager
const visibleIds = ids.filter(id => navnMap.has(id));

if (visibleIds.length === 0) {
  statusEl.textContent = "";
  tbody.innerHTML = `<tr><td colspan="3" style="padding:.75rem;">Ingen deltagere i valgt periode.</td></tr>`;
  return;
}

const rows = visibleIds
  .map(id => ({
    id,
    navn: navnMap.get(id),
    antal: counts.get(id) || 0
  }))
  .sort((a, b) => b.antal - a.antal);

  statusEl.textContent = "";
  tbody.innerHTML = rows.map((r, i) => {
    const medalje = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
    return `
      <tr data-user-id="${r.id}">
        <td style="padding:.5rem; border-bottom:1px solid #eee;">${i + 1}</td>
        <td style="padding:.5rem; border-bottom:1px solid #eee;">${medalje} ${r.navn}</td>
        <td style="padding:.5rem; border-bottom:1px solid #eee;">${r.antal}</td>
      </tr>
    `;
  }).join("");

  // find nuv√¶rende bruger og pynt r√¶kken
  const ls = JSON.parse(localStorage.getItem('bruger') || '{}');
  const myRow = ls?.id ? tbody.querySelector(`tr[data-user-id="${ls.id}"]`) : null;

  if (myRow) {
    myRow.classList.add('min-raekke');

    // f√∏rste b√∏lge
    launchConfetti(myRow, 28);
    launchFireworks(myRow, { bursts: 1, particles: 18 });

    // gentag kort efter
    setTimeout(() => {
      launchConfetti(myRow, 28);
      launchFireworks(myRow, { bursts: 1, particles: 20, spread: 70, upOffset: -10 });
    }, 1000);
  }

  // ---------- Effekter (samme scope) ----------

  function launchConfetti(row, count = 24) {
    const nameCell = row.querySelector('td:nth-child(2)');
    if (!nameCell) return;

    const rect = nameCell.getBoundingClientRect();
    const centerX = rect.left + window.scrollX + rect.width / 2;
    const centerY = rect.top + window.scrollY + rect.height / 2;

    for (let i = 0; i < count; i++) {
      const p = document.createElement('span');
      p.className = 'confetti';

      // farver ‚Äî skift til jeres palette hvis √∏nsket
      p.style.background = ['#007bff','#10b981','#f59e0b','#ef4444','#8b5cf6','#36A2EB'][i % 6];

      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random() * 120;
      const dx = Math.cos(angle) * dist + 'px';
      const dy = Math.sin(angle) * dist + 40 + 'px';
      const rot = (Math.random() * 360 - 180) + 'deg';

      p.style.setProperty('--dx', dx);
      p.style.setProperty('--dy', dy);
      p.style.setProperty('--rot', rot);

      p.style.left = centerX + 'px';
      p.style.top  = centerY + 'px';
      p.style.zIndex = 1000;

      document.body.appendChild(p);

      setTimeout(() => p.remove(), 1500); // lidt l√¶ngere end CSS varighed
    }
  }

  function launchFireworks(row, opts = {}) {
    const {
      bursts = 1,          // hvor mange eksplosioner
      particles = 16,      // gnister pr. eksplosion
      spread = 55,         // udspringsradius i px
      upOffset = -20,      // ryk eksplosion lidt op
      hueBase = 210        // basisfarve (210 ~ bl√•lig)
    } = opts;

    const nameCell = row.querySelector('td:nth-child(2)');
    if (!nameCell) return;

    const rect = nameCell.getBoundingClientRect();
    const centerX = rect.left + window.scrollX + rect.width / 2;
    const centerY = rect.top  + window.scrollY + rect.height / 2 + upOffset;

    for (let b = 0; b < bursts; b++) {
      // core flash
      const core = document.createElement('span');
      core.className = 'fw-core';
      core.style.left = centerX + 'px';
      core.style.top  = (centerY - b * 8) + 'px';
      document.body.appendChild(core);
      setTimeout(() => core.remove(), 700);

      // gnister
      for (let i = 0; i < particles; i++) {
        const spark = document.createElement('span');
        spark.className = 'fw-spark';

        const hue = hueBase + (Math.random() * 120 - 60);
        spark.style.background = `hsl(${Math.round(hue)} 90% 55%)`;

        const angle = (i / particles) * Math.PI * 2 + Math.random() * 0.2;
        const dist  = spread + Math.random() * (spread * 1.6);
        const dx    = Math.cos(angle) * dist + 'px';
        const dy    = Math.sin(angle) * dist + 'px';
        const rot   = (Math.random() * 360 - 180) + 'deg';

        spark.style.setProperty('--sx', dx);
        spark.style.setProperty('--sy', dy);
        spark.style.setProperty('--rot', rot);

        spark.style.left = centerX + 'px';
        spark.style.top  = (centerY - b * 8) + 'px';
        spark.style.zIndex = 1001;

        document.body.appendChild(spark);

        setTimeout(() => spark.remove(), 1300);
      }
    }
  }
}

  
</script>

</body>
</html>
