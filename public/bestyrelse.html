<!doctype html>
<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestyrelsesdokumenter – NKL</title>

  <!-- CSS -->
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="bestyrelse.css" />

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>

  <!-- Kontekstmenuer -->
  <ul id="context-menu" class="skjult">
    <li id="ny-mappe-valg">➕ Opret ny mappe</li>
    <li id="slet-mappe-valg">🗑️ Slet mappe</li>
    <li id="omdoeb-mappe-valg">✏️ Omdøb mappe</li>
  </ul>
  <ul id="file-context-menu" class="skjult">
    <li id="slet-fil-valg">🗑️ Slet fil</li>
    <li id="omdoeb-fil-valg">✏️ Omdøb fil</li>
    <li id="download-fil-valg">⬇️ Download</li>
  </ul>

  <!-- Modal: billed-preview -->
  <div id="preview-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold">
      <button id="luk-modal" class="luk" title="Luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <img id="preview-billede" alt="Preview" />
      <div class="modal-knap-wrapper">
        <button id="download-knap" class="knap-vis" type="button">⬇️ Download billede</button>
      </div>
    </div>
  </div>

  <!-- Modal: gdocs/pdf -->
  <div id="gdocs-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold">
      <button class="luk" id="gdocs-luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <iframe id="gdocs-frame"></iframe>
      <div class="modal-knap-wrapper">
        <button id="gdocs-download-knap" class="knap-vis" type="button">⬇️ Download dokument</button>
      </div>
    </div>
  </div>

  <!-- Modal: Excel -->
  <div id="excel-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold" style="overflow:auto; max-height:90vh;">
      <button class="luk" id="excel-luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <select id="arkvælger" style="margin:1rem 0; padding:.4rem;"></select>
      <div id="excel-output"></div>
    </div>
  </div>

  <!-- Sektion-knapper -->
<div id="sektion-knapper">
  <button onclick="visSektion('dokumenter')">📂 Bestyrelsens dokumenter</button>
  <button onclick="visSektion('statistik')">📊 Statistik</button>
  <button onclick="visSektion('aarshjul')">🗓️ Årshjul</button>
</div>


  <!-- Sektion: Dokumenter -->
  <div id="sektion-dokumenter" class="sektion">
    <h1>📁 Bestyrelsens dokumenter</h1>
    <div id="dokument-sektioner"></div>
  </div>

  <!-- Sektion: Statistik -->
  <div id="sektion-statistik" class="sektion skjult">
    <h1>📊 Bestyrelsens statistik</h1>
    <div id="statistik-knapper">
      <button id="rolle-knap" class="btn-sub" type="button">👥 Rollefordeling</button>
      <button id="begivenhed-knap" class="btn-sub" type="button">📅 Begivenheder pr. måned</button>
      <button id="kategori-knap" class="btn-sub" type="button">📂 Begivenheder pr. kategori</button>
    </div>
    <div class="chart-container">
      <canvas id="statistik-chart"></canvas>
    </div>
  </div>

  <!-- Sektion: Årshjul -->
  <div id="sektion-aarshjul" class="sektion skjult">
    <h1>🗓️ Bestyrelsens årshjul</h1>
    <div class="aarshjul-toolbar">
      <label>År: <select id="aarshjul-year"></select></label>
      <input id="aarshjul-search" type="search" placeholder="Søg i titel, beskrivelse eller lokation…" />
    </div>
    <div class="aarshjul-layout">
      <div class="aarshjul-canvas" aria-label="Årshjul med 12 måneder" role="group"></div>
      <div class="aarshjul-panel">
        <h2 id="aarshjul-panel-overskrift">Vælg en måned</h2>
		<button id="aarshjul-add-btn" class="btn-sub" type="button">➕ Tilføj post</button>
<div id="aarshjul-add-form" class="skjult">
  <input type="text" id="aarshjul-add-title" placeholder="Titel" required>
  <textarea id="aarshjul-add-desc" placeholder="Beskrivelse"></textarea>
  <input type="text" id="aarshjul-add-ansvar" placeholder="Ansvar">
  <button id="aarshjul-add-save" type="button">Gem</button>
</div>	
        <ul id="aarshjul-liste" class="aarshjul-liste"></ul>
        <div id="aarshjul-empty" class="aarshjul-empty skjult">Ingen events i denne måned.</div>
      </div>
    </div>
  </div>

  <!-- App script -->
  <script type="module">
    import { adgangskontrol, indsætMenu, client } from './auth.js';

    // ---------- Helpers (DOM) ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const bucketNavn = "bestyrelse";

function visSektion(navn) {
  // Skjul alle sektioner
  document.querySelectorAll(".sektion").forEach(s => s.classList.add("skjult"));

  // Vis den valgte
  const valgt = document.getElementById("sektion-" + navn);
  if (valgt) {
    valgt.classList.remove("skjult");
  }

  // Lazy-load dokumenter
if (navn === "dokumenter") {
  const cont = document.getElementById("dokument-sektioner");
  if (!cont || cont.childElementCount === 0) {
    Promise.resolve()
      .then(() => visMapper())
      .then(() => gørMapperOgFilerTrækbare())
      .catch(console.error);
  }
}

  // Aktiv knap styling
  document.querySelectorAll("#sektion-knapper button").forEach(knap => knap.classList.remove("aktiv"));
  const aktivKnap = [...document.querySelectorAll("#sektion-knapper button")]
    .find(knap => knap.getAttribute("onclick").includes(navn));
  if (aktivKnap) aktivKnap.classList.add("aktiv");
}

    // ---------- Storage: ikon ----------
    function filtypeIkon(filnavn){
      const ext = (filnavn.split('.').pop()||"").toLowerCase();
      if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "🖼️";
      if(["pdf"].includes(ext)) return "📕";
      if(["doc","docx"].includes(ext)) return "📄";
      if(["xls","xlsx","csv","xlsm","xlsb"].includes(ext)) return "📊";
      if(["ppt","pptx"].includes(ext)) return "📽️";
      if(["zip","rar"].includes(ext)) return "🗜️";
      if(["txt"].includes(ext)) return "📃";
      return "📁";
    }

    // ---------- Storage: vis mapper ----------
    async function hentMapper(bucket){
      const { data, error } = await client.storage.from(bucket).list("", { limit:100 });
      if(error){ console.error(error); return []; }
      return (data||[]).filter(item => !item.name.includes('.') && item.metadata===null);
    }

    async function visMapper(){
      const container = $("#dokument-sektioner");
      container.innerHTML = "";
      const mapper = await hentMapper(bucketNavn);
      for(const mappe of mapper){
        const wrap = document.createElement("div");
        wrap.className = "mappe";

        const head = document.createElement("div");
        head.className = "mappe-header";
        head.textContent = `📁 ${mappe.name}`;
        head.addEventListener("click", ()=>toggleMappe(mappe.name, wrap));

        // dnd upload
        head.addEventListener("dragover", e=>{ e.preventDefault(); head.classList.add("highlight"); });
        head.addEventListener("dragleave", ()=> head.classList.remove("highlight"));
        head.addEventListener("drop", (e)=> onDropUpload(e, mappe.name, head));

        wrap.appendChild(head);
        container.appendChild(wrap);
      }
    }

    async function onDropUpload(e, destinationMappe, headEl){
      e.preventDefault(); headEl.classList.remove("highlight");
      const filer = e.dataTransfer.files;
      if(!filer || !filer.length) return;

      for(const fil of filer){
        let filnavn = fil.name;
        filnavn = filnavn
          .replace(/æ/g,"ae").replace(/ø/g,"oe").replace(/å/g,"aa")
          .replace(/Æ/g,"Ae").replace(/Ø/g,"Oe").replace(/Å/g,"Aa");
        const uploadSti = `${destinationMappe}/${filnavn}`;
        let { error } = await client.storage.from(bucketNavn).upload(uploadSti, fil, { upsert:false });
        if(error && error.message.includes("already exists")){
          const overskriv = confirm(`Filen findes allerede.\nOverskriv?`);
          if(overskriv){
            ({ error } = await client.storage.from(bucketNavn).upload(uploadSti, fil, { upsert:true }));
          }
        }
        if(error){ alert(`Upload-fejl: ${error.message}`); console.error(error); }
      }
      await visMapper();
    }

    async function toggleMappe(sti, wrapperEl){
      let indhold = wrapperEl.querySelector(".mappe-indhold");
      if(indhold){ indhold.remove(); return; }

      const { data, error } = await client.storage.from(bucketNavn).list(sti, { limit:100 });
      if(error){ console.error(error); return; }

      indhold = document.createElement("div");
      indhold.className = "mappe-indhold";

      for(const item of (data||[])){
        const fuldSti = `${sti}/${item.name}`.replace(/\/+/g,"/");
        const skip = [".emptyFolderPlaceholder",".DS_Store","thumbs.db"];
        if(!item.name || skip.includes(item.name)) continue;

        if(item.metadata===null && !item.name.includes('.')){
          // undermappe
          const div = document.createElement("div");
          div.className = "mappe";
          const head = document.createElement("div");
          head.className = "mappe-header";
          head.textContent = `📁 ${item.name}`;
          head.addEventListener("click", ()=>toggleMappe(fuldSti, div));
          head.addEventListener("dragover", e=>{ e.preventDefault(); head.classList.add("highlight"); });
          head.addEventListener("dragleave", ()=> head.classList.remove("highlight"));
          head.addEventListener("drop", (e)=> onDropUpload(e, fuldSti, head));
          div.appendChild(head);
          indhold.appendChild(div);
        }else{
          // fil
          const { data:signed } = await client.storage.from(bucketNavn).createSignedUrl(fuldSti, 3600);
          const erBillede = /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name);
          const erExcel   = /\.(xlsx?|csv|xlsm|xlsb)$/i.test(item.name);
          const erGdoc    = /\.(docx?|pdf|pptx?|txt)$/i.test(item.name);

          const row = document.createElement("div");
          row.className = "fil-linje";
          const label = document.createElement("span");
          label.style.cursor = "pointer";
          label.textContent = `${filtypeIkon(item.name)} ${item.name}`;

          if(erBillede) label.onclick = ()=> visModal(signed.signedUrl, fuldSti);
          else if(erExcel) label.onclick = ()=> visExcelModal(signed.signedUrl);
          else if(erGdoc) label.onclick = ()=> visGdocsModal(signed.signedUrl, fuldSti);
          else label.onclick = ()=> window.open(signed?.signedUrl || "#", "_blank");

          const menuKnap = document.createElement("button");
          menuKnap.type="button";
          menuKnap.className="slet-knap";
          menuKnap.textContent = "⋮";
          menuKnap.title = "Flere handlinger";
          menuKnap.onclick = (e)=>{
            e.preventDefault(); e.stopPropagation();
            højreklikFilsti = fuldSti;
            visMenuUdenforKant($("#file-context-menu"), e.pageX, e.pageY);
            $("#file-context-menu").classList.remove("skjult");
          };

          row.appendChild(label);
          row.appendChild(menuKnap);
          indhold.appendChild(row);
        }
      }

      wrapperEl.appendChild(indhold);
    }

    // ---------- Modal helpers ----------
    function visMenuUdenforKant(menuEl, x, y){
      menuEl.classList.remove("skjult");
      const { innerWidth:w, innerHeight:h } = window;
      const mw = menuEl.offsetWidth || 160;
      const mh = menuEl.offsetHeight || 80;
      let left = x, top = y;
      if(x + mw > w) left = w - mw - 10;
      if(y + mh > h) top = h - mh - 10;
      menuEl.style.left = `${left}px`;
      menuEl.style.top  = `${top}px`;
    }
    function lukModal(){
      $("#preview-modal")?.classList.add("skjult");
      $("#preview-billede").src = "";
    }
    async function tvungenDownload(path, filnavn="fil"){
      const { data, error } = await client.storage.from(bucketNavn).download(path);
      if(error||!data){ alert("Kunne ikke hente filen"); return; }
      const url = URL.createObjectURL(data);
      const a = document.createElement("a");
      a.href = url; a.download = filnavn; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function visModal(url, path){
      $("#gdocs-modal")?.classList.add("skjult");
      $("#gdocs-frame").src = "";
      $("#preview-billede").src = url;
      $("#download-knap").onclick = ()=> tvungenDownload(path, path.split("/").pop());
      $("#preview-modal").classList.remove("skjult");
    }
    window.visGdocsModal = function(signedUrl, filsti){
      $("#preview-modal")?.classList.add("skjult");
      $("#preview-billede").src = "";
      $("#gdocs-modal").classList.remove("skjult");
      const gviewUrl = `https://docs.google.com/gview?url=${encodeURIComponent(signedUrl)}&embedded=true`;
      setTimeout(()=> { $("#gdocs-frame").src = gviewUrl; }, 50);
      $("#gdocs-download-knap").onclick = ()=> tvungenDownload(filsti, filsti.split("/").pop());
    };
    window.lukGdocsModal = function(){
      $("#gdocs-frame").src = "";
      $("#gdocs-modal").classList.add("skjult");
    };
    window.visExcelModal = async function(signedUrl){
      const res = await fetch(signedUrl); const blob = await res.blob();
      const reader = new FileReader();
      reader.onload = function(e){
        const wb = XLSX.read(new Uint8Array(e.target.result), { type:"array" });
        const sel = $("#arkvælger"); sel.innerHTML = "";
        wb.SheetNames.forEach((navn, i)=>{
          const opt = document.createElement("option");
          opt.value = navn; opt.textContent = navn; if(i===0) opt.selected = true; sel.appendChild(opt);
        });
        const visArk = (navn)=>{
          const sheet = wb.Sheets[navn];
          $("#excel-output").innerHTML = XLSX.utils.sheet_to_html(sheet);
        };
        visArk(wb.SheetNames[0]);
        sel.onchange = ()=> visArk(sel.value);
        $("#excel-modal").classList.remove("skjult");
      };
      reader.readAsArrayBuffer(blob);
    };
    window.lukExcelModal = function(){
      $("#excel-output").innerHTML = "";
      $("#excel-modal").classList.add("skjult");
    };

    // ---------- Højreklik + keyboard ESC ----------
    let højreklikFilsti = "", højreklikSti = "";
    document.addEventListener("click", ()=>{
      $("#context-menu")?.classList.add("skjult");
      $("#file-context-menu")?.classList.add("skjult");
    });
    document.addEventListener("contextmenu", (e)=>{
      const el = e.target.closest(".mappe-header");
      if(el){
        e.preventDefault();
        højreklikSti = el.textContent.replace("📁","").trim();
        $("#file-context-menu")?.classList.add("skjult");
        visMenuUdenforKant($("#context-menu"), e.pageX, e.pageY);
        $("#context-menu").classList.remove("skjult");
      }
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Escape") return;
      $("#context-menu")?.classList.add("skjult");
      $("#file-context-menu")?.classList.add("skjult");
      $("#gdocs-modal") && !$("#gdocs-modal").classList.contains("skjult") && window.lukGdocsModal();
      $("#excel-modal") && !$("#excel-modal").classList.contains("skjult") && window.lukExcelModal();
      $("#preview-modal") && !$("#preview-modal").classList.contains("skjult") && lukModal();
    });

    // Menupunkter (sikre bindinger)
    $("#ny-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      const navn = prompt(`Navn på ny mappe i "${højreklikSti || ''}":`);
      if(!navn) return;
      const sti = højreklikSti ? `${højreklikSti}/${navn.trim()}` : navn.trim();
      const placeholderPath = `${sti}/.emptyFolderPlaceholder`;
      const { error } = await client.storage.from(bucketNavn).upload(placeholderPath, new Blob([""]), { upsert:false });
      if(error) alert("Kunne ikke oprette mappen: " + error.message);
      await visMapper();
    });
    $("#slet-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      if(!højreklikSti) return;
      if(!confirm(`Slet mappen "${højreklikSti}" og alt indhold?`)) return;
      async function hentFiler(path, acc=[]){
        const { data } = await client.storage.from(bucketNavn).list(path, { limit:100 });
        for(const item of (data||[])){
          const fuldSti = `${path}/${item.name}`;
          if(item.metadata===null && !item.name.includes(".")) await hentFiler(fuldSti, acc);
          else acc.push(fuldSti);
        }
        return acc;
      }
      const filer = await hentFiler(højreklikSti);
      if(filer.length===0) filer.push(`${højreklikSti}/.emptyFolderPlaceholder`);
      const { error } = await client.storage.from(bucketNavn).remove(filer);
      if(error) alert("Kunne ikke slette mappen");
      await visMapper();
    });
    $("#omdoeb-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      if(!højreklikSti) return;
      let nytnavn = prompt(`Omdøb mappen "${højreklikSti}" til:`);
      if(!nytnavn) return;
      async function hentFiler(path, acc=[]){
        const { data } = await client.storage.from(bucketNavn).list(path, { limit:100 });
        for(const item of (data||[])){
          const fuldSti = `${path}/${item.name}`;
          if(item.metadata===null && !item.name.includes(".")) await hentFiler(fuldSti, acc);
          else acc.push(fuldSti);
        }
        return acc;
      }
      const filer = await hentFiler(højreklikSti);
      if(filer.length===0) filer.push(`${højreklikSti}/.emptyFolderPlaceholder`);
      const dele = højreklikSti.split("/"); dele.pop();
      const nyStiBase = [...dele, nytnavn.trim()].join("/");
      for(const gammel of filer){
        const relativ = gammel.slice(højreklikSti.length + 1);
        const nyPath = `${nyStiBase}/${relativ}`;
        const { error } = await client.storage.from(bucketNavn).move(gammel, nyPath);
        if(error){ alert("Kunne ikke omdøbe alt"); break; }
      }
      await visMapper();
    });

    $("#slet-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!højreklikFilsti) return;
      if(!confirm(`Slet filen "${højreklikFilsti.split("/").pop()}"?`)) return;
      const { error } = await client.storage.from(bucketNavn).remove([højreklikFilsti]);
      if(error) alert("Fejl ved sletning");
      await visMapper();
      højreklikFilsti = "";
    });
    $("#omdoeb-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!højreklikFilsti) return;
      const gammelt = højreklikFilsti.split("/").pop();
      const base = højreklikFilsti.split("/").slice(0,-1).join("/");
      const nyt = prompt(`Omdøb filen "${gammelt}" til:`, gammelt);
      if(!nyt || nyt===gammelt) return;
      const nySti = `${base}/${nyt.trim()}`;
      const { error } = await client.storage.from(bucketNavn).move(højreklikFilsti, nySti);
      if(error) alert("Kunne ikke omdøbe filen");
      await visMapper();
      højreklikFilsti = "";
    });
    $("#download-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!højreklikFilsti) return;
      const filnavn = højreklikFilsti.split("/").pop();
      const { data, error } = await client.storage.from(bucketNavn).download(højreklikFilsti);
      if(error||!data){ alert("Kunne ikke hente filen"); return; }
      const url = URL.createObjectURL(data);
      const a = document.createElement("a"); a.href=url; a.download=filnavn; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      højreklikFilsti = "";
    });

    // Luk modaler
    $("#luk-modal")?.addEventListener("click", lukModal);
    $("#preview-modal")?.addEventListener("click", (e)=>{ if(e.target.id==="preview-modal") lukModal(); });
    $("#gdocs-luk")?.addEventListener("click", ()=> window.lukGdocsModal());
    $("#excel-luk")?.addEventListener("click", ()=> window.lukExcelModal());

    // ---------- Statistik ----------
    let chartInstance = null;
    function renderChart(config){
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart($("#statistik-chart"), { ...config, plugins:[ChartDataLabels] });
    }
    async function visRolleStatistik(){
      try{
        const { data, error } = await client.from("users").select("rolle");
        if(error) throw error;
        const rolles = {};
        (data||[]).forEach(b=>{
          const rs = Array.isArray(b.rolle)? b.rolle : [b.rolle];
          rs.forEach(r=> rolles[r] = (rolles[r]||0)+1);
        });
        renderChart({
          type:"pie",
          data:{ labels:Object.keys(rolles), datasets:[{ data:Object.values(rolles) }] },
          options:{ responsive:true, plugins:{ legend:{position:"bottom"}, title:{display:true, text:"👥 Rollefordeling i klubben"}, datalabels:{ color:"#fff", font:{weight:"bold", size:14}, formatter:v=>v } } }
        });
      }catch(e){ alert("Kunne ikke hente rolledata."); console.error(e); }
    }
    async function visBegivenhedsStatistik(){
      const res = await fetch("https://nglevagter-test.onrender.com/public-events");
      const events = await res.json();
      const by = {};
      (events||[]).forEach(ev=>{
        const d = new Date(ev.start || ev.end);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        by[key] = (by[key]||0)+1;
      });
      renderChart({
        type:"bar",
        data:{ labels:Object.keys(by).sort(), datasets:[{ label:"Begivenheder pr. måned", data:Object.values(by) }] },
        options:{ responsive:true, plugins:{ legend:{display:false}, title:{display:true, text:"📅 Begivenheder pr. måned"}, datalabels:{ color:"#000", font:{weight:"bold", size:14}, formatter:v=>v } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }
    async function visBegivenhedsEfterKategori(){
      const res = await fetch("https://nglevagter-test.onrender.com/public-events");
      const events = await res.json();
      const k = { "🛠️ Rutebygning":0, "🏆 Konkurrence":0, "🎉 Socialt":0, "🚪 Lukkedag":0, "❓ Andet":0 };
      (events||[]).forEach(ev=>{
        const t = (ev.summary||ev.title||ev.short||"").toLowerCase();
        if(t.includes("rutebyg")) k["🛠️ Rutebygning"]++;
        else if(t.includes("konkurrence")||t.includes("mesterskab")) k["🏆 Konkurrence"]++;
        else if(t.includes("grill")||t.includes("hygge")||t.includes("tur")||t.includes("fælles")) k["🎉 Socialt"]++;
        else if(t.includes("lukket")||t.includes("closed")) k["🚪 Lukkedag"]++;
        else k["❓ Andet"]++;
      });
      renderChart({
        type:"bar",
        data:{ labels:Object.keys(k), datasets:[{ data:Object.values(k) }] },
        options:{ responsive:true, plugins:{ legend:{display:false}, title:{display:true, text:"📂 Begivenheder fordelt på kategori"}, datalabels:{ color:"#000", font:{weight:"bold", size:14}, formatter:v=>v } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }

    // ---------- Årshjul ----------
    const MONTHS_DA = ["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];
    let aarshjulState = { rawEvents:[], filteredEvents:[], eventsByMonth:new Map(), selectedMonth:null, selectedYear:new Date().getFullYear(), searchQuery:"" };

    function parseMaybeDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)? null : d; }
    function monthIndexFromDate(d){ return d?.getMonth?.() ?? null; }

    async function fetchAarshjulEvents(year){
      const from = `${year-1}-11-01`, to = `${year+1}-01-31`;
      const { data, error } = await client
        .from("events")
        .select("id,titel,underrubrik,beskrivelse,start,slut,lokation,offentlig,created_at")
        .gte("start", from)
        .lte("start", to)
        .order("start", { ascending:true });
      if(error){ console.error("Årshjul:", error); return []; }
      return (data||[]).map(ev=>({
        id:ev.id, titel:ev.titel||"(uden titel)", underrubrik:ev.underrubrik||"", beskrivelse:ev.beskrivelse||"",
        start:parseMaybeDate(ev.start), slut:parseMaybeDate(ev.slut), lokation:ev.lokation||"", offentlig:ev.offentlig ?? true
      }));
    }
    function filterAndIndex(){
      const year = aarshjulState.selectedYear;
      const q = aarshjulState.searchQuery.trim().toLowerCase();
      const filtered = aarshjulState.rawEvents.filter(ev=>{
        const inYear = (ev.start && ev.start.getFullYear()===year) || (ev.slut && ev.slut.getFullYear()===year);
        if(!inYear) return false;
        if(!q) return true;
        const hay = `${ev.titel} ${ev.underrubrik} ${ev.beskrivelse} ${ev.lokation}`.toLowerCase();
        return hay.includes(q);
      });
      aarshjulState.filteredEvents = filtered;
      const map = new Map(Array.from({length:12},(_,i)=>[i,[]]));
      filtered.forEach(ev=>{ const m=monthIndexFromDate(ev.start||ev.slut); if(m!=null) map.get(m).push(ev); });
      aarshjulState.eventsByMonth = map;
    }
    function donutSlicePath(cx,cy,r0,r1,a0,a1){
      const p0x = cx + r1*Math.cos(a0), p0y = cy + r1*Math.sin(a0);
      const p1x = cx + r1*Math.cos(a1), p1y = cy + r1*Math.sin(a1);
      const q0x = cx + r0*Math.cos(a1), q0y = cy + r0*Math.sin(a1);
      const q1x = cx + r0*Math.cos(a0), q1y = cy + r0*Math.sin(a0);
      const largeArc = (a1-a0) > Math.PI ? 1 : 0;
      return `M ${p0x} ${p0y} A ${r1} ${r1} 0 ${largeArc} 1 ${p1x} ${p1y} L ${q0x} ${q0y} A ${r0} ${r0} 0 ${largeArc} 0 ${q1x} ${q1y} Z`;
    }
    function renderAarshjulSVG(){
      const host = $(".aarshjul-canvas"); host.innerHTML = "";
      const size = Math.min(host.clientWidth || 520, 520);
      const rOuter = (size/2)-8, rInner = rOuter*0.55, cx=size/2, cy=size/2;
      const svgns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgns,"svg");
      svg.setAttribute("viewBox", `0 0 ${size} ${size}`); svg.setAttribute("width","100%"); svg.setAttribute("height","100%");
      const ring = document.createElementNS(svgns,"circle");
      ring.setAttribute("cx",cx); ring.setAttribute("cy",cy); ring.setAttribute("r",rOuter); ring.setAttribute("class","hjul-ring");
      svg.appendChild(ring);
      const segCount=12, tau=Math.PI*2, segAngle=tau/segCount;
      for(let i=0;i<segCount;i++){
        const a0 = -Math.PI/2 + i*segAngle, a1 = a0 + segAngle;
        const path = document.createElementNS(svgns,"path");
        path.setAttribute("d", donutSlicePath(cx,cy,rInner,rOuter,a0,a1));
        path.setAttribute("class","hjul-segment"); path.setAttribute("data-month",i);
        path.setAttribute("tabindex","0"); path.setAttribute("role","button");
        path.setAttribute("aria-label", `${MONTHS_DA[i]} – klik for at se events`);
        path.addEventListener("click", ()=> selectMonth(i));
        path.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectMonth(i); } });
        if(aarshjulState.selectedMonth===i) path.classList.add("aktiv");
        svg.appendChild(path);
        const mid=(a0+a1)/2, tr=(rInner+rOuter)/2;
        const tx=cx+Math.cos(mid)*tr, ty=cy+Math.sin(mid)*tr;
        const label=document.createElementNS(svgns,"text");
        label.setAttribute("x",tx); label.setAttribute("y",ty);
        label.setAttribute("dominant-baseline","middle"); label.setAttribute("text-anchor","middle"); label.setAttribute("class","hjul-label");
        label.textContent = MONTHS_DA[i]; svg.appendChild(label);
        const count = aarshjulState.eventsByMonth.get(i)?.length || 0;
        if(count>0){
          const dots=Math.min(count,4), baseR=rOuter+6;
          for(let d=0; d<dots; d++){
            const c=document.createElementNS(svgns,"circle");
            const off=(d-(dots-1)/2)*9;
            c.setAttribute("cx", cx + Math.cos(mid)*baseR + Math.cos(mid+Math.PI/2)*off);
            c.setAttribute("cy", cy + Math.sin(mid)*baseR + Math.sin(mid+Math.PI/2)*off);
            c.setAttribute("r",3); c.setAttribute("class","hjul-dot"); svg.appendChild(c);
          }
        }
      }
      host.appendChild(svg);
    }
    function renderAarshjulList(){
      const m = aarshjulState.selectedMonth, list=$("#aarshjul-liste"), empty=$("#aarshjul-empty"), head=$("#aarshjul-panel-overskrift");
      list.innerHTML = "";
      if(m==null){ head.textContent="Vælg en måned"; empty.classList.add("skjult"); return; }
      head.textContent = `Events i ${MONTHS_DA[m]} ${aarshjulState.selectedYear}`;
      const rows = aarshjulState.eventsByMonth.get(m)||[];
      if(rows.length===0){ empty.classList.remove("skjult"); return; } else empty.classList.add("skjult");
      for(const ev of rows){
        const li=document.createElement("li"); li.className="aarshjul-item";
        const d= ev.start || ev.slut;
        const dato = d ? d.toLocaleDateString("da-DK", { day:"2-digit", month:"short" }) : "";
        const t=document.createElement("div"); t.className="item-title"; t.textContent = ev.titel;
        const meta=document.createElement("div"); meta.className="item-meta"; meta.textContent = [dato, ev.lokation].filter(Boolean).join(" • ");
        const desc=document.createElement("div"); desc.className="item-desc"; desc.textContent = ev.beskrivelse || ev.underrubrik || "";
        li.appendChild(t); li.appendChild(meta); if(desc.textContent) li.appendChild(desc); list.appendChild(li);
      }
    }
    function selectMonth(m){ aarshjulState.selectedMonth=m; renderAarshjulSVG(); renderAarshjulList(); }
    function populateYearDropdown(){
      const sel=$("#aarshjul-year"); sel.innerHTML = "";
      const thisYear=new Date().getFullYear(); const years=[thisYear-1,thisYear,thisYear+1];
      years.forEach(y=>{ const o=document.createElement("option"); o.value=y; o.textContent=y; if(y===aarshjulState.selectedYear) o.selected=true; sel.appendChild(o); });
      sel.onchange = async ()=>{ aarshjulState.selectedYear=Number(sel.value); aarshjulState.selectedMonth=null; await loadAndRenderAarshjul(); };
    }
    function setupSearch(){
      const inp=$("#aarshjul-search"); let t;
      inp.addEventListener("input", ()=>{
        clearTimeout(t); t=setTimeout(()=>{ aarshjulState.searchQuery=inp.value; filterAndIndex(); renderAarshjulSVG(); renderAarshjulList(); }, 120);
      });
    }
    async function loadAndRenderAarshjul(){
      aarshjulState.rawEvents = await fetchAarshjulEvents(aarshjulState.selectedYear);
      filterAndIndex(); renderAarshjulSVG(); renderAarshjulList();
    }
    async function initAarshjul(){
      populateYearDropdown(); setupSearch(); await loadAndRenderAarshjul();
      const nowM=new Date().getMonth();
      if((aarshjulState.eventsByMonth.get(nowM)||[]).length>0) selectMonth(nowM);
      else{ const firstWith=[...aarshjulState.eventsByMonth.entries()].find(([,arr])=>arr.length>0); if(firstWith) selectMonth(firstWith[0]); }
      let rT; window.addEventListener("resize", ()=>{ clearTimeout(rT); rT=setTimeout(()=>renderAarshjulSVG(), 120); });
    }
document.getElementById("aarshjul-add-btn").addEventListener("click", () => {
  document.getElementById("aarshjul-add-form").classList.toggle("skjult");
});

document.getElementById("aarshjul-add-save").addEventListener("click", () => {
  const title = document.getElementById("aarshjul-add-title").value.trim();
  const desc = document.getElementById("aarshjul-add-desc").value.trim();
  const ansvar = document.getElementById("aarshjul-add-ansvar").value.trim();

  if (!title) {
    alert("Skriv mindst en titel");
    return;
  }

  // Lav et nyt liste-element
  const li = document.createElement("li");
  li.className = "aarshjul-item";
  li.innerHTML = `
    <div class="item-title">🛠️ ${title}</div>
    <div class="item-meta">Ansvar: ${ansvar || "—"}</div>
    <div class="item-desc">${desc || ""}</div>
  `;

  // Find nuværende måneds liste og indsæt
  const liste = document.getElementById("aarshjul-liste");
  liste.appendChild(li);

  // Nulstil formular
  document.getElementById("aarshjul-add-title").value = "";
  document.getElementById("aarshjul-add-desc").value = "";
  document.getElementById("aarshjul-add-ansvar").value = "";
  document.getElementById("aarshjul-add-form").classList.add("skjult");
});


    // ---------- App init ----------
    document.addEventListener("DOMContentLoaded", ()=>{
      // Knap-bindings
      $("#btn-dok")?.addEventListener("click", ()=> visSektion("dokumenter"));
      $("#btn-stat")?.addEventListener("click", ()=> visSektion("statistik"));
      $("#btn-aarshjul")?.addEventListener("click", ()=> visSektion("aarshjul"));

      // Statistik-knapper
      $("#rolle-knap")?.addEventListener("click", visRolleStatistik);
      $("#begivenhed-knap")?.addEventListener("click", visBegivenhedsStatistik);
      $("#kategori-knap")?.addEventListener("click", visBegivenhedsEfterKategori);
    });

    // Login gate og side-setup
let __afterLoginHasRun = false;
window.__sektionChosen = false; // globalt flag

adgangskontrol({
  tilladteRoller:["bestyrelsesmedlem","admin"],
  redirectVedFejl:"index.html",
  efterLogin: async (bruger)=>{
    // undgå dobbeltkald ved session-refresh
    if (__afterLoginHasRun) return;
    __afterLoginHasRun = true;

    if (window.releaseAuthGate) window.releaseAuthGate();
    indsætMenu(bruger);
    await visMapper();

    // Sørg for at knapperne vises (uanset hvad)
    document.getElementById("sektion-knapper")?.classList.remove("skjult");

    // Vælg kun standard hvis ingen sektion er valgt
    if (!window.__sektionChosen) {
      visSektion("dokumenter");
    }
  }
});



    // Init årshjul første gang sektionen vælges
    let aarshjulInitDone = false;
    const _visSektion = visSektion;
    window.visSektion = async function(navn){
      _visSektion(navn);
      if(navn==="aarshjul" && !aarshjulInitDone){
        try{ await initAarshjul(); }catch(e){ console.error(e); }
        aarshjulInitDone = true;
      }
    };
  </script>

</body>
</html>
