<!doctype html>
<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestyrelsesdokumenter ‚Äì NKL</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <link rel="stylesheet" href="css/bestyrelse.css" />

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>

  <!-- Kontekstmenuer -->
  <ul id="context-menu" class="skjult">
    <li id="ny-mappe-valg">‚ûï Opret ny mappe</li>
    <li id="slet-mappe-valg">üóëÔ∏è Slet mappe</li>
    <li id="omdoeb-mappe-valg">‚úèÔ∏è Omd√∏b mappe</li>
  </ul>
  <ul id="file-context-menu" class="skjult">
    <li id="slet-fil-valg">üóëÔ∏è Slet fil</li>
    <li id="omdoeb-fil-valg">‚úèÔ∏è Omd√∏b fil</li>
    <li id="download-fil-valg">‚¨áÔ∏è Download</li>
  </ul>

  <!-- Modal: billed-preview -->
  <div id="preview-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold">
      <button id="luk-modal" class="luk" title="Luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <img id="preview-billede" alt="Preview" />
      <div class="modal-knap-wrapper">
        <button id="download-knap" class="knap-vis" type="button">‚¨áÔ∏è Download billede</button>
      </div>
    </div>
  </div>

  <!-- Modal: gdocs/pdf -->
  <div id="gdocs-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold">
      <button class="luk" id="gdocs-luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <iframe id="gdocs-frame"></iframe>
      <div class="modal-knap-wrapper">
        <button id="gdocs-download-knap" class="knap-vis" type="button">‚¨áÔ∏è Download dokument</button>
      </div>
    </div>
  </div>

  <!-- Modal: Excel -->
  <div id="excel-modal" class="modal skjult" role="dialog" aria-modal="true">
    <div class="modal-indhold" style="overflow:auto; max-height:90vh;">
      <button class="luk" id="excel-luk" type="button" aria-label="Luk">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <select id="arkv√¶lger" style="margin:1rem 0; padding:.4rem;"></select>
      <div id="excel-output"></div>
    </div>
  </div>

  <!-- Sektion-knapper -->
<div id="sektion-knapper">
  <button onclick="visSektion('dokumenter')">üìÇ Bestyrelsens dokumenter</button>
  <button onclick="visSektion('statistik')">üìä Statistik</button>
  <button onclick="visSektion('aarshjul')">üóìÔ∏è √Örshjul</button>
</div>


  <!-- Sektion: Dokumenter -->
  <div id="sektion-dokumenter" class="sektion">
    <h1>üìÅ Bestyrelsens dokumenter</h1>
    <div id="dokument-sektioner"></div>
  </div>

  <!-- Sektion: Statistik -->
  <div id="sektion-statistik" class="sektion skjult">
    <h1>üìä Bestyrelsens statistik</h1>
    <div id="statistik-knapper">
      <button id="rolle-knap" class="btn-sub" type="button">üë• Rollefordeling</button>
    </div>
    <div class="chart-container">
      <canvas id="statistik-chart"></canvas>
    </div>
  </div>

  <!-- Sektion: √Örshjul -->
  <div id="sektion-aarshjul" class="sektion skjult">
    <h1>üóìÔ∏è Bestyrelsens √•rshjul</h1>
    <div class="aarshjul-toolbar">
      <label>√Ör: <select id="aarshjul-year"></select></label>
      <input id="aarshjul-search" type="search" placeholder="S√∏g i titel, beskrivelse eller lokation‚Ä¶" />
    </div>
    <div class="aarshjul-layout">
      <div class="aarshjul-canvas" aria-label="√Örshjul med 12 m√•neder" role="group"></div>
      <div class="aarshjul-panel">
        <h2 id="aarshjul-panel-overskrift">V√¶lg en m√•ned</h2>
		<button id="aarshjul-add-btn" class="btn-sub" type="button">‚ûï Tilf√∏j post</button>
	<div id="aarshjul-add-form" class="skjult">
	<input type="text" id="aarshjul-add-title" placeholder="Titel" required>
	<textarea id="aarshjul-add-desc" placeholder="Beskrivelse"></textarea>
	<input type="text" id="aarshjul-add-ansvar" placeholder="Ansvar">
	<button id="aarshjul-add-save" type="button">Gem</button>
	</div>	
        <ul id="aarshjul-liste" class="aarshjul-liste"></ul>
        <div id="aarshjul-empty" class="aarshjul-empty skjult">Ingen events i denne m√•ned.</div>
      </div>
    </div>
  </div>

  <!-- App script -->
  <script type="module">
    import { adgangskontrol, inds√¶tMenu, client } from './auth.js';

    // ---------- Helpers (DOM) ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const bucketNavn = "bestyrelse";

	// ---- Signed URL cache (localStorage) ----
	const SIGN_CACHE_KEY = 'bestyrelse_signed_urls_v1';
	const signedCache = new Map(); // key: fullPath -> { url, exp }

try {
  const raw = localStorage.getItem(SIGN_CACHE_KEY);
  if (raw) {
    const obj = JSON.parse(raw);
    for (const [k, v] of Object.entries(obj)) signedCache.set(k, v);
  }
} catch {}

function getCachedSignedUrl(path) {
  const hit = signedCache.get(path);
  if (!hit) return null;
  if (Date.now() > hit.exp) { signedCache.delete(path); return null; }
  return hit.url;
}

function saveSignedCacheSoon() {
  clearTimeout(saveSignedCacheSoon.t);
  saveSignedCacheSoon.t = setTimeout(() => {
    const obj = Object.fromEntries(signedCache.entries());
    localStorage.setItem(SIGN_CACHE_KEY, JSON.stringify(obj));
  }, 200);
}

async function batchSignPaths(paths, { expiresSec = 1800 } = {}) {
  const toSign = paths.filter(p => !getCachedSignedUrl(p));
  if (toSign.length === 0) return;

  // sign√©r i chunks, s√• vi ikke laver mega-kald hvis der ligger 200+
  const CHUNK = 40;
  for (let i = 0; i < toSign.length; i += CHUNK) {
    const slice = toSign.slice(i, i + CHUNK);
    const { data, error } = await client.storage
      .from(bucketNavn)
      .createSignedUrls(slice, expiresSec);
    if (error) { console.error('batchSign error', error); continue; }
    const exp = Date.now() + expiresSec * 1000 - 10_000; // 10s buffer
    // data f√∏lger r√¶kkef√∏lgen af slice
    data.forEach((res, idx) => {
      if (res?.signedUrl) {
        signedCache.set(slice[idx], { url: res.signedUrl, exp });
      }
    });
  }
  saveSignedCacheSoon();
}

function visSektion(navn) {
  // Skjul alle sektioner
  document.querySelectorAll(".sektion").forEach(s => s.classList.add("skjult"));

  // Vis den valgte
  const valgt = document.getElementById("sektion-" + navn);
  if (valgt) {
    valgt.classList.remove("skjult");
  }

  // Lazy-load dokumenter
if (navn === "dokumenter") {
  const cont = document.getElementById("dokument-sektioner");
  if (!cont || cont.childElementCount === 0) {
    Promise.resolve()
      .then(() => visMapper())
      .then(() => g√∏rMapperOgFilerTr√¶kbare())
      .catch(console.error);
  }
}

  // Aktiv knap styling
  document.querySelectorAll("#sektion-knapper button").forEach(knap => knap.classList.remove("aktiv"));
  const aktivKnap = [...document.querySelectorAll("#sektion-knapper button")]
    .find(knap => knap.getAttribute("onclick").includes(navn));
  if (aktivKnap) aktivKnap.classList.add("aktiv");
}

    // ---------- Storage: ikon ----------
    function filtypeIkon(filnavn){
      const ext = (filnavn.split('.').pop()||"").toLowerCase();
      if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "üñºÔ∏è";
      if(["pdf"].includes(ext)) return "üìï";
      if(["doc","docx"].includes(ext)) return "üìÑ";
      if(["xls","xlsx","csv","xlsm","xlsb"].includes(ext)) return "üìä";
      if(["ppt","pptx"].includes(ext)) return "üìΩÔ∏è";
      if(["zip","rar"].includes(ext)) return "üóúÔ∏è";
      if(["txt"].includes(ext)) return "üìÉ";
      return "üìÅ";
    }

    // ---------- Storage: vis mapper ----------
    async function hentMapper(bucket){
      const { data, error } = await client.storage.from(bucket).list("", { limit:100 });
      if(error){ console.error(error); return []; }
      return (data||[]).filter(item => !item.name.includes('.') && item.metadata===null);
    }

    async function visMapper(){
      const container = $("#dokument-sektioner");
      container.innerHTML = "";
      const mapper = await hentMapper(bucketNavn);
      for(const mappe of mapper){
        const wrap = document.createElement("div");
        wrap.className = "mappe";

        const head = document.createElement("div");
        head.className = "mappe-header";
        head.textContent = `üìÅ ${mappe.name}`;
        head.addEventListener("click", ()=>toggleMappe(mappe.name, wrap));

        // dnd upload
        head.addEventListener("dragover", e=>{ e.preventDefault(); head.classList.add("highlight"); });
        head.addEventListener("dragleave", ()=> head.classList.remove("highlight"));
        head.addEventListener("drop", (e)=> onDropUpload(e, mappe.name, head));

        wrap.appendChild(head);
        container.appendChild(wrap);
      }
    }

    async function onDropUpload(e, destinationMappe, headEl){
      e.preventDefault(); headEl.classList.remove("highlight");
      const filer = e.dataTransfer.files;
      if(!filer || !filer.length) return;

      for(const fil of filer){
        let filnavn = fil.name;
        filnavn = filnavn
          .replace(/√¶/g,"ae").replace(/√∏/g,"oe").replace(/√•/g,"aa")
          .replace(/√Ü/g,"Ae").replace(/√ò/g,"Oe").replace(/√Ö/g,"Aa");
        const uploadSti = `${destinationMappe}/${filnavn}`;
        let { error } = await client.storage.from(bucketNavn).upload(uploadSti, fil, { upsert:false });
        if(error && error.message.includes("already exists")){
          const overskriv = confirm(`Filen findes allerede.\nOverskriv?`);
          if(overskriv){
            ({ error } = await client.storage.from(bucketNavn).upload(uploadSti, fil, { upsert:true }));
          }
        }
        if(error){ alert(`Upload-fejl: ${error.message}`); console.error(error); }
      }
      await visMapper();
    }

function hydrateRowUrl(row, signedUrl){
  if (!row || !signedUrl) return;
  const name = row.dataset.name || "";
  const path = row.dataset.path || "";
  

  const isImg   = /\.(jpg|jpeg|png|gif|webp)$/i.test(name);
  const isExcel = /\.(xlsx?|csv|xlsm|xlsb)$/i.test(name);
  const isGdoc  = /\.(docx?|pdf|pptx?|txt)$/i.test(name);

  const btn = row.querySelector('.fil-label');
  if (!btn) return;

  btn.disabled = false;
  btn.onclick = () => {
    if (isImg)        visModal(signedUrl, path);
    else if (isExcel) window.visExcelModal(signedUrl);
    else if (isGdoc)  window.visDocModal(signedUrl, path);
    else window.open(signedUrl, "_blank");
  };
}

async function toggleMappe(sti, wrapperEl) {
  let indhold = wrapperEl.querySelector(".mappe-indhold");
  if (indhold) { indhold.remove(); return; }

  indhold = document.createElement("div");
  indhold.className = "mappe-indhold";
  wrapperEl.appendChild(indhold);

  // state pr. mappe
  const STATE = {
    page: 0,
    pageSize: 20,
    done: false,
    ioSign: null,   // observer til at signere synlige r√¶kker
    ioLoad: null,   // observer til at loade n√¶ste side
    listContainer: null,
    sentinel: null,
    loading: false
  };

  // container til filr√¶kker
  const list = document.createElement("div");
  list.className = "fil-liste";
  indhold.appendChild(list);
  STATE.listContainer = list;

  // sentinel i bunden til infinite scroll
  const sentinel = document.createElement("div");
  sentinel.className = "scroll-sentinel";
  sentinel.style.height = "1px";
  indhold.appendChild(sentinel);
  STATE.sentinel = sentinel;

  // observer der pre-signer synlige r√¶kker
  STATE.ioSign = new IntersectionObserver(async entries => {
    const needSign = [];
    for (const e of entries) {
      if (!e.isIntersecting) continue;
      const row = e.target;
      const path = row.dataset.path;
      const cached = getCachedSignedUrl(path);
      if (cached) {
        hydrateRowUrl(row, cached);
        STATE.ioSign.unobserve(row);
      } else {
        needSign.push(path);
      }
    }
    if (needSign.length) {
      await batchSignPaths(needSign);
      for (const p of needSign) {
        const r = STATE.listContainer.querySelector(`[data-path="${CSS.escape(p)}"]`);
        if (r) hydrateRowUrl(r, getCachedSignedUrl(p));
      }
    }
  }, { rootMargin: "200px" });

  // observer der loader n√¶ste page n√•r man n√¶rmer sig bunden
  STATE.ioLoad = new IntersectionObserver(async entries => {
    for (const e of entries) {
      if (!e.isIntersecting) continue;
      if (!STATE.done && !STATE.loading) {
        await loadNextPage();
      }
    }
  }, { rootMargin: "600px" });

  STATE.ioLoad.observe(STATE.sentinel);

  // f√∏rste pages (s√• vi ikke kun viser 20 hvis der er plads til mere)
  await loadNextPage();
  while (!STATE.done && contentShorterThanViewport(indhold)) {
    await loadNextPage();
  }

  function contentShorterThanViewport(container) {
    const rect = container.getBoundingClientRect();
    return rect.bottom <= (window.innerHeight + 100); // 100px buffer
  }

  async function loadNextPage() {
    if (STATE.done || STATE.loading) return;
    STATE.loading = true;

    const { data, error } = await client.storage
      .from(bucketNavn)
      .list(sti, {
        limit: STATE.pageSize,
        offset: STATE.page * STATE.pageSize,
        sortBy: { column: 'name', order: 'asc' }
      });

    STATE.loading = false;

    if (error) { console.error(error); return; }
    const items = (data || []).filter(item => {
      const skip = [".emptyFolderPlaceholder",".DS_Store","thumbs.db"];
      return item?.name && !skip.includes(item.name);
    });

    if (!items.length) {
      STATE.done = true;
      return;
    }

    const rowsNeedingSign = [];
    for (const item of items) {
      const fuldSti = `${sti}/${item.name}`.replace(/\/+/g,"/");

      // undermappe
      if (item.metadata === null && !item.name.includes('.')) {
        const div = document.createElement("div");
        div.className = "mappe";
        const head = document.createElement("div");
        head.className = "mappe-header";
        head.textContent = `üìÅ ${item.name}`;
        head.addEventListener("click", () => toggleMappe(fuldSti, div));
        head.addEventListener("dragover", e => { e.preventDefault(); head.classList.add("highlight"); });
        head.addEventListener("dragleave", () => head.classList.remove("highlight"));
        head.addEventListener("drop", (e)=> onDropUpload(e, fuldSti, head));
        STATE.listContainer.appendChild(div);
        div.appendChild(head);
        continue;
      }

      // filr√¶kke
      const row = document.createElement("div");
      row.className = "fil-linje";
      row.dataset.path = fuldSti;
	  row.dataset.name = item.name;

      const label = document.createElement("button");
      label.type = "button";
      label.className = "fil-label";
      label.textContent = `${filtypeIkon(item.name)} ${item.name}`;
      label.disabled = true; // aktiveres, n√•r vi har URL

      const menuKnap = document.createElement("button");
      menuKnap.type = "button";
      menuKnap.className = "slet-knap";
      menuKnap.textContent = "‚ãÆ";
      menuKnap.title = "Flere handlinger";
      menuKnap.onclick = (e)=> {
        e.preventDefault(); e.stopPropagation();
        h√∏jreklikFilsti = fuldSti;
        visMenuUdenforKant($("#file-context-menu"), e.pageX, e.pageY);
        $("#file-context-menu").classList.remove("skjult");
      };

      row.appendChild(label);
      row.appendChild(menuKnap);
      STATE.listContainer.appendChild(row);

      const cached = getCachedSignedUrl(fuldSti);
      if (cached) {
        hydrateRowUrl(row, cached);
      } else {
        rowsNeedingSign.push(row);
      }
    }

    // observer r√¶kker der mangler sign
    for (const r of rowsNeedingSign) STATE.ioSign.observe(r);

    STATE.page += 1;

    // pre-sign√©r straks det, der allerede er i viewport
    await signVisibleNow(rowsNeedingSign);
  }

  async function signVisibleNow(rows) {
    const need = [];
    for (const r of rows) {
      const rect = r.getBoundingClientRect();
      const inView = rect.top < window.innerHeight + 200 && rect.bottom > -200;
      if (inView) {
        const path = r.dataset.path;
        if (!getCachedSignedUrl(path)) need.push(path);
      }
    }
    if (!need.length) return;
    await batchSignPaths(need);
    for (const p of need) {
      const r = STATE.listContainer.querySelector(`[data-path="${CSS.escape(p)}"]`);
      if (r) hydrateRowUrl(r, getCachedSignedUrl(p));
    }
  }
}

    // ---------- Modal helpers ----------
    function visMenuUdenforKant(menuEl, x, y){
      menuEl.classList.remove("skjult");
      const { innerWidth:w, innerHeight:h } = window;
      const mw = menuEl.offsetWidth || 160;
      const mh = menuEl.offsetHeight || 80;
      let left = x, top = y;
      if(x + mw > w) left = w - mw - 10;
      if(y + mh > h) top = h - mh - 10;
      menuEl.style.left = `${left}px`;
      menuEl.style.top  = `${top}px`;
    }
    function lukModal(){
      $("#preview-modal")?.classList.add("skjult");
      $("#preview-billede").src = "";
    }
    async function tvungenDownload(path, filnavn="fil"){
      const { data, error } = await client.storage.from(bucketNavn).download(path);
      if(error||!data){ alert("Kunne ikke hente filen"); return; }
      const url = URL.createObjectURL(data);
      const a = document.createElement("a");
      a.href = url; a.download = filnavn; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function visModal(url, path){
      $("#gdocs-modal")?.classList.add("skjult");
      $("#gdocs-frame").src = "";
      $("#preview-billede").src = url;
      $("#download-knap").onclick = ()=> tvungenDownload(path, path.split("/").pop());
      $("#preview-modal").classList.remove("skjult");
    }
	window.visDocModal = function(signedUrl, path){
  $("#preview-modal")?.classList.add("skjult");
  $("#preview-billede").src = "";

  const name = path.split("/").pop() || "";
  const ext  = name.split(".").pop()?.toLowerCase() || "";

  const $modal = $("#gdocs-modal");
  const $frame = $("#gdocs-frame");

  // altid vis modal ‚Äì vi fylder indholdet nedenfor
  $modal.classList.remove("skjult");

  // helper: s√¶t iframe-src
  const setFrame = (src) => { $frame.src = src; };

  // helper: fallback download-knap
  $("#gdocs-download-knap").onclick = ()=> tvungenDownload(path, name);

  // 1) PDF ‚Üí brug browserens egen viewer (hurtigst)
  if (ext === "pdf") {
    // De fleste browsere viser PDF lynhurtigt direkte
    setFrame(signedUrl);
    return;
  }

  // 2) Office-formater ‚Üí brug Office Web Viewer (ofte hurtigere end gview)
  const isWord = ["doc", "docx"].includes(ext);
  const isPpt  = ["ppt", "pptx"].includes(ext);
  // (XLS, XLSX, CSV h√•ndteres af din eksisterende visExcelModal andre steder)
  if (isWord || isPpt) {
    // Microsofts viewer accepterer offentligt tilg√¶ngelige URLs og mange signed URLs
    // (s√• l√¶nge de kan hentes af Office‚Äôs servere inden udl√∏b)
    const officeUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(signedUrl)}`;
    setFrame(officeUrl);
    return;
  }

  // 3) TXT ‚Üí fetch og vis simpel tekst (hurtigt og lokalt)
  if (ext === "txt") {
    (async () => {
      try {
        const res = await fetch(signedUrl);
        const text = await res.text();
        // vis som tekst i stedet for iframe
        $frame.src = "about:blank";
        const html = `
          <div style="padding:1rem; max-height:80vh; overflow:auto; white-space:pre-wrap; font:14px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;">
            ${text.replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s]))}
          </div>`;
        // skriv ind i iframe-dokumentet
        const doc = $frame.contentDocument || $frame.contentWindow?.document;
        doc.open(); doc.write(html); doc.close();
      } catch (e) {
        console.error(e);
        setFrame(signedUrl); // sidste udvej
      }
    })();
    return;
  }

  // 4) Alt andet ‚Üí pr√∏v direkte i iframe (mange browsere viser fx .rtf, .md via plugins)
  setFrame(signedUrl);
};
	window.lukGdocsModal = function(){
  $("#gdocs-frame").src = "";
  $("#gdocs-modal").classList.add("skjult");
  document.body.classList.remove("modal-open");
};
    window.visExcelModal = async function(signedUrl){
      const res = await fetch(signedUrl); const blob = await res.blob();
      const reader = new FileReader();
      reader.onload = function(e){
        const wb = XLSX.read(new Uint8Array(e.target.result), { type:"array" });
        const sel = $("#arkv√¶lger"); sel.innerHTML = "";
        wb.SheetNames.forEach((navn, i)=>{
          const opt = document.createElement("option");
          opt.value = navn; opt.textContent = navn; if(i===0) opt.selected = true; sel.appendChild(opt);
        });
        const visArk = (navn)=>{
          const sheet = wb.Sheets[navn];
          $("#excel-output").innerHTML = XLSX.utils.sheet_to_html(sheet);
        };
        visArk(wb.SheetNames[0]);
        sel.onchange = ()=> visArk(sel.value);
        $("#excel-modal").classList.remove("skjult");
      };
      reader.readAsArrayBuffer(blob);
    };
    window.lukExcelModal = function(){
      $("#excel-output").innerHTML = "";
      $("#excel-modal").classList.add("skjult");
    };

    // ---------- H√∏jreklik + keyboard ESC ----------
    let h√∏jreklikFilsti = "", h√∏jreklikSti = "";
    document.addEventListener("click", ()=>{
      $("#context-menu")?.classList.add("skjult");
      $("#file-context-menu")?.classList.add("skjult");
    });
    document.addEventListener("contextmenu", (e)=>{
      const el = e.target.closest(".mappe-header");
      if(el){
        e.preventDefault();
        h√∏jreklikSti = el.textContent.replace("üìÅ","").trim();
        $("#file-context-menu")?.classList.add("skjult");
        visMenuUdenforKant($("#context-menu"), e.pageX, e.pageY);
        $("#context-menu").classList.remove("skjult");
      }
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Escape") return;
      $("#context-menu")?.classList.add("skjult");
      $("#file-context-menu")?.classList.add("skjult");
      $("#gdocs-modal") && !$("#gdocs-modal").classList.contains("skjult") && window.lukGdocsModal();
      $("#excel-modal") && !$("#excel-modal").classList.contains("skjult") && window.lukExcelModal();
      $("#preview-modal") && !$("#preview-modal").classList.contains("skjult") && lukModal();
    });

    // Menupunkter (sikre bindinger)
    $("#ny-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      const navn = prompt(`Navn p√• ny mappe i "${h√∏jreklikSti || ''}":`);
      if(!navn) return;
      const sti = h√∏jreklikSti ? `${h√∏jreklikSti}/${navn.trim()}` : navn.trim();
      const placeholderPath = `${sti}/.emptyFolderPlaceholder`;
      const { error } = await client.storage.from(bucketNavn).upload(placeholderPath, new Blob([""]), { upsert:false });
      if(error) alert("Kunne ikke oprette mappen: " + error.message);
      await visMapper();
    });
    $("#slet-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      if(!h√∏jreklikSti) return;
      if(!confirm(`Slet mappen "${h√∏jreklikSti}" og alt indhold?`)) return;
      async function hentFiler(path, acc=[]){
        const { data } = await client.storage.from(bucketNavn).list(path, { limit:100 });
        for(const item of (data||[])){
          const fuldSti = `${path}/${item.name}`;
          if(item.metadata===null && !item.name.includes(".")) await hentFiler(fuldSti, acc);
          else acc.push(fuldSti);
        }
        return acc;
      }
      const filer = await hentFiler(h√∏jreklikSti);
      if(filer.length===0) filer.push(`${h√∏jreklikSti}/.emptyFolderPlaceholder`);
      const { error } = await client.storage.from(bucketNavn).remove(filer);
      if(error) alert("Kunne ikke slette mappen");
      await visMapper();
    });
    $("#omdoeb-mappe-valg")?.addEventListener("click", async ()=>{
      $("#context-menu").classList.add("skjult");
      if(!h√∏jreklikSti) return;
      let nytnavn = prompt(`Omd√∏b mappen "${h√∏jreklikSti}" til:`);
      if(!nytnavn) return;
      async function hentFiler(path, acc=[]){
        const { data } = await client.storage.from(bucketNavn).list(path, { limit:100 });
        for(const item of (data||[])){
          const fuldSti = `${path}/${item.name}`;
          if(item.metadata===null && !item.name.includes(".")) await hentFiler(fuldSti, acc);
          else acc.push(fuldSti);
        }
        return acc;
      }
      const filer = await hentFiler(h√∏jreklikSti);
      if(filer.length===0) filer.push(`${h√∏jreklikSti}/.emptyFolderPlaceholder`);
      const dele = h√∏jreklikSti.split("/"); dele.pop();
      const nyStiBase = [...dele, nytnavn.trim()].join("/");
      for(const gammel of filer){
        const relativ = gammel.slice(h√∏jreklikSti.length + 1);
        const nyPath = `${nyStiBase}/${relativ}`;
        const { error } = await client.storage.from(bucketNavn).move(gammel, nyPath);
        if(error){ alert("Kunne ikke omd√∏be alt"); break; }
      }
      await visMapper();
    });

    $("#slet-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!h√∏jreklikFilsti) return;
      if(!confirm(`Slet filen "${h√∏jreklikFilsti.split("/").pop()}"?`)) return;
      const { error } = await client.storage.from(bucketNavn).remove([h√∏jreklikFilsti]);
      if(error) alert("Fejl ved sletning");
      await visMapper();
      h√∏jreklikFilsti = "";
    });
    $("#omdoeb-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!h√∏jreklikFilsti) return;
      const gammelt = h√∏jreklikFilsti.split("/").pop();
      const base = h√∏jreklikFilsti.split("/").slice(0,-1).join("/");
      const nyt = prompt(`Omd√∏b filen "${gammelt}" til:`, gammelt);
      if(!nyt || nyt===gammelt) return;
      const nySti = `${base}/${nyt.trim()}`;
      const { error } = await client.storage.from(bucketNavn).move(h√∏jreklikFilsti, nySti);
      if(error) alert("Kunne ikke omd√∏be filen");
      await visMapper();
      h√∏jreklikFilsti = "";
    });
    $("#download-fil-valg")?.addEventListener("click", async ()=>{
      $("#file-context-menu").classList.add("skjult");
      if(!h√∏jreklikFilsti) return;
      const filnavn = h√∏jreklikFilsti.split("/").pop();
      const { data, error } = await client.storage.from(bucketNavn).download(h√∏jreklikFilsti);
      if(error||!data){ alert("Kunne ikke hente filen"); return; }
      const url = URL.createObjectURL(data);
      const a = document.createElement("a"); a.href=url; a.download=filnavn; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      h√∏jreklikFilsti = "";
    });

    // Luk modaler
    $("#luk-modal")?.addEventListener("click", lukModal);
    $("#preview-modal")?.addEventListener("click", (e)=>{ if(e.target.id==="preview-modal") lukModal(); });
    $("#gdocs-luk")?.addEventListener("click", ()=> window.lukGdocsModal());
    $("#excel-luk")?.addEventListener("click", ()=> window.lukExcelModal());

    // ---------- Statistik ----------
    let chartInstance = null;
    function renderChart(config){
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart($("#statistik-chart"), { ...config, plugins:[ChartDataLabels] });
    }
    async function visRolleStatistik(){
      try{
        const { data, error } = await client.from("users").select("rolle");
        if(error) throw error;
        const rolles = {};
        (data||[]).forEach(b=>{
          const rs = Array.isArray(b.rolle)? b.rolle : [b.rolle];
          rs.forEach(r=> rolles[r] = (rolles[r]||0)+1);
        });
        renderChart({
          type:"pie",
          data:{ labels:Object.keys(rolles), datasets:[{ data:Object.values(rolles) }] },
          options:{ responsive:true, plugins:{ legend:{position:"bottom"}, title:{display:true, text:"üë• Rollefordeling i klubben"}, datalabels:{ color:"#fff", font:{weight:"bold", size:14}, formatter:v=>v } } }
        });
      }catch(e){ alert("Kunne ikke hente rolledata."); console.error(e); }
    }

    // ---------- √Örshjul ----------
    const MONTHS_DA = ["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"];
	let aarshjulState = {
	rawEvents: [],
	filteredEvents: [],
	eventsByMonth: new Map(),
	tasksByMonth: new Map(),
	selectedMonth: null,
	selectedYear: new Date().getFullYear(),
	searchQuery: ""
	};

    function parseMaybeDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)? null : d; }
    function monthIndexFromDate(d){ return d?.getMonth?.() ?? null; }

	// ---------- √Örshjul-opgaver i Supabase ----------
	async function loadTasksForYear(year){
  // Returnerer Map(0..11 => [task, ...]), hvor task har {id,title,desc,ansvar,createdAt}
  const map = new Map(Array.from({length:12}, (_,i)=>[i,[]]));
  const { data, error } = await client
    .from("aarshjul")
    .select("id, aar, maaned, title, desc, ansvar, created_at")
    .eq("aar", year)
    .order("created_at", { ascending: true });

  if (error) { console.error("Hent aarshjul-fejl:", error); return map; }
  for (const row of (data || [])){
    const m = Number(row.maaned);
    if (!isNaN(m) && m>=0 && m<=11){
      map.get(m).push({
        id: row.id,
        title: row.title || "",
        desc: row.desc || "",
        ansvar: row.ansvar || "",
        createdAt: row.created_at
      });
    }
  }
  return map;
}
	async function addTaskToSupabase({ aar, maaned, title, desc, ansvar }){
  const { data, error } = await client
    .from("aarshjul")
    .insert({ aar, maaned, title, desc, ansvar })
    .select("id, aar, maaned, title, desc, ansvar, created_at")
    .single();
  if (error) throw error;
  return {
    id: data.id,
    title: data.title || "",
    desc: data.desc || "",
    ansvar: data.ansvar || "",
    createdAt: data.created_at
  };
}
	async function deleteTaskFromSupabase(id){
  const { error } = await client.from("aarshjul").delete().eq("id", id);
  if (error) throw error;
}
	function saveTasksForYear(year, tasksMap){
  const obj = {};
  for(const [m,arr] of tasksMap.entries()) obj[m] = arr;
  localStorage.setItem(tasksKey(year), JSON.stringify(obj));
}
    async function fetchAarshjulEvents(year){
      const from = `${year-1}-11-01`, to = `${year+1}-01-31`;
      const { data, error } = await client
        .from("events")
        .select("id,titel,underrubrik,beskrivelse,start,slut,lokation,offentlig,created_at")
        .gte("start", from)
        .lte("start", to)
        .order("start", { ascending:true });
      if(error){ console.error("√Örshjul:", error); return []; }
      return (data||[]).map(ev=>({
        id:ev.id, titel:ev.titel||"(uden titel)", underrubrik:ev.underrubrik||"", beskrivelse:ev.beskrivelse||"",
        start:parseMaybeDate(ev.start), slut:parseMaybeDate(ev.slut), lokation:ev.lokation||"", offentlig:ev.offentlig ?? true
      }));
    }
    function filterAndIndex(){
      const year = aarshjulState.selectedYear;
      const q = aarshjulState.searchQuery.trim().toLowerCase();
      const filtered = aarshjulState.rawEvents.filter(ev=>{
        const inYear = (ev.start && ev.start.getFullYear()===year) || (ev.slut && ev.slut.getFullYear()===year);
        if(!inYear) return false;
        if(!q) return true;
        const hay = `${ev.titel} ${ev.underrubrik} ${ev.beskrivelse} ${ev.lokation}`.toLowerCase();
        return hay.includes(q);
      });
      aarshjulState.filteredEvents = filtered;
      const map = new Map(Array.from({length:12},(_,i)=>[i,[]]));
      filtered.forEach(ev=>{ const m=monthIndexFromDate(ev.start||ev.slut); if(m!=null) map.get(m).push(ev); });
      aarshjulState.eventsByMonth = map;
    }
    function donutSlicePath(cx,cy,r0,r1,a0,a1){
      const p0x = cx + r1*Math.cos(a0), p0y = cy + r1*Math.sin(a0);
      const p1x = cx + r1*Math.cos(a1), p1y = cy + r1*Math.sin(a1);
      const q0x = cx + r0*Math.cos(a1), q0y = cy + r0*Math.sin(a1);
      const q1x = cx + r0*Math.cos(a0), q1y = cy + r0*Math.sin(a0);
      const largeArc = (a1-a0) > Math.PI ? 1 : 0;
      return `M ${p0x} ${p0y} A ${r1} ${r1} 0 ${largeArc} 1 ${p1x} ${p1y} L ${q0x} ${q0y} A ${r0} ${r0} 0 ${largeArc} 0 ${q1x} ${q1y} Z`;
    }
    function renderAarshjulSVG(){
      const host = $(".aarshjul-canvas"); host.innerHTML = "";
      const size = Math.min(host.clientWidth || 520, 520);
      const rOuter = (size/2)-8, rInner = rOuter*0.55, cx=size/2, cy=size/2;
      const svgns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgns,"svg");
      svg.setAttribute("viewBox", `0 0 ${size} ${size}`); svg.setAttribute("width","100%"); svg.setAttribute("height","100%");
      const ring = document.createElementNS(svgns,"circle");
      ring.setAttribute("cx",cx); ring.setAttribute("cy",cy); ring.setAttribute("r",rOuter); ring.setAttribute("class","hjul-ring");
      svg.appendChild(ring);
      const segCount=12, tau=Math.PI*2, segAngle=tau/segCount;
      for(let i=0;i<segCount;i++){
        const a0 = -Math.PI/2 + i*segAngle, a1 = a0 + segAngle;
        const path = document.createElementNS(svgns,"path");
        path.setAttribute("d", donutSlicePath(cx,cy,rInner,rOuter,a0,a1));
        path.setAttribute("class","hjul-segment"); path.setAttribute("data-month",i);
        path.setAttribute("tabindex","0"); path.setAttribute("role","button");
        path.setAttribute("aria-label", `${MONTHS_DA[i]} ‚Äì klik for at se events`);
        path.addEventListener("click", ()=> selectMonth(i));
        path.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectMonth(i); } });
        if(aarshjulState.selectedMonth===i) path.classList.add("aktiv");
        svg.appendChild(path);
        const mid=(a0+a1)/2, tr=(rInner+rOuter)/2;
        const tx=cx+Math.cos(mid)*tr, ty=cy+Math.sin(mid)*tr;
        const label=document.createElementNS(svgns,"text");
        label.setAttribute("x",tx); label.setAttribute("y",ty);
        label.setAttribute("dominant-baseline","middle"); label.setAttribute("text-anchor","middle"); label.setAttribute("class","hjul-label");
        label.textContent = MONTHS_DA[i]; svg.appendChild(label);
// ----- events (bl√• prikker, t√¶t p√• ydre ring) -----
const eventCount = aarshjulState.eventsByMonth.get(i)?.length || 0;
if (eventCount > 0){
  const dots  = Math.min(eventCount, 4);
  const baseR = rOuter - 6;        // t√¶t p√• ydre ring, men stadig inde
  const tangentialGap = 7;

  for (let d = 0; d < dots; d++){
    const c = document.createElementNS(svgns, "circle");
    const off = (d - (dots - 1)/2) * tangentialGap;
    c.setAttribute("cx", cx + Math.cos(mid) * baseR + Math.cos(mid + Math.PI/2) * off);
    c.setAttribute("cy", cy + Math.sin(mid) * baseR + Math.sin(mid + Math.PI/2) * off);
    c.setAttribute("r", 3);
    c.setAttribute("class", "hjul-event-dot"); // bl√•
    svg.appendChild(c);
  }
}

// ----- tasks (orange prikker, l√¶ngere inde) -----
const taskCount = aarshjulState.tasksByMonth.get(i)?.length || 0;
if (taskCount > 0){
  const dots  = Math.min(taskCount, 4);
  const baseR = rInner + 10;       // l√¶ngere inde
  const tangentialGap = 7;

  for (let d = 0; d < dots; d++){
    const c = document.createElementNS(svgns, "circle");
    const off = (d - (dots - 1)/2) * tangentialGap;
    c.setAttribute("cx", cx + Math.cos(mid) * baseR + Math.cos(mid + Math.PI/2) * off);
    c.setAttribute("cy", cy + Math.sin(mid) * baseR + Math.sin(mid + Math.PI/2) * off);
    c.setAttribute("r", 3);
    c.setAttribute("class", "hjul-task-dot"); // orange
    svg.appendChild(c);
  }
}


      }
      host.appendChild(svg);
    }
    function renderAarshjulList(){
  const m    = aarshjulState.selectedMonth;
  const list = document.getElementById("aarshjul-liste");
  const empty= document.getElementById("aarshjul-empty");
  const head = document.getElementById("aarshjul-panel-overskrift");

  list.innerHTML = "";

  if (m == null){
    head.textContent = "V√¶lg en m√•ned";
    empty.classList.add("skjult");
    return;
  }

  head.textContent = `Events & opgaver i ${MONTHS_DA[m]} ${aarshjulState.selectedYear}`;

  // Events + tasks fra state (kr√¶ver at du har sat aarshjulState.tasksByMonth)
  const events = (aarshjulState.eventsByMonth.get(m) || []).map(e => ({ _kind:"event", ...e }));
  const tasks  = (aarshjulState.tasksByMonth?.get(m) || []).map(t => ({ _kind:"task", ...t }));

  // Saml i √©n liste og sorter (events med dato f√∏rst; opgaver uden dato bagefter)
  const rows = [...events, ...tasks].sort((a,b)=>{
    const ad = a.start || a.slut;
    const bd = b.start || b.slut;
    if (ad && bd) return ad - bd;             // begge har dato
    if (ad && !bd) return -1;                 // event f√∏r task
    if (!ad && bd) return 1;                  // task efter event
    return 0;                                 // ingen dato: behold r√¶kkef√∏lge
  });

  if (rows.length === 0){
    empty.classList.remove("skjult");
    return;
  }
  empty.classList.add("skjult");

  for (const it of rows){
    const li = document.createElement("li");
    li.className = "aarshjul-item";

    if (it._kind === "event"){
      const d = it.start || it.slut;
      const datoTxt = d ? d.toLocaleDateString("da-DK", { day:"2-digit", month:"short" }) : "";
      li.innerHTML = `
        <div class="item-title">${it.titel}</div>
        <div class="item-meta">${[datoTxt, it.lokation].filter(Boolean).join(" ‚Ä¢ ")}</div>
        ${it.beskrivelse ? `<div class="item-desc">${it.beskrivelse}</div>` : ""}
      `;
    } else {
      // task/opgave (lokale noter)
li.innerHTML = `
  <div class="item-title">üõ†Ô∏è ${it.title}</div>
  <div class="item-meta">${it.ansvar ? `Ansvar: ${it.ansvar}` : ""}</div>
  ${it.desc ? `<div class="item-desc">${it.desc}</div>` : ""}
  <div class="item-actions">
    <button type="button" class="btn-sub btn-edit-task"  data-id="${it.id || ""}">‚úèÔ∏è Redig√©r</button>
    <button type="button" class="btn-sub btn-delete-task" data-id="${it.id || ""}">üóëÔ∏è Slet</button>
  </div>
`;
    }

    list.appendChild(li);
  }
}
    function selectMonth(m){
		aarshjulState.selectedMonth=m;
		renderAarshjulSVG();
		renderAarshjulList();
		}
    function populateYearDropdown(){
      const sel=$("#aarshjul-year"); sel.innerHTML = "";
      const thisYear=new Date().getFullYear(); const years=[thisYear-1,thisYear,thisYear+1];
      years.forEach(y=>{ const o=document.createElement("option"); o.value=y; o.textContent=y; if(y===aarshjulState.selectedYear) o.selected=true; sel.appendChild(o); });
      sel.onchange = async ()=>{ aarshjulState.selectedYear=Number(sel.value); aarshjulState.selectedMonth=null; await loadAndRenderAarshjul(); };
    }
    function setupSearch(){
      const inp=$("#aarshjul-search"); let t;
      inp.addEventListener("input", ()=>{
        clearTimeout(t); t=setTimeout(()=>{ aarshjulState.searchQuery=inp.value; filterAndIndex(); renderAarshjulSVG(); renderAarshjulList(); }, 120);
      });
    }
    async function loadAndRenderAarshjul(){
      aarshjulState.rawEvents = await fetchAarshjulEvents(aarshjulState.selectedYear);
	  aarshjulState.tasksByMonth = await loadTasksForYear(aarshjulState.selectedYear);
      filterAndIndex(); renderAarshjulSVG(); renderAarshjulList();
    }
    async function initAarshjul(){
      populateYearDropdown(); setupSearch(); await loadAndRenderAarshjul();
      const nowM=new Date().getMonth();
      if((aarshjulState.eventsByMonth.get(nowM)||[]).length>0) selectMonth(nowM);
      else{ const firstWith=[...aarshjulState.eventsByMonth.entries()].find(([,arr])=>arr.length>0); if(firstWith) selectMonth(firstWith[0]); }
      let rT; window.addEventListener("resize", ()=>{ clearTimeout(rT); rT=setTimeout(()=>renderAarshjulSVG(), 120); });  
	  // Deleg√©r klik p√• slet-task
	document.getElementById("aarshjul-liste")?.addEventListener("click", async (e)=>{
  // --- SLET ---
  const delBtn = e.target.closest(".btn-delete-task");
  if (delBtn){
    const id = delBtn.getAttribute("data-id");
    if (!id) return;
    if (!confirm("Slet denne post?")) return;

    try{
      await deleteTaskFromSupabase(id);
      // Fjern fra state
      const m = aarshjulState.selectedMonth;
      const arr = aarshjulState.tasksByMonth.get(m) || [];
      const idx = arr.findIndex(t => t.id === id);
      if (idx >= 0) arr.splice(idx, 1);
      aarshjulState.tasksByMonth.set(m, arr);
      renderAarshjulList();
      renderAarshjulSVG();
    }catch(err){
      alert("Kunne ikke slette posten.");
      console.error(err);
    }
    return; // vigtigt: stop her hvis det var en slet
  }

  // --- REDIG√âR ---
  const editBtn = e.target.closest(".btn-edit-task");
  if (editBtn){
    const id = editBtn.getAttribute("data-id");
    if (!id) return;

    const m   = aarshjulState.selectedMonth;
    const arr = aarshjulState.tasksByMonth.get(m) || [];
    const t   = arr.find(x => x.id === id);
    if (!t){ console.warn("Task ikke i state:", id); return; }

    // simple prompts (hurtig l√∏sning). Vi forfylder med eksisterende v√¶rdier.
    const nyTitle  = (prompt("Titel:", t.title ?? "") ?? "").trim();
    if (!nyTitle){ alert("Titel kan ikke v√¶re tom."); return; }
    const nyAnsvar = (prompt("Ansvar:", t.ansvar ?? "") ?? "").trim();
    const nyDesc   = (prompt("Beskrivelse:", t.desc ?? "") ?? "").trim();

    try{
      const updated = await updateTaskInSupabase(id, {
        title: nyTitle,
        ansvar: nyAnsvar,
        desc: nyDesc
      });

      // opdat√©r i state (mut√©r eksisterende obj for at undg√• at miste ref)
      t.title  = updated.title;
      t.ansvar = updated.ansvar;
      t.desc   = updated.desc;

      renderAarshjulList();
      renderAarshjulSVG(); // prikker √¶ndrer sig ikke her, men fint at holde i sync
    }catch(err){
      alert("Kunne ikke opdatere posten.");
      console.error(err);
    }
  }
});

	// ---- BIND √ÖRSHJUL-UI ----
	function bindAarshjulAddHandlers(){
  const btn  = document.getElementById("aarshjul-add-btn");
  const form = document.getElementById("aarshjul-add-form");
  const save = document.getElementById("aarshjul-add-save");

  // 1) Toggle formularen n√•r man klikker p√• "‚ûï Tilf√∏j post"
  if (btn && form){
    btn.addEventListener("click", () => {
      form.classList.toggle("skjult");
    });
  }

  // 2) Gem ny post (din eksisterende save-handler, blot sat ind her)
  if (save){
    save.addEventListener("click", async ()=>{
      const m = aarshjulState.selectedMonth;
      if (m==null){ alert("V√¶lg en m√•ned i hjulet f√∏rst."); return; }

      const title  = document.getElementById("aarshjul-add-title").value.trim();
      const desc   = document.getElementById("aarshjul-add-desc").value.trim();
      const ansvar = document.getElementById("aarshjul-add-ansvar").value.trim();
      if (!title){ alert("Skriv mindst en titel."); return; }

      try{
        const created = await addTaskToSupabase({
          aar: aarshjulState.selectedYear,
          maaned: m,
          title, desc, ansvar
        });

        // opdater state
        const map = aarshjulState.tasksByMonth;
        const arr = map.get(m) || [];
        arr.push(created);
        map.set(m, arr);

        // ryd UI + re-render
        document.getElementById("aarshjul-add-title").value = "";
        document.getElementById("aarshjul-add-desc").value = "";
        document.getElementById("aarshjul-add-ansvar").value = "";
        form.classList.add("skjult");

        renderAarshjulList();
		renderAarshjulSVG();
      }catch(e){
        alert("Kunne ikke gemme posten i √•rshjul.");
        console.error(e);
      }
    });
  }
}
	
	async function updateTaskInSupabase(id, patch){
  // patch kan fx v√¶re { title, desc, ansvar }
  const { data, error } = await client
    .from("aarshjul")
    .update(patch)
    .eq("id", id)
    .select("id, title, desc, ansvar, created_at")
    .single();
  if (error) throw error;
  return {
    id: data.id,
    title: data.title || "",
    desc: data.desc || "",
    ansvar: data.ansvar || "",
    createdAt: data.created_at
  };
}

	
	bindAarshjulAddHandlers();
    }
   
   // ---------- App init ----------
    document.addEventListener("DOMContentLoaded", ()=>{
      // Knap-bindings
      $("#btn-dok")?.addEventListener("click", ()=> visSektion("dokumenter"));
      $("#btn-stat")?.addEventListener("click", ()=> visSektion("statistik"));
      $("#btn-aarshjul")?.addEventListener("click", ()=> visSektion("aarshjul"));

      // Statistik-knapper
      $("#rolle-knap")?.addEventListener("click", visRolleStatistik);
    });

    // Login gate og side-setup
let __afterLoginHasRun = false;
window.__sektionChosen = false; // globalt flag

adgangskontrol({
  tilladteRoller:["bestyrelsesmedlem","admin"],
  redirectVedFejl:"index.html",
  efterLogin: async (bruger)=>{
    // undg√• dobbeltkald ved session-refresh
    if (__afterLoginHasRun) return;
    __afterLoginHasRun = true;

    if (window.releaseAuthGate) window.releaseAuthGate();
    inds√¶tMenu(bruger);
    await visMapper();

    // S√∏rg for at knapperne vises (uanset hvad)
    document.getElementById("sektion-knapper")?.classList.remove("skjult");

    // V√¶lg kun standard hvis ingen sektion er valgt
    if (!window.__sektionChosen) {
      visSektion("dokumenter");
    }
  }
});



    // Init √•rshjul f√∏rste gang sektionen v√¶lges
    let aarshjulInitDone = false;
    const _visSektion = visSektion;
    window.visSektion = async function(navn){
      _visSektion(navn);
      if(navn==="aarshjul" && !aarshjulInitDone){
        try{ await initAarshjul(); }catch(e){ console.error(e); }
        aarshjulInitDone = true;
      }
    };
  </script>

</body>
</html>
