<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestyrelsesdokumenter â€“ NKL</title>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="bestyrelse.css" /> 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<!-- HÃ¸jrekliksmenu - mapper -->
<ul id="context-menu" class="skjult">
  <li id="ny-mappe-valg">â• Opret ny mappe</li>
  <li id="slet-mappe-valg">ğŸ—‘ï¸ Slet mappe</li>
  <li id="omdoeb-mappe-valg">âœï¸ OmdÃ¸b mappe</li>
</ul>

<!-- HÃ¸jrekliksmenu - filer -->
<ul id="file-context-menu" class="skjult">
  <li id="slet-fil-valg">ğŸ—‘ï¸ Slet fil</li>
  <li id="omdoeb-fil-valg">âœï¸ OmdÃ¸b fil</li>
  <li id="download-fil-valg">â¬‡ï¸ Download</li>
</ul>

<!-- modal-preview-billeder -->
<div id="preview-modal" class="modal skjult">
  <div class="modal-indhold">
    <span id="luk-modal" class="luk" title="Luk">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
       viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" 
       stroke-linecap="round" stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18" />
    <line x1="6" y1="6" x2="18" y2="18" />
  </svg>
</span>
    <img id="preview-billede" src="" alt="Preview" />
    <div class="modal-knap-wrapper">
  <button id="download-knap" class="knap-vis">â¬‡ï¸ Download billede</button>
</div>
</div>
</div>

<!-- modal-preview-google-docs -->
<div id="gdocs-modal" class="modal skjult">
  <div class="modal-indhold">
    <span class="luk" onclick="lukGdocsModal()" title="Luk">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
           viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    </span>
    <iframe id="gdocs-frame"></iframe>
	<div class="modal-knap-wrapper">
  <button id="gdocs-download-knap" class="knap-vis">â¬‡ï¸ Download dokument</button>
</div>

</div>
</div>

<!-- modal-preview-excel-filer -->
<div id="excel-modal" class="modal skjult">
  <div class="modal-indhold" style="overflow: auto; max-height: 90vh;">
    <span class="luk" onclick="lukExcelModal()" title="Luk">
	<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
			viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
			stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg></span>
	<select id="arkvÃ¦lger" style="margin: 1rem 0; padding: 0.4rem;"></select>
    <div id="excel-output"></div>
  </div>
</div>

<h1>ğŸ“ Bestyrelsens dokumenter</h1>

<div id="bruger-navn" style="margin-bottom: 1rem;"></div>
<div id="dokument-sektioner"></div>


<script type="module">
  import { adgangskontrol, indsÃ¦tMenu, client } from './auth.js';

  adgangskontrol({
    tilladteRoller: ["bestyrelsesmedlem", "admin"],
    redirectVedFejl: "protected.html",
    efterLogin: (bruger) => {
      indsÃ¦tMenu(bruger);
      visMapper(bucketNavn);
    }
  });

  const bucketNavn = "bestyrelse";
  const mapper = ["referater", "dagsordener"];
  const dokumentSektioner = document.getElementById("dokument-sektioner");
 
  // Luk-funktion
  const modal = document.getElementById("preview-modal");
  const img = document.getElementById("preview-billede");
  const lukKnappen = document.getElementById("luk-modal");
  
  window.visModal = visModal;
  
function filtypeIkon(filnavn) {
  const ext = filnavn.toLowerCase().split('.').pop();

  switch (ext) {
    case "pdf": return "ğŸ“•";
    case "doc":
    case "docx": return "ğŸ“„";
    case "xls":
    case "xlsx": return "ğŸ“Š";
    case "ppt":
    case "pptx": return "ğŸ“½ï¸";
    case "jpg":
    case "jpeg":
    case "png":
    case "gif":
    case "webp": return "ğŸ–¼ï¸";
    case "zip":
    case "rar": return "ğŸ—œï¸";
    case "txt": return "ğŸ“ƒ";
    default: return "ğŸ“";
  }
}

function visModal(url, path) {
  // Skjul gdocs-modal, hvis den er Ã¥ben
  document.getElementById("gdocs-modal")?.classList.add("skjult");
  document.getElementById("gdocs-frame").src = "";

  const modal = document.getElementById("preview-modal");
  const img = document.getElementById("preview-billede");
  const downloadBtn = document.getElementById("download-knap");

  img.src = url;
  downloadBtn.onclick = () => tvungenDownload(path, path.split("/").pop());

  modal.classList.remove("skjult");
}

async function tvungenDownload(path, filnavn = "fil") {
  const { data, error } = await client.storage
    .from(bucketNavn)
    .download(path);

  if (error) {
    alert("âŒ Kunne ikke hente filen");
    console.error(error);
    return;
  }

  const url = URL.createObjectURL(data);
  const a = document.createElement("a");
  a.href = url;
  a.download = filnavn;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Luk ved klik udenfor billedet (baggrunden)
modal.addEventListener("click", (e) => {
  if (e.target === modal) {
    lukModal();
  }
});

// Luk med Escape-tast
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    document.getElementById("context-menu").classList.add("skjult");
    document.getElementById("file-context-menu").classList.add("skjult");
  }
});

// Hent mapper i bucket (bestyrelse)
async function hentMapper(bucket) {
  const { data, error } = await client.storage.from(bucket).list("", {
    limit: 100,
  });

  if (error) {
    console.error("âŒ Fejl ved hentning af mapper:", error);
    return [];
  }

  // Supabase returnerer mapper som items hvor metadata er null og de IKKE har en punktum-type (fil)
  return data.filter(item =>
    !item.name.includes('.') && item.metadata === null
  );
}

// Vis mapper i bucket (bestyrelse)
async function visMapper(bucket) {
  const container = document.getElementById("dokument-sektioner");
  container.innerHTML = "";

  const mapper = await hentMapper(bucket);

  for (const mappe of mapper) {
  const wrapper = document.createElement("div");
  wrapper.classList.add("mappe");

  const header = document.createElement("div");
  header.classList.add("mappe-header");
  header.innerHTML = `ğŸ“ ${mappe.name}`;

  // ğŸŸ¦ GÃ¸r topmapper til drop-zoner
header.ondragover = (e) => {
  e.preventDefault();
  header.classList.add("highlight");
};

header.ondragleave = () => {
  header.classList.remove("highlight");
};

header.ondrop = async (e) => {
  e.preventDefault();
  header.classList.remove("highlight");

  const destinationMappe = mappe.name; // eller mappe.name ved topniveau
  const filer = e.dataTransfer.files;

  if (filer && filer.length > 0) {
    for (const fil of filer) {
      let filnavn = fil.name;
const ugyldigeTegn = /[Ã¦Ã¸Ã¥Ã†Ã˜Ã…]/g;

if (ugyldigeTegn.test(filnavn)) {
  const forslag = filnavn
    .replace(/Ã¦/g, "ae").replace(/Ã¸/g, "oe").replace(/Ã¥/g, "aa")
    .replace(/Ã†/g, "Ae").replace(/Ã˜/g, "Oe").replace(/Ã…/g, "Aa");

  const godkendt = confirm(`âš ï¸ Filnavnet "${filnavn}" indeholder Ã¦, Ã¸ eller Ã¥.\nVil du omdÃ¸be det til "${forslag}" for at kunne uploade?`);
  if (!godkendt) {
    console.log("â›” Bruger afviste Ã¦ndring af filnavn");
    continue; // spring denne fil over
  }

  filnavn = forslag;
}

const uploadSti = `${destinationMappe}/${filnavn}`;
let { error } = await client.storage
  .from(bucketNavn)
  .upload(uploadSti, fil, { upsert: false });


if (error) {
  if (error.message.includes("already exists")) {
    const overskriv = confirm(`âš ï¸ Filen "${fil.name}" findes allerede i denne mappe.\nVil du overskrive den?`);
    if (overskriv) {
      ({ error } = await client.storage
        .from(bucketNavn)
        .upload(uploadSti, fil, { upsert: true }));

      if (error) {
        alert(`âŒ Kunne ikke overskrive filen: ${error.message}`);
        console.error(error);
      } else {
        console.log(`âœï¸ Filen "${fil.name}" blev overskrevet`);
      }
    } else {
      console.log(`â›” Bruger afviste overskrivning af "${fil.name}"`);
    }
  } else {
    alert(`âŒ Upload-fejl: ${error.message}`);
    console.error(error);
  }
}
 else {
        console.log(`âœ… Uploadet ${uploadSti}`);
      }
    }

    await visMapper(bucketNavn);
    aktivStiEfterHandling = destinationMappe;
    await Ã¥bnMappeEfterGenindlÃ¦sning(destinationMappe);
    return;
  }

  // fallback til flytning af fil
  const kildeSti = e.dataTransfer.getData("text/plain");
  const filNavn = kildeSti.split("/").pop();
  if (!filNavn.includes(".")) {
    alert("âŒ Du kan ikke flytte mapper.");
    return;
  }

  const nySti = `${destinationMappe}/${filNavn}`;
  if (kildeSti === nySti) return;

  const { error } = await client.storage.from(bucketNavn).move(kildeSti, nySti);
  if (error) {
    alert("âŒ Kunne ikke flytte filen");
    console.error(error);
  } else {
    alert(`âœ… Filen er flyttet til "${destinationMappe}"`);
  }

  await visMapper(bucketNavn);
  aktivStiEfterHandling = destinationMappe;
  await Ã¥bnMappeEfterGenindlÃ¦sning(destinationMappe);
};

  header.onclick = () => toggleMappe(mappe.name, wrapper);

  wrapper.appendChild(header);
  container.appendChild(wrapper);
}
}

// Toggle funktion til vores mapper
async function toggleMappe(sti, wrapperEl) {
  let indhold = wrapperEl.querySelector(".mappe-indhold");
  if (indhold) {
    indhold.remove();
    return;
  }

  const { data, error } = await client.storage.from(bucketNavn).list(sti, {
    limit: 100,
  });

  if (error) {
    console.error("âŒ Fejl ved hentning af filer i:", sti, error);
    return;
  }

  indhold = document.createElement("div");
  indhold.className = "mappe-indhold";

  for (const item of data) {
    const fuldSti = `${sti}/${item.name}`.replace(/\/+/g, "/");
	const skjulteFiler = [".emptyFolderPlaceholder", ".DS_Store", "thumbs.db"];
	
    if (!item.name || skjulteFiler.includes(item.name)) continue;

    if (item.metadata === null && !item.name.includes('.')) {
  // ğŸŸ¨ Undermappe
  const undermappeDiv = document.createElement("div");
  undermappeDiv.classList.add("mappe");

  const header = document.createElement("div");
  header.classList.add("mappe-header");
  header.innerHTML = `ğŸ“ ${item.name}`;

  // ğŸŸ¦ Drag-and-drop til mappe
header.ondragover = (e) => {
  e.preventDefault();
  header.classList.add("highlight");
};

header.ondragleave = () => {
  header.classList.remove("highlight");
};

header.ondrop = async (e) => {
  e.preventDefault();
  header.classList.remove("highlight");

  const destinationMappe = fuldSti; // eller mappe.name ved topniveau
  const filer = e.dataTransfer.files;

  if (filer && filer.length > 0) {
    for (const fil of filer) {
      let filnavn = fil.name;
const ugyldigeTegn = /[Ã¦Ã¸Ã¥Ã†Ã˜Ã…]/g;

if (ugyldigeTegn.test(filnavn)) {
  const forslag = filnavn
    .replace(/Ã¦/g, "ae").replace(/Ã¸/g, "oe").replace(/Ã¥/g, "aa")
    .replace(/Ã†/g, "Ae").replace(/Ã˜/g, "Oe").replace(/Ã…/g, "Aa");

  const godkendt = confirm(`âš ï¸ Filnavnet "${filnavn}" indeholder Ã¦, Ã¸ eller Ã¥.\nVil du omdÃ¸be det til "${forslag}" for at kunne uploade?`);
  if (!godkendt) {
    console.log("â›” Bruger afviste Ã¦ndring af filnavn");
    continue; // spring denne fil over
  }

  filnavn = forslag;
}

const uploadSti = `${destinationMappe}/${filnavn}`;
let { error } = await client.storage
  .from(bucketNavn)
  .upload(uploadSti, fil, { upsert: false });


if (error) {
  if (error.message.includes("already exists")) {
    const overskriv = confirm(`âš ï¸ Filen "${fil.name}" findes allerede i denne mappe.\nVil du overskrive den?`);
    if (overskriv) {
      ({ error } = await client.storage
        .from(bucketNavn)
        .upload(uploadSti, fil, { upsert: true }));

      if (error) {
        alert(`âŒ Kunne ikke overskrive filen: ${error.message}`);
        console.error(error);
      } else {
        console.log(`âœï¸ Filen "${fil.name}" blev overskrevet`);
      }
    } else {
      console.log(`â›” Bruger afviste overskrivning af "${fil.name}"`);
    }
  } else {
    alert(`âŒ Upload-fejl: ${error.message}`);
    console.error(error);
  }
} else {
        console.log(`âœ… Uploadet ${uploadSti}`);
      }
    }

    await visMapper(bucketNavn);
    aktivStiEfterHandling = destinationMappe;
    await Ã¥bnMappeEfterGenindlÃ¦sning(destinationMappe);
    return;
  }

  // fallback til flytning af fil
  const kildeSti = e.dataTransfer.getData("text/plain");
  const filNavn = kildeSti.split("/").pop();
  if (!filNavn.includes(".")) {
    alert("âŒ Du kan ikke flytte mapper.");
    return;
  }

  const nySti = `${destinationMappe}/${filNavn}`;
  if (kildeSti === nySti) return;

  const { error } = await client.storage.from(bucketNavn).move(kildeSti, nySti);
  if (error) {
    alert("âŒ Kunne ikke flytte filen");
    console.error(error);
  } else {
    alert(`âœ… Filen er flyttet til "${destinationMappe}"`);
  }

  await visMapper(bucketNavn);
  aktivStiEfterHandling = destinationMappe;
  await Ã¥bnMappeEfterGenindlÃ¦sning(destinationMappe);
};


  header.onclick = () => toggleMappe(fuldSti, undermappeDiv);

  undermappeDiv.appendChild(header);
  indhold.appendChild(undermappeDiv);
}
 else {
      // ğŸ“„ Almindelig fil
      const { data: signed } = await client.storage
        .from(bucketNavn)
        .createSignedUrl(fuldSti, 3600);

      const erBillede = item.name.match(/\.(jpg|jpeg|png|webp|gif)$/i);
const ikon = filtypeIkon(item.name);

const filWrapper = document.createElement("div");
filWrapper.className = "fil-linje";
filWrapper.style.display = "flex";
filWrapper.style.alignItems = "center";
filWrapper.style.justifyContent = "space-between";
filWrapper.style.gap = "0.5rem";
filWrapper.style.padding = "0.25rem 0";

// ğŸ¯ TilfÃ¸j hÃ¸jreklikmenu
filWrapper.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  hÃ¸jreklikFilsti = fuldSti;

  document.getElementById("context-menu").classList.add("skjult"); // luk mappemenu

  const menu = document.getElementById("file-context-menu");
  visMenuUdenforKant(menu, e.pageX, e.pageY);
  menu.classList.remove("skjult");

});

// ğŸŸ¦ GÃ¸r filen dragbar
if (item.metadata !== null || item.name.includes(".")) {
  filWrapper.setAttribute("draggable", "true");
  filWrapper.ondragstart = (e) => {
    e.dataTransfer.setData("text/plain", fuldSti);
  };
}


const filLabel = document.createElement("span");
filLabel.style.cursor = "pointer";
filLabel.textContent = `${ikon} ${item.name}`;

const erGoogleDocs = item.name.match(/\.(docx?|pdf|pptx?|txt)$/i);
const erExcel = item.name.match(/\.(xlsx?|csv|xlsm|xlsb)$/i);

if (erBillede) {
  filLabel.onclick = () => visModal(signed.signedUrl, fuldSti);
} else if (erExcel) {
  filLabel.onclick = () => visExcelModal(signed.signedUrl);
} else if (erGoogleDocs) {
  filLabel.onclick = () => visGdocsModal(signed.signedUrl, fuldSti);
} else {
  filLabel.onclick = () => window.open(signed?.signedUrl || "#", "_blank");
}

const menuKnap = document.createElement("button");
menuKnap.innerHTML = "â‹®";
menuKnap.title = "Flere handlinger";
menuKnap.className = "slet-knap";
menuKnap.onclick = (e) => {
  e.preventDefault();
  e.stopPropagation();
  hÃ¸jreklikFilsti = fuldSti;
  const menu = document.getElementById("file-context-menu");
  visMenuUdenforKant(menu, e.pageX, e.pageY);
  menu.classList.remove("skjult");
};


filWrapper.appendChild(filLabel);
filWrapper.appendChild(menuKnap);
indhold.appendChild(filWrapper);

    }
  }
  
  wrapperEl.appendChild(indhold);
  wrapperEl.classList.remove("aabner");  
}

// ğŸ”„ Hent alle mappestier rekursivt (helper)
async function hentAlleMapper(prefix = "", resultater = []) {
  const { data, error } = await client.storage.from(bucketNavn).list(prefix, { limit: 100 });

  if (error) return [];

  for (const item of data) {
    if (item.name.endsWith(".emptyFolderPlaceholder")) continue;
    if (item.name && item.id === null) { // mappe
      const sti = prefix ? `${prefix}/${item.name}` : item.name;
      resultater.push(sti);
      await hentAlleMapper(sti, resultater);
    }
  }
  return resultater;
}

window.visGdocsModal = function (signedUrl, filsti) {
  // Skjul billedmodal
  const billedModal = document.getElementById("preview-modal");
  if (billedModal) {
    billedModal.classList.add("skjult");
    billedModal.classList.remove("vis");
    document.getElementById("preview-billede").src = "";
  }

  // Vis tekstmodal
  const modal = document.getElementById("gdocs-modal");
  const iframe = document.getElementById("gdocs-frame");
  const downloadBtn = document.getElementById("gdocs-download-knap");

  // Ryd iframe
  iframe.src = "";

  // Vis modal fÃ¸rst
  modal.classList.remove("skjult");
  modal.classList.add("vis");

  // TilfÃ¸j iframe lidt forsinket
  const gviewUrl = `https://docs.google.com/gview?url=${encodeURIComponent(signedUrl)}&embedded=true`;
  setTimeout(() => {
    iframe.src = gviewUrl;
  }, 50);

  // Download-knap
  downloadBtn.onclick = () => tvungenDownload(filsti, filsti.split("/").pop());
};

// slet enkelte filer
window.sletFil = async function(bucket, sti) {
  if (!confirm(`Slet filen "${sti}"?`)) return;
  const { error } = await client.storage.from(bucket).remove([sti]);
  if (error) {
    alert("âŒ Fejl ved sletning af fil");
    console.error(error);
  } else {
    alert("ğŸ—‘ï¸ Fil slettet");
    await visMapper(bucketNavn);
  }
};

// Slet hele mappen plus indhold
window.sletMappe = async function(sti, knapEl) {
  if (!confirm(`Slet mappen "${sti}" og alt indhold?`)) return;

  // Hent alle filer i mappen rekursivt
  async function hentFiler(path, acc = []) {
    const { data } = await client.storage.from(bucketNavn).list(path, { limit: 100 });
    for (const item of data) {
      const fuldSti = `${path}/${item.name}`;
      if (item.metadata === null && !item.name.includes(".")) {
        await hentFiler(fuldSti, acc); // undermappe
      } else {
        acc.push(fuldSti);
      }
    }
    return acc;
  }

  const filerDerSkalSlettes = await hentFiler(sti);
  if (filerDerSkalSlettes.length === 0) {
    filerDerSkalSlettes.push(`${sti}/.emptyFolderPlaceholder`); // slet "tom" mappe
  }

  const { error } = await client.storage.from(bucketNavn).remove(filerDerSkalSlettes);
  if (error) {
    alert("âŒ Kunne ikke slette mappen");
    console.error(error);
  } else {
    alert(`ğŸ—‘ï¸ Mappen "${sti}" er slettet`);
    await visMapper(bucketNavn);
  }
};

window.lukGdocsModal = function () {
  const modal = document.getElementById("gdocs-modal");
  const iframe = document.getElementById("gdocs-frame");

  iframe.src = "";
  modal.classList.remove("vis");
  modal.classList.add("skjult");
};

window.visExcelModal = async function (signedUrl) {
  const res = await fetch(signedUrl);
  const blob = await res.blob();

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });

    const arkVÃ¦lger = document.getElementById("arkvÃ¦lger");
    arkVÃ¦lger.innerHTML = ""; // ryd tidligere indhold

    // TilfÃ¸j alle ark til dropdown
    workbook.SheetNames.forEach((navn, index) => {
      const option = document.createElement("option");
      option.value = navn;
      option.textContent = navn;
      if (index === 0) option.selected = true;
      arkVÃ¦lger.appendChild(option);
    });

    // Funktion til at vise valgt ark
    function visArk(navn) {
      const sheet = workbook.Sheets[navn];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: true });

      const html = XLSX.utils.sheet_to_html(sheet);

      document.getElementById("excel-output").innerHTML = html;
    }

    // Vis fÃ¸rste ark og hÃ¥ndtÃ©r Ã¦ndringer
    visArk(workbook.SheetNames[0]);
    arkVÃ¦lger.onchange = () => visArk(arkVÃ¦lger.value);

    document.getElementById("excel-modal").classList.remove("skjult");
  };

  reader.readAsArrayBuffer(blob);
};


window.lukExcelModal = function () {
  document.getElementById("excel-modal").classList.add("skjult");
  document.getElementById("excel-output").innerHTML = "";
};


function visMenuUdenforKant(menuEl, x, y) {
  menuEl.classList.remove("skjult"); // gÃ¸r den midlertidigt synlig

  const { innerWidth, innerHeight } = window;
  const offsetWidth = menuEl.offsetWidth || 160;
  const offsetHeight = menuEl.offsetHeight || 80;

  let left = x;
  let top = y;

  if (x + offsetWidth > innerWidth) {
    left = innerWidth - offsetWidth - 10;
  }

  if (y + offsetHeight > innerHeight) {
    top = innerHeight - offsetHeight - 10;
  }

  menuEl.style.left = `${left}px`;
  menuEl.style.top = `${top}px`;

}

function lukModal() {
  modal.classList.remove("vis");
  modal.classList.add("skjult");

  img.src = "";
}

// Luk pÃ¥ klik pÃ¥ kryds
lukKnappen.addEventListener("click", lukModal);

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !document.getElementById("gdocs-modal").classList.contains("skjult")) {
    lukGdocsModal();
  }
});

document.getElementById("gdocs-modal").addEventListener("click", (e) => {
  if (e.target.id === "gdocs-modal") {
    lukGdocsModal();
  }
});

let hÃ¸jreklikFilsti = "";
let hÃ¸jreklikSti = "";
let aktivStiEfterHandling = "";


  document.addEventListener("contextmenu", function(e) {
  const el = e.target.closest(".mappe-header");

  if (el) {
    e.preventDefault();

    const sti = hentStiFraElement(el);
    hÃ¸jreklikSti = sti;

    document.getElementById("file-context-menu").classList.add("skjult"); // luk filmenu

    const menu = document.getElementById("context-menu");
    visMenuUdenforKant(menu, e.pageX, e.pageY);
    menu.classList.remove("skjult");
  } else {
    lukContextMenu(); // luk hvis man hÃ¸jreklikker andetsteds
  }
});

document.addEventListener("click", () => {
  document.getElementById("context-menu").classList.add("skjult");
  document.getElementById("file-context-menu").classList.add("skjult");
});

function lukContextMenu() {
  const menu = document.getElementById("context-menu");
  menu.classList.add("skjult");
}

function hentStiFraElement(el) {
  const dele = [];
  let current = el;

  // GÃ¥ op gennem .mappe elementerne
  while (current && current.classList.contains("mappe-header")) {
    const mappeEl = current.closest(".mappe");
    const navn = current.textContent.trim().replace("ğŸ“", "").trim();
    if (navn) dele.unshift(navn);

    // GÃ¥ op til nÃ¦ste overordnede mappe
    const nÃ¦steMappe = mappeEl?.parentElement?.closest(".mappe");
    current = nÃ¦steMappe?.querySelector(".mappe-header") || null;

    // Sikkerhedsnet: Stop hvis vi kommer i loop
    if (dele.length > 10) break;
  }

  return dele.join("/");
}

// Opret ny mappe (hÃ¸jreklik)
document.getElementById("ny-mappe-valg").addEventListener("click", async () => {
  lukContextMenu();
  const navn = prompt(`Navn pÃ¥ ny mappe i "${hÃ¸jreklikSti}":`);
  if (!navn) return;

  const navnTrimmet = navn.trim();
  const ugyldigeTegn = /[^a-zA-Z0-9 _\-]/;

  if (ugyldigeTegn.test(navnTrimmet)) {
    alert("âŒ Mappenavnet mÃ¥ kun indeholde bogstaver (A-Z), tal, mellemrum, bindestreg og underscore.");
    return;
  }

  const sti = `${hÃ¸jreklikSti}/${navnTrimmet}`;
  const placeholderPath = `${sti}/.emptyFolderPlaceholder`;

  const { error } = await client.storage
    .from(bucketNavn)
    .upload(placeholderPath, new Blob([""]), { upsert: false });

  if (error) {
    alert("âŒ Kunne ikke oprette mappen: " + error.message);
    console.error(error);
  } else {
    alert(`âœ… Mappen "${sti}" er oprettet`);
    aktivStiEfterHandling = sti;
	await visMapper(bucketNavn);
	Ã¥bnMappeEfterGenindlÃ¦sning(aktivStiEfterHandling);
  }
});

// Slet en mappe (hÃ¸jreklik)
document.getElementById("slet-mappe-valg").addEventListener("click", async () => {
  lukContextMenu();
  if (!hÃ¸jreklikSti) return;

  const bekrÃ¦ft = confirm(`Vil du slette hele mappen "${hÃ¸jreklikSti}" og alt indhold?`);
  if (!bekrÃ¦ft) return;

  async function hentFiler(path, acc = []) {
    const { data } = await client.storage.from(bucketNavn).list(path, { limit: 100 });
    for (const item of data) {
      const fuldSti = `${path}/${item.name}`;
      if (item.metadata === null && !item.name.includes(".")) {
        await hentFiler(fuldSti, acc); // undermappe
      } else {
        acc.push(fuldSti);
      }
    }
    return acc;
  }

  const filerDerSkalSlettes = await hentFiler(hÃ¸jreklikSti);
  if (filerDerSkalSlettes.length === 0) {
    filerDerSkalSlettes.push(`${hÃ¸jreklikSti}/.emptyFolderPlaceholder`);
  }

  const { error } = await client.storage.from(bucketNavn).remove(filerDerSkalSlettes);
  if (error) {
    alert("âŒ Fejl ved sletning af mappen");
    console.error(error);
  } else {
    alert(`ğŸ—‘ï¸ Mappen "${hÃ¸jreklikSti}" er slettet`);
	aktivStiEfterHandling = hÃ¸jreklikSti;
    await visMapper(bucketNavn);
	Ã¥bnMappeEfterGenindlÃ¦sning(aktivStiEfterHandling);
  }
});

// OmdÃ¸b en mappe (hÃ¸jreklik)
document.getElementById("omdoeb-mappe-valg").addEventListener("click", async () => {
  lukContextMenu();
  if (!hÃ¸jreklikSti) return;

  let nytnavn = prompt(`OmdÃ¸b mappen "${hÃ¸jreklikSti}" til:`);
  if (!nytnavn) return;

  nytnavn = nytnavn.trim();
  const ugyldigeTegn = /[^a-zA-Z0-9 _\-]/;

  if (ugyldigeTegn.test(nytnavn)) {
    alert("âŒ Mappenavnet mÃ¥ kun indeholde bogstaver (A-Z), tal, mellemrum, bindestreg og underscore.");
    return;
  }

  const stiDele = hÃ¸jreklikSti.split("/");
  stiDele.pop();
  const nySti = [...stiDele, nytnavn].join("/");

  if (nySti === hÃ¸jreklikSti) return;

  async function hentFiler(path, acc = []) {
    const { data } = await client.storage.from(bucketNavn).list(path, { limit: 100 });
    for (const item of data) {
      const fuldSti = `${path}/${item.name}`;
      if (item.metadata === null && !item.name.includes(".")) {
        await hentFiler(fuldSti, acc);
      } else {
        acc.push(fuldSti);
      }
    }
    return acc;
  }

  const filer = await hentFiler(hÃ¸jreklikSti);
  if (filer.length === 0) {
    filer.push(`${hÃ¸jreklikSti}/.emptyFolderPlaceholder`);
  }

  for (const gammelSti of filer) {
    const relativDel = gammelSti.slice(hÃ¸jreklikSti.length + 1);
    const nyPath = `${nySti}/${relativDel}`;
    const { error } = await client.storage.from(bucketNavn).move(gammelSti, nyPath);
    if (error) {
      alert(`âŒ Kunne ikke flytte "${gammelSti}" â†’ "${nyPath}"`);
      console.error(error);
      return;
    }
  }

  alert(`âœï¸ Mappen er nu omdÃ¸bt til "${nySti}"`);
  aktivStiEfterHandling = nySti;
  await visMapper(bucketNavn);
  Ã¥bnMappeEfterGenindlÃ¦sning(aktivStiEfterHandling);
});

// Slet en fil (hÃ¸jreklik)
document.getElementById("slet-fil-valg").addEventListener("click", async () => {
  document.getElementById("file-context-menu").classList.add("skjult");

  if (!hÃ¸jreklikFilsti) return;

  const bekrÃ¦ft = confirm(`ğŸ—‘ï¸ Vil du slette filen:\n"${hÃ¸jreklikFilsti.split("/").pop()}"?`);
  if (!bekrÃ¦ft) return;

  const { error } = await client.storage.from(bucketNavn).remove([hÃ¸jreklikFilsti]);

  if (error) {
    alert("âŒ Der opstod en fejl ved sletning");
    console.error(error);
  } else {
    alert("ğŸ—‘ï¸ Filen blev slettet");
    const stiTilMappe = hÃ¸jreklikFilsti.split("/").slice(0, -1).join("/");
    aktivStiEfterHandling = stiTilMappe;
    await visMapper(bucketNavn);
    await Ã¥bnMappeEfterGenindlÃ¦sning(stiTilMappe);
  }

  hÃ¸jreklikFilsti = "";
});

// OmdÃ¸b en fil (hÃ¸jreklik)
document.getElementById("omdoeb-fil-valg").addEventListener("click", async () => {
  document.getElementById("file-context-menu").classList.add("skjult");

  if (!hÃ¸jreklikFilsti) return;

  const gammeltNavn = hÃ¸jreklikFilsti.split("/").pop();
  const stiTilMappe = hÃ¸jreklikFilsti.split("/").slice(0, -1).join("/");

  const nytNavn = prompt(`OmdÃ¸b filen "${gammeltNavn}" til:`, gammeltNavn);
  if (!nytNavn || nytNavn.trim() === "" || nytNavn === gammeltNavn) return;

  // Valider navn (samme som mapper â€“ du kan justere regex hvis du vil tillade .pdf fx)
  const ugyldigeTegn = /[^a-zA-Z0-9 _\-.]/;
  if (ugyldigeTegn.test(nytNavn)) {
    alert("âŒ Filnavnet mÃ¥ kun indeholde A-Z, 0-9, mellemrum, bindestreg, underscore og punktum.");
    return;
  }

  const nySti = `${stiTilMappe}/${nytNavn.trim()}`;

  const { error } = await client.storage.from(bucketNavn).move(hÃ¸jreklikFilsti, nySti);
  if (error) {
    alert("âŒ Kunne ikke omdÃ¸be filen");
    console.error(error);
  } else {
    alert(`âœï¸ Filen blev omdÃ¸bt til "${nytNavn.trim()}"`);
    aktivStiEfterHandling = stiTilMappe;
    await visMapper(bucketNavn);
    await Ã¥bnMappeEfterGenindlÃ¦sning(stiTilMappe);
  }

  hÃ¸jreklikFilsti = "";
});

// Download en fil (hÃ¸jreklik)
document.getElementById("download-fil-valg").addEventListener("click", async () => {
  document.getElementById("file-context-menu").classList.add("skjult");

  if (!hÃ¸jreklikFilsti) return;

  const filnavn = hÃ¸jreklikFilsti.split("/").pop();

  try {
    const { data, error } = await client.storage
      .from(bucketNavn)
      .download(hÃ¸jreklikFilsti);

    if (error || !data) {
      alert("âŒ Kunne ikke hente filen");
      console.error(error);
      return;
    }

    const url = URL.createObjectURL(data);
    const a = document.createElement("a");
    a.href = url;
    a.download = filnavn;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("âŒ Fejl ved download:", err);
    alert("âŒ Teknisk fejl under download.");
  }

  hÃ¸jreklikFilsti = "";
});


function vent(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function ventPÃ¥Element(findFn, maxTries = 20, interval = 100) {
  for (let i = 0; i < maxTries; i++) {
    const el = findFn();
    if (el) return el;
    await vent(interval);
  }
  return null;
}

async function Ã¥bnMappeEfterGenindlÃ¦sning(sti) {
  if (!sti) return;
  const dele = sti.split("/");

  let aktuel = document;
  let stiAkkumuleret = "";

  for (let i = 0; i < dele.length; i++) {
    const delnavn = dele[i];
    stiAkkumuleret = stiAkkumuleret ? `${stiAkkumuleret}/${delnavn}` : delnavn;

    // Vent til elementet findes i DOM'en
    const match = await ventPÃ¥Element(() =>
      Array.from(aktuel.querySelectorAll(".mappe-header"))
        .find(el => el.textContent.trim().includes(delnavn))
    );

    if (match) {
      match.click(); // fold ud
      aktuel = match.parentElement;
      await vent(100); // vent lidt sÃ¥ nÃ¦ste niveau kan indlÃ¦ses
    } else {
      break;
    }
  }

  // Highlight sidste mappe
  const sidsteNavn = dele[dele.length - 1];
  const sidsteMatch = Array.from(document.querySelectorAll(".mappe-header"))
    .find(el => el.textContent.trim().includes(sidsteNavn));
  if (sidsteMatch) {
    sidsteMatch.classList.add("highlight");
    setTimeout(() => {
      sidsteMatch.classList.remove("highlight");
    }, 2000);
  }

  aktivStiEfterHandling = "";
}

</script>


</body>
</html>
