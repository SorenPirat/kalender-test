<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì® Beskeder ‚Äì NKL</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
</head>
<body>

<div id="app" class="beskeder-app">
  <!-- Sidebar med tr√•de -->
  <aside id="tr√•d-liste" class="tr√•d-liste">
    <h2>üí¨ Samtaler</h2>
    <input type="text" id="tr√•d-s√∏g" placeholder="üîç S√∏g..." />
    <div id="tr√•de-container"></div>
  </aside>

  <!-- Aktiv tr√•d -->
  <main id="aktiv-tr√•d" class="aktiv-tr√•d">
    <div id="aktiv-header" class="tr√•d-header">
	  <button id="tilbage-knap" class="tilbage-knap" aria-label="Tilbage">‚Üê</button>
	  <span id="aktiv-navn"></span>
    </div>

    <div id="beskeder-container" class="beskeder-container"></div>

    <form id="svar-form" class="svar-form skjult">
      <textarea id="besked-input" placeholder="Skriv en besked..."></textarea>  	  
	  <button type="submit">üì§</button>
	  
	  <div class="emoji-wrap">
		<button type="button" id="emoji-btn" class="emoji-btn" aria-label="V√¶lg emoji">üòä</button>
		<emoji-picker id="emoji-picker" class="skjult" skin-tone-emoji="üëç"></emoji-picker>
		</div>
	  
    </form>
  </main>
</div>


<script type="module">
  import { adgangskontrol, inds√¶tMenu, client } from './auth.js';

  const BASE_URL = "https://nglevagter-test.onrender.com";

  // ==== STATE ====
  let bruger = null;
  let brugerId = null;
  let alleTr√•de = [];
  let aktivTr√•dId = null;
  let navnOpslag = {};  // userId -> navn (cache)
  let notifThreads = new Set();

  // ==== DOM ====
  const tr√•deContainer = document.getElementById("tr√•de-container");
  const tr√•dS√∏g = document.getElementById("tr√•d-s√∏g");
  const aktivKolonne = document.getElementById("aktiv-tr√•d");
  const aktivHeaderTitel = document.getElementById("aktiv-navn");
  const beskederContainer = document.getElementById("beskeder-container");
  const svarForm = document.getElementById("svar-form");
  const beskedInput = document.getElementById("besked-input");
  const traadListeEl = document.querySelector(".tr√•d-liste");
  const tilbageKnap = document.getElementById("tilbage-knap");
  const emojiBtn = document.getElementById('emoji-btn');
  const emojiPicker = document.getElementById('emoji-picker');

  // ==== INIT ====
  adgangskontrol({
    tilladteRoller: [],
    redirectVedFejl: "index.html",
    efterLogin: async (b) => {
	  if (window.releaseAuthGate) window.releaseAuthGate();
      bruger = b;
      brugerId = b.id;
      inds√¶tMenu(b);

      await preloadNavne();
	  await hentNotifikationer();
      await hentTr√•de();

      bindUI();
      autoOpenFromQuery();
      startRealtime();
    }
  });

  async function preloadNavne() {
    const { data, error } = await client
      .from("users")
      .select("id, navn");
    if (!error && data) {
      navnOpslag = Object.fromEntries(data.map(u => [u.id, u.navn]));
    }
  }

  async function hentNotifikationer() {
  const { data, error } = await client
    .from("kontakt_notifications")
    .select("thread_id")
    .eq("bruger_id", brugerId);

  if (!error && Array.isArray(data)) {
    notifThreads = new Set(data.map(r => r.thread_id));
  }
}

  async function hentTr√•de() {
    const res = await fetch(`${BASE_URL}/threads?brugerId=${encodeURIComponent(brugerId)}`);
    const data = await res.json();
    alleTr√•de = Array.isArray(data) ? data : [];

    // berig med navne + simple ‚Äúanden part‚Äù
    for (const t of alleTr√•de) {
      t.oprettet_af_navn = navnOpslag[t.oprettet_af] || t.oprettet_af;
      // "andenPartId" = hvis du er afsender, er modtageren den anden ‚Äî ellers omvendt
      const anden = (t.oprettet_af === brugerId) ? t.modtager : t.oprettet_af;
      t.anden_part_id = anden;
      t.anden_part_navn = navnOpslag[anden] || anden;
	  t.har_notif = notifThreads.has(t.id);
    }

    renderTr√•dListe();
  }

  function bindUI() {
    tr√•dS√∏g.addEventListener("input", () => renderTr√•dListe());
    svarForm.addEventListener("submit", onSend);
	
		if (tilbageKnap) {
		tilbageKnap.addEventListener("click", goBackToList);
		}
  }

  function renderTr√•dListe() {
    const q = tr√•dS√∏g.value.trim().toLowerCase();
    tr√•deContainer.innerHTML = "";

    // sort√©r som Messenger: senest opdaterede √∏verst
    const sorterede = [...alleTr√•de].sort((a, b) => {
      const da = new Date(a.opdateret || a.created_at).getTime();
      const db = new Date(b.opdateret || b.created_at).getTime();
      return db - da;
    });

    const filtrerede = sorterede.filter(t => {
      if (!q) return true;
      return (
        (t.titel && t.titel.toLowerCase().includes(q)) ||
        (t.anden_part_navn && t.anden_part_navn.toLowerCase().includes(q))
      );
    });

    for (const t of filtrerede) {
      const el = document.createElement("div");
      el.className = "tr√•d-preview" + (t.id === aktivTr√•dId ? " aktiv" : "");
      const dato = formaterDatoKort(t.opdateret || t.created_at);
	  const harNotifikation = notifThreads.has(t.id) && t.id !== aktivTr√•dId;


el.innerHTML = `
  <div class="tr√•d-header">
    <div style="font-weight:bold">
      ${harNotifikation ? '<span class="bell" aria-hidden="true">üîî</span>' : ''}
      ${escapeHtml(t.anden_part_navn || "Samtale")}
    </div>
    <div class="tr√•d-info">${dato}</div>
  </div>
  <div class="teaser">${escapeHtml(t.titel || "")}</div>
`;

      el.addEventListener("click", () => √•bnTr√•d(t.id));
      tr√•deContainer.appendChild(el);
    }
  }

  async function √•bnTr√•d(tr√•dId) {
    aktivTr√•dId = tr√•dId;
    markAktivIListen();

    const tr√•d = alleTr√•de.find(t => t.id === tr√•dId);
    if (!tr√•d) return;

    // Header + show h√∏jre kolonne
    aktivHeaderTitel.textContent = tr√•d.anden_part_navn || "Samtale";
    aktivKolonne.classList.add("vis"); // mobil: vis h√∏jreside
	
	if (window.matchMedia("(max-width: 800px)").matches) {
	traadListeEl?.classList.add("skjul");
	}
	
    svarForm.classList.toggle("skjult", !!tr√•d.er_lukket);

    // hent beskeder
    await hentOgVisBeskeder(tr√•dId);

    // mark√©r som l√¶st i backend
    markAsRead(tr√•dId);

    // scroll til bund
    scrollTilBund();
  }

  function markAktivIListen() {
    [...tr√•deContainer.children].forEach((node, idx) => {
      const id = (alleTr√•de[idx] || {}).id;
      if (!id) return;
      if (id === aktivTr√•dId) node.classList.add("aktiv");
      else node.classList.remove("aktiv");
    });
  }

  async function hentOgVisBeskeder(tr√•dId) {
    beskederContainer.innerHTML = "";

    const { data: beskeder, error } = await client
      .from("messages")
      .select("*")
      .eq("thread_id", tr√•dId)
      .order("tidspunkt", { ascending: true });

    if (error) {
      beskederContainer.innerHTML = `<p>‚ùå Kunne ikke hente beskeder</p>`;
      return;
    }

    for (const b of beskeder) {
      appendBesked(b);
    }
  }

  function appendBesked(b) {
    const div = document.createElement("div");
    const erMig = b.afsender === brugerId;
    div.className = "besked " + (erMig ? "afsender" : "modtager");
    const navn = navnOpslag[b.afsender] || (erMig ? "Mig" : "Ukendt");
    const tekst = b.tekst ? escapeHtml(b.tekst) : "";

    // Tilf√∏j evt. lyd/billede senere
    div.innerHTML = `
      <div style="font-weight:600; margin-bottom:2px;">${escapeHtml(navn)}</div>
      <div>${tekst}</div>
    `;

    beskederContainer.appendChild(div);
  }

  async function onSend(e) {
    e.preventDefault();
    if (!aktivTr√•dId) return;

    const tekst = beskedInput.value.trim();
    if (!tekst) return;

    const body = { thread_id: aktivTr√•dId, afsender: brugerId, tekst };
    try {
      const res = await fetch(`${BASE_URL}/reply`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Fejl ved afsendelse");

      beskedInput.value = "";

      bumpTr√•d(aktivTr√•dId);
      scrollTilBund();

      // mark√©r som l√¶st for mig (fjerner evt. üîî hos mig)
      await markAsRead(aktivTr√•dId);
    } catch (err) {
      console.error(err);
      alert("‚ùå Kunne ikke sende besked");
    }
  }

  function bumpTr√•d(tr√•dId) {
    const idx = alleTr√•de.findIndex(t => t.id === tr√•dId);
    if (idx >= 0) {
      alleTr√•de[idx].opdateret = new Date().toISOString();
      // flyt √∏verst i liste igen ved n√¶ste render
      notifThreads.delete(tr√•dId);
	  renderTr√•dListe();
      markAktivIListen();
    }
  }

  function scrollTilBund() {
    requestAnimationFrame(() => {
      beskederContainer.scrollTop = beskederContainer.scrollHeight;
    });
  }

  async function markAsRead(tr√•dId) {
    try {
      await fetch(`${BASE_URL}/mark-thread-read`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ thread_id: tr√•dId, bruger_id: brugerId })
      });
    } catch (_) {}
  }

  function autoOpenFromQuery() {
    const p = new URLSearchParams(location.search);
    const tid = p.get("tr√•d");
    if (tid) {
      // hvis tr√•den ikke er i listen endnu, hentes den med n√¶ste polling/realtime
      // pr√∏v at √•bne ‚Äì og ellers falder det bare til jorden uden fejl
      √•bnTr√•d(tid);
    }
  }

  function goBackToList() {
  // kun relevant p√• mobil ‚Äì men g√∏r ikke skade p√• desktop
  aktivKolonne.classList.remove("vis");
  traadListeEl?.classList.remove("skjul");
  // bevar aktivTr√•dId hvis du vil markere den i listen; ellers nulstil:
  // aktivTr√•dId = null;
}

emojiBtn?.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  togglePicker(); // √•bn/luk
});

// inds√¶t valgt emoji ved cursor
emojiPicker?.addEventListener('emoji-click', (ev) => {
  const emoji = ev.detail.unicode;
  insertAtCursor(beskedInput, emoji);
  togglePicker(false);
  beskedInput.focus();
});

// klik udenfor ‚Üí luk
document.addEventListener('click', (e) => {
  if (!emojiPicker || emojiPicker.classList.contains('skjult')) return;
  const wrap = document.querySelector('.emoji-wrap');
  if (!wrap?.contains(e.target)) togglePicker(false);
});

// Escape ‚Üí luk
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') togglePicker(false);
});

// ved submit ‚Üí luk
document.getElementById('svar-form')?.addEventListener('submit', () => togglePicker(false));


  // ==== REALTIME ====
  function startRealtime() {
    // 1) Lyt efter nye beskeder (opdater aktiv tr√•d eller bump i listen)
    client.channel('messages-rt')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        const m = payload.new;
        // hvis det er min aktive tr√•d ‚Üí append
        if (m.thread_id === aktivTr√•dId) {
          appendBesked(m);
          bumpTr√•d(m.thread_id);
          scrollTilBund();
        } else {
          // ellers bump listen (hvis jeg er part i tr√•den)
          const t = alleTr√•de.find(t => t.id === m.thread_id);
          if (t) {
            bumpTr√•d(t.id);
          } else {
            // fallback: hent tr√•de igen (ny tr√•d dukket op / √¶ndret ejerskab)
            hentTr√•de();
          }
        }
      })
      .subscribe();

    // 2) Lyt efter √¶ndringer i threads (luk/gen√•bn mv.)
    client.channel('threads-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'threads' }, payload => {
        const t = payload.new || payload.old;
        if (!t) return;
        // Hvis √¶ndring vedr√∏rer mig ‚Üí opdat√©r
        if (t.oprettet_af === brugerId || t.modtager === brugerId) {
          hentTr√•de();
        }
      })
      .subscribe();
	  
	  client.channel('kontakt-notifs-rt')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'kontakt_notifications' }, payload => {
    const r = payload.new;
    if (r?.bruger_id === brugerId) {
      notifThreads.add(r.thread_id);
      // opdater flag p√• den konkrete tr√•d hvis den allerede er i listen
      const t = alleTr√•de.find(t => t.id === r.thread_id);
      if (t) t.har_notif = true;
      renderTr√•dListe();
    }
  })
  .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'kontakt_notifications' }, payload => {
    const r = payload.old;
    if (r?.bruger_id === brugerId) {
      notifThreads.delete(r.thread_id);
      const t = alleTr√•de.find(t => t.id === r.thread_id);
      if (t) t.har_notif = false;
      renderTr√•dListe();
    }
  })
  .subscribe();

  }

  // ==== HELPERS ====
  
  function togglePicker(show) {
  if (show === true) emojiPicker.classList.remove('skjult');
  else if (show === false) emojiPicker.classList.add('skjult');
  else emojiPicker.classList.toggle('skjult');
}
  
  function formaterDatoKort(iso) {
    try {
      const d = new Date(iso);
      const nu = new Date();
      const sameDay = d.toDateString() === nu.toDateString();
      if (sameDay) {
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      return d.toLocaleDateString();
    } catch {
      return "";
    }
  }

  function insertAtCursor(input, text) {
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  const before = input.value.slice(0, start);
  const after  = input.value.slice(end);
  input.value = before + text + after;
  const pos = start + text.length;
  input.setSelectionRange(pos, pos);
  input.focus();
}

  function escapeHtml(str) {
    return (str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

</script>


</body>
</html>
