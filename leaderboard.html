<!DOCTYPE html>
<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üèÜ Log Wall ‚Äì NKL</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <link rel="stylesheet" href="css/animation.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.2/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>


</head>
<body>

  <h1>üèÜ Log Wall</h1>

  <section class="kort" style="max-width:900px;">
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
      <label>
        <select id="periode">
			<option value="total">I alt</option>
			<option value="boulder">Bouldere</option>
			<option value="route">Ruter</option>
        </select>
      </label>
    </div>

    <div id="status" style="margin-top:.75rem;"></div>

    <div style="overflow:auto; margin-top:1rem;">
      <table id="lb-tabel" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">#</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Navn</th>
            <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Ruter/problemer</th>
          </tr>
        </thead>
        <tbody id="lb-body">
          <tr><td colspan="3" style="padding:.75rem;">Indl√¶ser‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<script type="module">
  import { client, adgangskontrol, inds√¶tMenu } from './auth.js';

  adgangskontrol({
    tilladteRoller: [],
    redirectVedFejl: "index.html",
    efterLogin: async (bruger) => {
      if (window.releaseAuthGate) window.releaseAuthGate();
      inds√¶tMenu(bruger);
      await visLeaderboard();
    }
  });

  const statusEl  = document.getElementById('status');
  const tbody     = document.getElementById('lb-body');
  const periodeEl = document.getElementById('periode');

  periodeEl.addEventListener('change', () => {
    visLeaderboard();
  });

  function afgr√¶nsDato(v) {
    if (v === 'all') return null;
    const d = new Date(); d.setDate(d.getDate() - parseInt(v,10)); return d;
  }

	// Hvilke billede_id-kategorier er bouldere?
	const BOULDER_IDS = ["sektor-a","sektor-b","sektor-c","sektor-d"];
	const isBoulderCat = (id) => BOULDER_IDS.includes((id||"").toLowerCase());

	// Eksponentielle basepoints ud fra grad (4=5 pts, 6a=15, 7c=244)
	const GRAD_ORDER = ["4","5a","5b","5c","6a","6a+","6b","6b+","6c","6c+","7a","7a+","7b","7b+","7c"];
	function basePointsForGrad(grad){
  const k = GRAD_ORDER.indexOf((grad||"").toLowerCase());
  if (k < 0) return 0;
  return Math.round(5 * Math.pow(1.32, k));
}
	// Fors√∏gs-multiplikatorer (bouldere og ruter)
	function attemptMultiplier(fors√∏g, isBoulder){
  const v = (fors√∏g||"").toLowerCase();
  if (isBoulder){
    if (v==="flash") return 1.25;
    if (v==="2 fors√∏g") return 1.12;
    if (v==="3 fors√∏g") return 1.06;
    if (v==="+5 fors√∏g") return 0.85;
    return 1.00;
  } else {
    if (v==="onsight")  return 1.25; // svarer til flash
    if (v==="redpoint") return 1.12;
    if (v==="toprope")  return 0.85;
    return 1.00;
  }
}
	// Beregn point for en enkelt log
	function calcPoints(grad, billede_id, fors√∏g) {
  const isBoulder = isBoulderCat(billede_id);
  const base = basePointsForGrad(grad);
  const mult = attemptMultiplier(fors√∏g, isBoulder);
  return Math.round(base * mult);
}

function setLeaderboardHeader(view) {
  const theadRow = document.querySelector('#lb-tabel thead tr');
  if (!theadRow) return;
  if (view === 'boulder') {
    theadRow.innerHTML = `
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">#</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Navn</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Bouldere</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Points</th>
    `;
  } else if (view === 'route') {
    theadRow.innerHTML = `
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">#</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Navn</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Ruter</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Points</th>
    `;
  } else {
    theadRow.innerHTML = `
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">#</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Navn</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">I alt</th>
      <th style="text-align:left; padding:.5rem; border-bottom:1px solid #ccc;">Points</th>
    `;
  }
}


  // N√∏gle til at gemme forrige rank i localStorage pr. periode
  function prevRankKey(userId, period) {
    return `lbPrevRank:${period}:user:${userId}`;
  }

  // NYT: ‚ÄúSchool Pride‚Äù preset ‚Äì to sidebl√¶sere i skolens farver
  function schoolPrideConfetti(c1 = '#0047AB', c2 = '#F0C300', ms = 1500) {
    const end = Date.now() + ms;
    const colors = [c1, c2];

    (function frame() {
      confetti({ particleCount: 3, angle: 60,  spread: 55, origin: { x: 0 },   colors });
      confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 },   colors });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

async function visLeaderboard() {
  const view = periodeEl.value; // "total" | "boulder" | "route"
  setLeaderboardHeader(view);   // üëà s√∏rger for korrekt kolonne-overskrifter

  statusEl.textContent = "‚è≥ Henter data...";
  tbody.innerHTML = `<tr><td colspan="4" style="padding:.75rem;">Indl√¶ser‚Ä¶</td></tr>`;

  // 1) Hent logs med det vi skal bruge
  const { data: logs, error: logErr } = await client
    .from('rutelog')
    .select('user_id, rute_id, fors√∏g, earned_points');

  if (logErr) { console.error(logErr); statusEl.textContent = "‚ùå Kunne ikke hente rutelog."; return; }
  if (!logs?.length) { statusEl.textContent = ""; tbody.innerHTML = `<tr><td colspan="4" style="padding:.75rem;">Ingen logs endnu.</td></tr>`; return; }

  // 2) Hent rute-data til de ruter der indg√•r
  const ruteIds = [...new Set(logs.map(l => l.rute_id).filter(Boolean))];
  const { data: ruter, error: ruteErr } = await client
    .from('ruter')
    .select('id, grad, billede_id')
    .in('id', ruteIds);
  if (ruteErr) { console.error(ruteErr); statusEl.textContent = "‚ùå Kunne ikke hente rutedata."; return; }
  const ruteMap = new Map((ruter || []).map(r => [r.id, r]));

  // 3) Aggreger pr. bruger (antal + point), respekter view-filteret
  const agg = new Map(); // user_id -> { bCnt,bPts,rCnt,rPts }
  for (const l of logs) {
    const r = ruteMap.get(l.rute_id);
    if (!r) continue;

    const isBoulder = isBoulderCat(r.billede_id);
    if (view === 'boulder' && !isBoulder) continue;
    if (view === 'route'   &&  isBoulder) continue;

    const calculated = Math.max(1, Math.round(
      (Number.isFinite(l.earned_points) ? l.earned_points : null) ?? 
      calcPoints(r.grad, r.billede_id, l.fors√∏g)
    ));

    const cur = agg.get(l.user_id) || { bCnt:0, bPts:0, rCnt:0, rPts:0 };
    if (isBoulder) { cur.bCnt += 1; cur.bPts += calculated; }
    else           { cur.rCnt += 1; cur.rPts += calculated; }
    agg.set(l.user_id, cur);
  }

  if (agg.size === 0) {
    statusEl.textContent = "";
    tbody.innerHTML = `<tr><td colspan="4" style="padding:.75rem;">Ingen logs i dette view.</td></tr>`;
    return;
  }

  // 4) Hent brugernavne (og filtrer deltagere)
  const ids = [...agg.keys()];
  const { data: users, error: userErr } = await client
    .from('users')
    .select('id, navn, leaderboard_deltagelse')
    .in('id', ids);
  if (userErr) { console.error(userErr); statusEl.textContent = "‚ùå Kunne ikke hente brugere."; return; }

  const rows = [];
  for (const u of (users || [])) {
    if (u.leaderboard_deltagelse === false) continue;
    const a = agg.get(u.id);
    if (!a) continue;

    const cnt = (view === 'boulder') ? a.bCnt : (view === 'route') ? a.rCnt : (a.bCnt + a.rCnt);
    const pts = (view === 'boulder') ? a.bPts : (view === 'route') ? a.rPts : (a.bPts + a.rPts);
    rows.push({ id: u.id, navn: u.navn || `Medlem ${u.id.slice(0,6)}`, cnt, pts });
  }

  // 5) Sort√©r: point -> antal -> navn
  rows.sort((A, B) => (B.pts - A.pts) || (B.cnt - A.cnt) || A.navn.localeCompare(B.navn));

  // 6) Render r√¶kker med 4 kolonner (#, Navn, Antal, Point)
  statusEl.textContent = "";
  tbody.innerHTML = "";
  const frag = document.createDocumentFragment();
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-user-id', r.id);
    const medalje = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
    tr.innerHTML = `
      <td style="padding:.5rem; border-bottom:1px solid #eee;">${i + 1}</td>
      <td style="padding:.5rem; border-bottom:1px solid #eee;">${medalje} ${r.navn}</td>
      <td style="padding:.5rem; border-bottom:1px solid #eee;">${r.cnt}</td>
      <td style="padding:.5rem; border-bottom:1px solid #eee;">${r.pts}</td>
    `;
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  // (valgfrit) mark√©r egen r√¶kke
  const my = JSON.parse(localStorage.getItem('bruger') || '{}')?.id;
  if (my) {
    const myRow = tbody.querySelector(`tr[data-user-id="${my}"]`);
    if (myRow) myRow.classList.add('min-raekke');
  }
}

</script>

</body>
</html>
