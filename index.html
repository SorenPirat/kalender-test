<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>üß™ N√∏gleb√¶rer Kalender (TEST)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    td.name { cursor: pointer; }
    button.toggle { background: none; border: none; font-size: 1rem; font-weight: bold; padding: 0.5rem 0; cursor: pointer; width: 100%; text-align: left; }
    .month-block { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 1rem; padding: 0.5rem; }
    .month-content { display: none; }
    .month-content.active { display: block; }
    .past { color: #aaa; background-color: #f9f9f9; }
    .today { background-color: #e0f0ff !important; border-left: 4px solid #3399ff; }
    .spinner {
  border: 6px solid #eee;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 2rem auto;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  #test-banner {
    background-color: #ffcc00;
    color: black;
    font-weight: bold;
    padding: 10px;
    text-align: center;
    border-bottom: 2px solid #999;
    font-size: 1.2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  </style>
</head>
<body>
  <div id="test-banner">üß™ TESTVERSION ‚Äì √Ündringer her p√•virker IKKE den rigtige kalender</div>
  <h2>N√∏gleb√¶rer-kalender: Juni‚ÄìDecember 2025</h2>
  <div id="loading">‚è≥ Henter data fra server...</div>
  <div id="calendar"></div>
  <script>
  const API_URL = 'https://nglevagter-test.onrender.com';
  const months = ['januar', 'februar', 'marts', 'april', 'maj', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'december'];
  const weekdays = ['s√∏n', 'man', 'tirs', 'ons', 'tors', 'fre', 'l√∏r'];
  const year = 2025;
  const startMonth = 5;
  const currentMonth = new Date().getMonth();
  const calendarContainer = document.getElementById('calendar');

  async function fetchAssignments() {
    const res = await fetch(`${API_URL}/assignments`);
    return await res.json();
  }

  async function updateAssignment(key, value) {
    await fetch(`${API_URL}/assignments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ day: key, name: value })
    });
  }

  function getGlobalKey(month, day) {
    return `${month + 1}-${day}`;
  }

  async function renderMonth(month) {
    const assignments = await fetchAssignments();
    const block = document.createElement('div');
    block.className = 'month-block';

    const toggle = document.createElement('button');
    toggle.className = 'toggle';
    toggle.textContent = months[month].charAt(0).toUpperCase() + months[month].slice(1);
    block.appendChild(toggle);

    const content = document.createElement('div');
    content.className = 'month-content';
    if (month === currentMonth) content.classList.add('active');

    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Dato</th><th>N√∏gleb√¶rer</th><th>Handling</th></tr>';

    const daysInMonth = new Date(year, month + 1, 0).getDate();

for (let day = 1; day <= daysInMonth; day++) {
  const key = getGlobalKey(month, day);
  const entry = assignments[key] || "";

  const dateObj = new Date(year, month, day);
  dateObj.setHours(0, 0, 0, 0); // Nulstil tidspunkt direkte
  const weekday = weekdays[dateObj.getDay()];

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const limitDate = new Date(today);
  limitDate.setDate(today.getDate() - 3);

  if (dateObj < limitDate) continue;

  let dayClass = '';
  if (dateObj < today) {
    dayClass = 'past';
  } else if (dateObj.getTime() === today.getTime()) {
    dayClass = 'today';
  }

      const tr = document.createElement('tr');
      if (dayClass) tr.classList.add(dayClass);
      const tdDate = document.createElement('td');
      tdDate.textContent = `${weekday} d. ${day}. ${months[month]}`;

      const tdName = document.createElement('td');
      const tdActions = document.createElement('td');

      if (entry.startsWith("closed")) {
  const reason = entry.includes("::") ? entry.split("::")[1].trim() : "";
  tdName.textContent = "üîí LUKKET" + (reason ? ` ‚Äì ${reason}` : "");
  tdName.style.color = "#888";

  const reopenBtn = document.createElement("button");
  reopenBtn.textContent = "√Öbn dag";
  reopenBtn.onclick = () => reopenDate(key);
  tdActions.appendChild(reopenBtn);
} else {
  tdName.textContent = entry || "Klik for at tilf√∏je";
  tdName.className = 'name';
  tdName.style.cursor = 'pointer';
  tdName.onclick = async () => {
    const newName = prompt(`N√∏gleb√¶rer for ${day}. ${months[month]}:`, entry || '');
    if (newName !== null) {
      await updateAssignment(key, newName.trim());
      location.reload();
    }
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "üóëÔ∏è";
  deleteBtn.onclick = async () => {
    if (confirm('Vil du slette n√∏gleb√¶rer for denne dag?')) {
      await updateAssignment(key, "");
      location.reload();
    }
  };

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "Luk dag";
  closeBtn.onclick = async () => {
    const reason = prompt("Hvorfor er dagen lukket? (valgfrit)");
    if (reason !== null) {
      await updateAssignment(key, "closed::" + reason.trim());
      location.reload();
    }
  };

  tdActions.appendChild(deleteBtn);
  tdActions.appendChild(closeBtn);
}

      tr.appendChild(tdDate);
      tr.appendChild(tdName);
      tr.appendChild(tdActions);
      table.appendChild(tr);
    }

    content.appendChild(table);
    block.appendChild(content);
    toggle.addEventListener('click', () => content.classList.toggle('active'));
    calendarContainer.appendChild(block);
  }

  function reopenDate(key) {
    if (confirm("Vil du √•bne denne lukkede dag?")) {
      updateAssignment(key, "").then(() => location.reload());
    }
  }

  async function renderCalendar() {
  const loading = document.getElementById("loading");
  const calendar = document.getElementById("calendar");

  try {
    for (let m = startMonth; m <= 11; m++) {
      await renderMonth(m);
    }
    loading.style.display = "none";
  } catch (err) {
    console.error("‚ùå Fejl under hentning af data:", err);
    loading.textContent = "‚ùå Kunne ikke hente kalenderdata. Pr√∏v at opdatere siden.";
  }
}

  renderCalendar();
</script>
</body>
</html>
