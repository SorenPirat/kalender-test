<!DOCTYPE html>
<html lang="da">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 0.5rem;
    background-color: #f9f9f9;
    max-width: 100%;
    overflow-x: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  th, td {
    padding: 0.4rem;
    font-size: 0.95rem;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  .month-block {
  margin-bottom: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  overflow: hidden;
  }

  .toggle {
  position: sticky;
  top: 0;
  z-index: 1;
  background-color: #007bff;
  color: white;
  padding: 0.6rem;
  font-size: 1.1rem;
  text-align: left;
  border: none;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
  }

  .toggle:hover {
  background-color: #0056b3;
  }

  .month-content {
  display: none;
  }

  .month-content.active {
  display: block;
  }


  .name {
    color: #007bff;
    font-weight: bold;
  }

  #test-banner {
    background-color: #ffe08a;
    color: #333;
    font-weight: bold;
    text-align: center;
    padding: 0.5rem;
    font-size: 0.95rem;
  }

  @media screen and (max-width: 600px) {
    table, thead, tbody, th, td, tr {
      display: block;
      width: 100%;
    }

    tr {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      padding: 0.5rem;
      border-radius: 6px;
      background-color: white;
    }

    td {
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
    }

    td::before {
      content: attr(data-label);
      font-weight: bold;
      margin-right: 1rem;
    }

    th {
      display: none;
    }
  }
</style>
</head>
<body>
  <div id="test-banner">üß™ TESTVERSION ‚Äì √Ündringer her p√•virker IKKE den rigtige kalender</div>
  <h2>N√∏gleb√¶rer-kalender: Juni‚ÄìDecember 2025</h2>
  <div id="loading">‚è≥ Henter data fra server...</div>
  <div id="calendar"></div>
  <script>
  const API_URL = 'https://nglevagter-test.onrender.com';
  const months = ['januar', 'februar', 'marts', 'april', 'maj', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'december'];
  const weekdays = ['s√∏n', 'man', 'tirs', 'ons', 'tors', 'fre', 'l√∏r'];
  const year = 2025;
  const startMonth = 5;
  const currentMonth = new Date().getMonth();
  const calendarContainer = document.getElementById('calendar');

  async function fetchAssignments() {
    const res = await fetch(`${API_URL}/assignments-with-events`);
    return await res.json();
  }

  async function updateAssignment(key, value) {
    await fetch(`${API_URL}/assignments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ day: key, name: value })
    });
  }

  function getGlobalKey(month, day) {
    return `${month + 1}-${day}`;
  }

  async function renderMonth(month) {
    const assignments = await fetchAssignments();
    const block = document.createElement('div');
    block.className = 'month-block';

    const toggle = document.createElement('button');
    toggle.className = 'toggle';
    toggle.textContent = months[month].charAt(0).toUpperCase() + months[month].slice(1);
    block.appendChild(toggle);

    const content = document.createElement('div');
    content.className = 'month-content';
    if (month === currentMonth) content.classList.add('active');

    toggle.addEventListener('click', () => {
    const isActive = content.classList.contains('active');
    document.querySelectorAll('.month-content').forEach(mc => mc.classList.remove('active'));
    if (!isActive) {
    content.classList.add('active');
    }
  });

    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Dato</th><th>N√∏gleb√¶rer</th><th>Begivenheder</th><th>Handling</th></tr>';

    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let day = 1; day <= daysInMonth; day++) {
      const key = getGlobalKey(month, day);
      const entryData = assignments[key] || {};
      const entry = entryData.name || "";
      const eventList = entryData.events || [];

      const dateObj = new Date(year, month, day);
      dateObj.setHours(0, 0, 0, 0);
      const weekday = weekdays[dateObj.getDay()];

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const limitDate = new Date(today);
      limitDate.setDate(today.getDate() - 3);
      if (dateObj < limitDate) continue;

      let dayClass = '';
      if (dateObj < today) dayClass = 'past';
      else if (dateObj.getTime() === today.getTime()) dayClass = 'today';

      const tr = document.createElement('tr');
      if (dayClass) tr.classList.add(dayClass);

      const tdDate = document.createElement('td');
      tdDate.textContent = `${weekday} d. ${day}. ${months[month]}`;
      tdDate.setAttribute('data-label', 'Dato');

      const tdName = document.createElement('td');
      tdName.setAttribute('data-label', 'N√∏gleb√¶rer');

      const tdEvents = document.createElement('td');
      tdEvents.setAttribute('data-label', 'Begivenheder');

      const tdActions = document.createElement('td');
      tdActions.setAttribute('data-label', 'Handling');

      tdEvents.textContent = eventList.length > 0 ? `üìÖ ${eventList.join(', ')}` : '‚Äì';

      if (entry.startsWith("closed")) {
        const reason = entry.includes("::") ? entry.split("::")[1].trim() : "";
        tdName.textContent = "üîí LUKKET" + (reason ? ` ‚Äì ${reason}` : "");
        tdName.style.color = "#888";

        const reopenBtn = document.createElement("button");
        reopenBtn.textContent = "√Öbn dag";
        reopenBtn.onclick = () => reopenDate(key);
        tdActions.appendChild(reopenBtn);
      } else {
        tdName.textContent = entry || "Klik for at tilf√∏je";
        tdName.className = 'name';
        tdName.style.cursor = 'pointer';
        tdName.onclick = async () => {
          const newName = prompt(`N√∏gleb√¶rer for ${day}. ${months[month]}:`, entry || '');
          if (newName !== null) {
            await updateAssignment(key, newName.trim());
            location.reload();
          }
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è";
        deleteBtn.onclick = async () => {
          if (confirm('Vil du slette n√∏gleb√¶rer for denne dag?')) {
            await updateAssignment(key, "");
            location.reload();
          }
        };

        const closeBtn = document.createElement("button");
        closeBtn.textContent = "Luk dag";
        closeBtn.onclick = async () => {
          const reason = prompt("Hvorfor er dagen lukket? (valgfrit)");
          if (reason !== null) {
            await updateAssignment(key, "closed::" + reason.trim());
            location.reload();
          }
        };

        tdActions.appendChild(deleteBtn);
        tdActions.appendChild(closeBtn);
      }

      tr.appendChild(tdDate);
      tr.appendChild(tdName);
      tr.appendChild(tdEvents);
      tr.appendChild(tdActions);
      table.appendChild(tr);
    }

    content.appendChild(table);
    block.appendChild(content);
    calendarContainer.appendChild(block);
    }

  function reopenDate(key) {
    if (confirm("Vil du √•bne denne lukkede dag?")) {
      updateAssignment(key, "").then(() => location.reload());
    }
  }

  async function renderCalendar() {
  const loading = document.getElementById("loading");
  const calendar = document.getElementById("calendar");

  try {
    for (let m = startMonth; m <= 11; m++) {
      await renderMonth(m);
    }
    loading.style.display = "none";

    const activeMonth = document.querySelector('.month-content.active');
    if (activeMonth) {
      activeMonth.parentElement.scrollIntoView({ behavior: 'smooth' });
    }
  } catch (err) {
    console.error("‚ùå Fejl under hentning af data:", err);
    loading.textContent = "‚ùå Kunne ikke hente kalenderdata. Pr√∏v at opdatere siden.";
  }
}

  renderCalendar();
</script>
</body>
</html>
