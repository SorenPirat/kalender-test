<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Min logbog ‚Äì NKL</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <link rel="stylesheet" href="css/minelog.css" /> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
</head>
<body>
  <h2>üìò Min logbog</h2>
  
  <div id="logListe"></div>
  
  <div style="max-width: 100%; padding: 1rem;">
  <canvas id="gradChart"></canvas>
  </div>
  
  <div id="gradDetaljer" class="skjul" style="max-width: 700px; margin: 2rem auto;"></div>
    
  <div id="rute-modal" class="rute-modal skjul">
  <div class="rute-modal-indhold">
    <span class="luk" onclick="lukRuteModal()">‚ùå</span>
    <h3 id="modalTitel">üßó Rutevisning</h3>
	
	<canvas id="ruteCanvas"></canvas>
  </div>
  </div>



  <script type="module">
    import { client, adgangskontrol, inds√¶tMenu, hentPublicUrlMedCache } from './auth.js';

    adgangskontrol({
      tilladteRoller: [],
      redirectVedFejl: "protected.html",
      efterLogin: async (bruger) => {
        inds√¶tMenu(bruger);
        await hentLogbog(bruger.id);
      }
    });
	
	let alleLogs = [];
	let modalCanvas;
	let canvas = document.getElementById("ruteCanvas");
	let ctx = canvas.getContext("2d");
	let img = null;
	let startTid = 0;
	let pulsAnimationId = 0;
	let sidsteFrameTid = 0;
	const √∏nsketFPS = 30;
	const frameInterval = 1000 / √∏nsketFPS;


// helpers
const gradR√¶kkef√∏lge = ["4","5a","5b","5c","6a","6a+","6b","6b+","6c","6c+","7a","7a+","7b","7b+","7c"];
function basePointsForGrad(g){ 
const k = gradR√¶kkef√∏lge.indexOf((g||"").toLowerCase()); return k<0?0:Math.round(5*Math.pow(1.32,k)); }
function tryMultiplier(v){
  v = (v||"").toLowerCase();
  if (v==="flash") return 1.25;
  if (v==="2 fors√∏g") return 1.12;
  if (v==="3 fors√∏g") return 1.06;
  if (v==="+5 fors√∏g") return 0.85;
  return 1.00;
}

async function hentLogbog(user_id) {
const { data, error } = await client
  .from("rutelog")
  .select(`
    id,
    logget_dato,
    kommentar,
    fors√∏g,
    bed√∏mmelse,
	egen_grad,
	earned_points,
    ruter (
      id,
      navn,
      farve,
      greb,
      grad,
      billede_id,
      billedenavn
    )
  `)
  .eq("user_id", user_id)
  .order("logget_dato", { ascending: false });


  const logListe = document.getElementById("logListe");
  if (!logListe) {
    console.warn("Elementet #logListe findes ikke i DOM'en.");
    return;
  }

  if (error) {
    logListe.textContent = "‚ùå Kunne ikke hente din logbog.";
    return;
  }

  if (!data || data.length === 0) {
    logListe.innerHTML = `<p>Du har ingen loggede ruter endnu.</p>`;
    return;
  }

  alleLogs = data;

  // Lav t√¶lling af grader
  const gradT√¶lling = {};
  data.forEach(log => {
    const grad = log.ruter.grad?.trim() || "Ukendt";
    gradT√¶lling[grad] = (gradT√¶lling[grad] || 0) + 1;
  });

  // Tegn graf med Chart.js
  const labels = Object.keys(gradT√¶lling).sort();
  const dataSet = labels.map(label => gradT√¶lling[label]);

  const ctxChart = document.getElementById("gradChart").getContext("2d");
  new Chart(ctxChart, {
    type: "polarArea",
    data: {
      labels: labels,
      datasets: [{
        label: "Loggede ruter pr. grad",
        data: dataSet,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "right" },
        title: {
          display: true,
          text: "üìä Loggede ruter pr. grad"
        }
      },
      scales: {
        r: {
          ticks: {
            callback: value => Number.isInteger(value) ? value : "",
            stepSize: 1,
            precision: 0
          },
          suggestedMin: 0
        }
      },
      onClick: (evt, elements) => {
        if (elements.length > 0) {
          const chart = elements[0].element.$context.chart;
          const index = elements[0].index;
          const valgtGrad = chart.data.labels[index];
          visGradDetaljer(valgtGrad);
        }
      }
    }
  });
}

function hentMinGradering(log) {
  // Prim√¶rt: brug kolonnen egen_grad
  if (log.egen_grad && log.egen_grad.trim()) return log.egen_grad.trim();
}

async function visGradDetaljer(grad) {
  const container = document.getElementById("gradDetaljer");
  container.innerHTML = `<h3>üßó Ruter i grad: ${grad}</h3>`;

  const filtreret = alleLogs.filter(log => (log.ruter.grad?.trim() || "Ukendt") === grad);

  for (const log of filtreret) {
    const div = document.createElement("div");
    div.className = "logpost";
    const rute = log.ruter;
    const dato = new Date(log.logget_dato).toLocaleDateString("da-DK");

    div.innerHTML = `
      <strong>${rute.navn || "(uden navn)"}</strong><br/>
      üóìÔ∏è ${dato}<br/>
      üîÅ ${log.fors√∏g || "-"}<br/>
      üí¨ ${log.kommentar || ""}<br/>
      üî¢ Rutens grad: ${rute.grad || "Ukendt"}<br/>
      üéØ Min vurdering: ${log.egen_grad || "-"}<br/>
      ‚≠ê Din rating: ${"‚≠ê".repeat(log.bed√∏mmelse)}<br/>
    `;

    // üéØ Vis rute-knap
    const visKnap = document.createElement("button");
    visKnap.className = "knap-vis";
    visKnap.innerHTML = "üéØ Vis rute";
    visKnap.onclick = async () => {
      const kopi = { ...rute };
      const sti = rute.billedenavn;
      const publicUrl = hentPublicUrlMedCache(sti, "ruter");
      if (!publicUrl) return alert("‚ùå Kunne ikke hente billede.");
      kopi.billede_url = publicUrl;
      visRute(kopi);
    };

    // üóëÔ∏è Slet log-knap
    const sletKnap = document.createElement("button");
    sletKnap.className = "knap-slet";
    sletKnap.innerHTML = "üóëÔ∏è Slet log";
    sletKnap.onclick = async () => {
      if (!confirm("Er du sikker p√•, at du vil slette denne log?")) return;
      const { error } = await client.from("rutelog").delete().eq("id", log.id);
      if (error) {
        alert("‚ùå Kunne ikke slette log.");
        console.error(error);
      } else {
        alert("‚úÖ Log slettet.");
        // Fjern fra array og DOM
        alleLogs = alleLogs.filter(l => l.id !== log.id);
        div.remove();
      }
    };

    div.appendChild(visKnap);
    div.appendChild(sletKnap);
    container.appendChild(div);
  }

  container.classList.remove("skjul");
}


function hexOrNamedToRgba(color, alpha) {
  const dummy = document.createElement("div");
  dummy.style.color = color;
  document.body.appendChild(dummy);
  const computed = getComputedStyle(dummy).color;
  document.body.removeChild(dummy);
  const rgb = computed.match(/\d+/g);
  if (!rgb) return `rgba(255, 0, 255, ${alpha})`; // fallback pink
  return `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${alpha})`;
}

function tegnGl√∏d(polygon, farve = "white", puls = 1) {
  if (!polygon?.points || polygon.points.length < 3) return;

  const maxGlow = 6;
  for (let i = maxGlow; i > 0; i--) {
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(polygon.points[0].x, polygon.points[0].y);
    for (let j = 1; j < polygon.points.length; j++) {
      ctx.lineTo(polygon.points[j].x, polygon.points[j].y);
    }
    ctx.closePath();

    ctx.strokeStyle = farve;
    ctx.globalAlpha = (i / maxGlow) * 0.15 * puls;
    ctx.lineWidth = i * 2;
    ctx.shadowColor = farve;
    ctx.shadowBlur = i * 4 * puls;
    ctx.stroke();
    ctx.restore();
  }
}

function tegnGreb(p, farve = "magenta") {
  if (!p.points || p.points.length < 3) return;

  const fyldFarve = hexOrNamedToRgba(farve, 0.2);
  const kantFarve = hexOrNamedToRgba(farve, 1.0);
  const skyggeFarve = hexOrNamedToRgba("black", 0.25);

  ctx.save();

  // Skygge
  ctx.beginPath();
  ctx.moveTo(p.points[0].x + 1, p.points[0].y + 1);
  for (let i = 1; i < p.points.length; i++) {
    ctx.lineTo(p.points[i].x + 1, p.points[i].y + 1);
  }
  ctx.closePath();
  ctx.fillStyle = skyggeFarve;
  ctx.fill();

  // Fyld
  ctx.beginPath();
  ctx.moveTo(p.points[0].x, p.points[0].y);
  for (let i = 1; i < p.points.length; i++) {
    ctx.lineTo(p.points[i].x, p.points[i].y);
  }
  ctx.closePath();
  ctx.fillStyle = fyldFarve;
  ctx.fill();

  // Kant
  ctx.strokeStyle = kantFarve;
  ctx.lineWidth = 0.1;
  ctx.stroke();

  ctx.restore();
}

function visRute(rute) {
  const modal = document.getElementById("rute-modal");
  modal.classList.remove("skjul");

  if (pulsAnimationId) cancelAnimationFrame(pulsAnimationId);

  const startTid = performance.now();
  sidsteFrameTid = 0;
  img = new Image();
  img.onload = () => {
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;

function tegnScene() {
  const nu = performance.now();

  // Hvis modal er lukket, stop animation
  if (document.getElementById("rute-modal").classList.contains("skjul")) {
    cancelAnimationFrame(pulsAnimationId);
    return;
  }

  // Skip frame hvis ikke tid endnu
  if (nu - sidsteFrameTid < frameInterval) {
    pulsAnimationId = requestAnimationFrame(tegnScene);
    return;
  }

  sidsteFrameTid = nu;

  const delta = (nu - startTid) / 1000;
  const pulsStyrke = Math.sin(delta * 2 * Math.PI) * 0.5 + 0.5;

  // Baggrund
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0);

  // M√∏rkl√¶g
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Klip polygoner ud
  ctx.save();
  ctx.globalCompositeOperation = "destination-out";
  rute.greb.forEach(p => {
    if (p.points?.length >= 3) {
      ctx.beginPath();
      ctx.moveTo(p.points[0].x, p.points[0].y);
      for (let i = 1; i < p.points.length; i++) {
        ctx.lineTo(p.points[i].x, p.points[i].y);
      }
      ctx.closePath();
      ctx.fill();
    }
  });
  ctx.restore();

  ctx.globalCompositeOperation = "source-over";

  // Gl√∏d
  rute.greb.forEach(p => tegnGl√∏d(p, "white", pulsStyrke));

  // Farve
  rute.greb.forEach(p => tegnGreb(p, rute.farve || "cyan"));

  // N√¶ste frame
  pulsAnimationId = requestAnimationFrame(tegnScene);
}



    tegnScene();
  };
  img.src = rute.billede_url;
}

window.lukRuteModal = function () {
  if (pulsAnimationId) cancelAnimationFrame(pulsAnimationId);
  document.getElementById("rute-modal").classList.add("skjul");
};


  </script>
</body>
</html>
