<html lang="da">
<head>
  <script src="gate.js"></script>
  <meta charset="UTF-8">
  <title>Kontaktperson – NKL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <script type="module">
    import { adgangskontrol, indsætMenu, client } from './auth.js';

    let alleBrugere = [];
	let valgtModtager = null;
	
    adgangskontrol({
      tilladteRoller: [],
      redirectVedFejl: "index.html",
      efterLogin: async (bruger) => {
	    if (window.releaseAuthGate) window.releaseAuthGate();
        indsætMenu(bruger);
		await hentBrugere();
      }
    });

async function hentBrugere() {
      const { data, error } = await client
        .from("users")
        .select("id, navn, rolle");

      if (error) {
        console.error("Fejl ved hentning af brugere:", error);
        return;
      }

      alleBrugere = data;
    }

function visResultater() {
  const søgning = document.getElementById("søgefelt").value.toLowerCase().trim();
  const valgtRolle = document.getElementById("rollefilter").value;
  const liste = document.getElementById("resultatliste");

  // Hvis intet er skrevet og ingen rolle valgt → vis intet
  if (!søgning && !valgtRolle) {
    liste.innerHTML = ""; // blank side
    return;
  }

  liste.innerHTML = ""; // ryd først

  alleBrugere
    .filter((bruger) => {
      const navnMatch = bruger.navn.toLowerCase().includes(søgning);
      const roller = Array.isArray(bruger.rolle) ? bruger.rolle : [bruger.rolle];
      const rolleMatch = !valgtRolle || roller.includes(valgtRolle);
      return navnMatch && rolleMatch;
    })
    .forEach((bruger) => {
      const div = document.createElement("div");
      div.className = "kontaktkort";
      const rolleTekst = Array.isArray(bruger.rolle) ? bruger.rolle.join(", ") : bruger.rolle;
      div.innerHTML = `<strong>${bruger.navn}</strong><br/><small>${rolleTekst}</small>`;
      div.addEventListener("click", () => visModal(bruger));
      liste.appendChild(div);
    });
}


function visModal(bruger) {
  valgtModtager = bruger;
  document.getElementById("modtager-navn").textContent = bruger.navn;
  document.getElementById("beskedtitel").value = "";
  document.getElementById("beskedtekst").value = "";
  document.getElementById("send-status").textContent = "";

  document.getElementById("besked-modal").classList.remove("skjult");
}

function lukModal() {
  document.getElementById("besked-modal").classList.add("skjult");
}

async function sendBesked() {
  const titel = document.getElementById("beskedtitel").value.trim();
  const tekst = document.getElementById("beskedtekst").value.trim();
  const status = document.getElementById("send-status");

  if (!titel || !tekst) {
    status.textContent = "❗ Udfyld både emne og besked.";
    return;
  }

  const afsender = JSON.parse(localStorage.getItem("bruger"));
  const body = {
    afsender: afsender.id,
    modtager: valgtModtager.id,
    titel,
    tekst
  };

  status.textContent = "⏳ Sender besked...";
	
	console.log("🔍 Sender body til /kontakt:", body);

  try {
    const res = await fetch("https://nglevagter-test.onrender.com/kontakt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      throw new Error("Fejl ved afsendelse");
    }

    status.textContent = "✅ Besked sendt! Omdirigerer...";

	const resultat = await res.json();
	const threadId = resultat.thread_id;

	// Send brugeren til beskeder.html med threadId som query
	window.location.href = `beskeder.html?tråd=${threadId}`;

  } catch (err) {
    console.error(err);
    status.textContent = "❌ Der opstod en fejl.";
  }
}

window.visResultater = visResultater;
window.visModal = visModal;
window.lukModal = lukModal;
window.sendBesked = sendBesked;

 </script>

</head>
<body>

  <div class="kontakt-container" style="max-width: 600px; margin: auto; padding: 1rem;">
  
    <h1>📬 Send besked til medlem</h1>
	<div class="kort">
    <input id="søgefelt" class="søgefelt" type="text" placeholder="🔍 Søg efter navn..." oninput="visResultater()" />
    <select id="rollefilter" class="rollefilter" onchange="visResultater()">
      <option value="">📌 Filtrér efter rolle</option>
	  <option value="klubmedlem">Klubmedlem</option>
      <option value="bestyrelsesmedlem">Bestyrelsesmedlem</option>
	  <option value="rutebygger">Rutebygger</option>
      <option value="nøglebærer">Nøglebærer</option>
      <option value="eventmaker">Eventmaker</option>
      <option value="admin">Admin</option>
    </select>
</div>
    <div id="resultatliste"></div>
</div>

<div id="besked-modal" class="modal skjult">
  <div class="modal-box">
    <h2>📬 Skriv besked</h2>

    <p><strong>Til:</strong> <span id="modtager-navn"></span></p>

    <label for="beskedtitel">Emne / titel:</label>
    <input type="text" id="beskedtitel" class="felt" placeholder="F.eks. spørgsmål om nøgle" />

    <label for="beskedtekst">Din besked:</label>
    <textarea id="beskedtekst" class="felt" rows="4" placeholder="Skriv din besked her..."></textarea>

    <div class="tool-actions">
      <button class="knap" onclick="sendBesked()">📤 Send</button>
      <button class="knap sekundær" onclick="lukModal()">Annuller</button>
    </div>

    <p id="send-status" style="margin-top: 0.75rem;"></p>
  </div>
</div>




</body>
</html>
